
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Platform paper social experiment analysis: Part 1 &#8212; Aeon  documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/custom.css?v=9651da53" />
  
  <!-- So that users can add custom icons -->
  <script src="../../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'user/how_to/social_analysis1_static';</script>
    <script src="../../_static/js/workflow.js?v=1800024c"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Platform paper social experiment analysis: Part 2" href="social_analysis2.html" />
    <link rel="prev" title="Data access using the low-level API" href="io_api_example_copy.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>
<aside class="bd-header-announcement" aria-label="Announcement">
  <div class="bd-header-announcement__content">This website is currently under active development. Please report any issues on <a href='https://github.com/SainsburyWellcomeCentre/aeon_docs/issues'>GitHub</a>.</div>
</aside>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
  
  
    <p class="title logo__title">Aeon </p>
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../getting_started/index.html">
    Getting Started
  </a>
</li>


<li class="nav-item current active">
  <a class="nav-link nav-internal" href="../index.html">
    User Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../contributor/index.html">
    Contributor’s Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../reference/index.html">
    Reference
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../about/index.html">
    About
  </a>
</li>

  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
        </div>
      
      
        <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/SainsburyWellcomeCentre/aeon_docs" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
    </div>
  

  
    <button class="pst-navbar-icon sidebar-toggle secondary-toggle" aria-label="On this page">
      <span class="fa-solid fa-outdent"></span>
    </button>
  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../getting_started/index.html">
    Getting Started
  </a>
</li>


<li class="nav-item current active">
  <a class="nav-link nav-internal" href="../index.html">
    User Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../contributor/index.html">
    Contributor’s Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../reference/index.html">
    Reference
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../about/index.html">
    About
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/SainsburyWellcomeCentre/aeon_docs" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
<nav class="bd-docs-nav bd-links"
     aria-label="Section Navigation">
  <p class="bd-links__title" role="heading" aria-level="1">Section Navigation</p>
  <div class="bd-toc-item navbar-nav"><ul class="current nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../aeon_modules.html">Aeon Modules</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../aeon_modules/hardware.html">Hardware Assembly</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../aeon_modules/hardware/commutation_translation.html">Commutation-Translation System</a></li>
<li class="toctree-l3"><a class="reference internal" href="../aeon_modules/hardware/foraging_patch.html">Foraging Patch</a></li>
<li class="toctree-l3"><a class="reference internal" href="../aeon_modules/hardware/habitat.html">Habitat</a></li>
<li class="toctree-l3"><a class="reference internal" href="../aeon_modules/hardware/nest.html">Nest</a></li>
<li class="toctree-l3"><a class="reference internal" href="../aeon_modules/connections/camera.html">Camera Wiring Schematic</a></li>
<li class="toctree-l3"><a class="reference internal" href="../aeon_modules/connections/camera_controller.html">Camera Controller Wiring Schematic</a></li>
<li class="toctree-l3"><a class="reference internal" href="../aeon_modules/connections/commutation_translation_system.html">Commutation-Translation System Wiring Schematic</a></li>
<li class="toctree-l3"><a class="reference internal" href="../aeon_modules/connections/foraging_patch.html">Foraging Patch Wiring Schematic</a></li>
<li class="toctree-l3"><a class="reference internal" href="../aeon_modules/connections/foraging_patch_output_expander.html">Foraging Patch Output Expander Wiring Schematic</a></li>
<li class="toctree-l3"><a class="reference internal" href="../aeon_modules/connections/microphone.html">Microphone Wiring Schematic</a></li>
<li class="toctree-l3"><a class="reference internal" href="../aeon_modules/connections/rfid_reader.html">RFID Reader Wiring Schematic</a></li>
<li class="toctree-l3"><a class="reference internal" href="../aeon_modules/connections/sound_card.html">Sound Card Wiring Schematic</a></li>
<li class="toctree-l3"><a class="reference internal" href="../aeon_modules/connections/timestamp_generator.html">Timestamp Generator Wiring Schematic</a></li>
<li class="toctree-l3"><a class="reference internal" href="../aeon_modules/connections/weighing_scale.html">Weighing Scale Wiring Schematic</a></li>
</ul>
</details></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../aeon_modules/acquisition.html">Acquisition Modules</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../aeon_modules/acquisition/activity_tracking.html">Activity Tracking</a></li>
<li class="toctree-l3"><a class="reference internal" href="../aeon_modules/acquisition/alerts.html">Alerts</a></li>
<li class="toctree-l3"><a class="reference internal" href="../aeon_modules/acquisition/camera.html">Spinnaker Camera</a></li>
<li class="toctree-l3"><a class="reference internal" href="../aeon_modules/acquisition/camera_controller.html">Multi-Camera Controller</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../aeon_modules/acquisition/control_panel.html">Control Panel</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l4"><a class="reference internal" href="../aeon_modules/acquisition/control_panel/annotation_source_GUI.html">AnnotationSource</a></li>
<li class="toctree-l4"><a class="reference internal" href="../aeon_modules/acquisition/control_panel/button_source_GUI.html">ButtonSource</a></li>
<li class="toctree-l4"><a class="reference internal" href="../aeon_modules/acquisition/control_panel/environment_state_GUI.html">EnvironmentState</a></li>
<li class="toctree-l4"><a class="reference internal" href="../aeon_modules/acquisition/control_panel/experiment_properties_GUI.html">ExperimentProperties</a></li>
<li class="toctree-l4"><a class="reference internal" href="../aeon_modules/acquisition/control_panel/label_control_GUI.html">LabelControl</a></li>
<li class="toctree-l4"><a class="reference internal" href="../aeon_modules/acquisition/control_panel/subject_database.html">SubjectDatabase <!--TODO: Placeholder content--></a></li>
</ul>
</details></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../aeon_modules/acquisition/foraging_patch.html">Foraging Patch</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l4"><a class="reference internal" href="../aeon_modules/acquisition/foraging_patch/patch_dispenser.html">PatchDispenser</a></li>
<li class="toctree-l4"><a class="reference internal" href="../aeon_modules/acquisition/foraging_patch/pellet_monitor.html">PelletMonitor</a></li>
<li class="toctree-l4"><a class="reference internal" href="../aeon_modules/acquisition/foraging_patch/time_since_last_event.html">TimeSinceLastEvent</a></li>
<li class="toctree-l4"><a class="reference internal" href="../aeon_modules/acquisition/foraging_patch/time_spent_on_wheel.html">TimeSpentOnWheel</a></li>
</ul>
</details></li>
<li class="toctree-l3"><a class="reference internal" href="../aeon_modules/acquisition/logging.html">Logging</a></li>
<li class="toctree-l3"><a class="reference internal" href="../aeon_modules/acquisition/monitors.html">Device Synchronisation Monitors</a></li>
<li class="toctree-l3"><a class="reference internal" href="../aeon_modules/acquisition/nest.html">Nest</a></li>
<li class="toctree-l3"><a class="reference internal" href="../aeon_modules/acquisition/rfid_reader.html">RFID Reader</a></li>
<li class="toctree-l3"><a class="reference internal" href="../aeon_modules/acquisition/subject_tracking.html">Subject Tracking</a></li>
</ul>
</details></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../sample_datasets.html">Sample Datasets</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../tutorials.html">Tutorials</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../tutorials/aeon_dj_pipeline.html">DataJoint pipeline for Aeon</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorials/general_experimental_workflow.html">General experimental workflow infrastructure</a></li>
</ul>
</details></li>
<li class="toctree-l1 current active has-children"><a class="reference internal" href="../how_to.html">How-to Guides</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="dj_compute_bouts_copy.html">DataJoint pipeline: Computing behavioural bouts</a></li>
<li class="toctree-l2"><a class="reference internal" href="dj_data_ingestion_and_processing.html">DataJoint pipeline: Data ingestion and processing</a></li>
<li class="toctree-l2"><a class="reference internal" href="dj_fetching_data_copy.html">DataJoint pipeline: Fetching data as DataFrames</a></li>
<li class="toctree-l2"><a class="reference internal" href="dj_pipeline_local_deployment.html">DataJoint pipeline: On-premises deployment</a></li>
<li class="toctree-l2"><a class="reference internal" href="dj_querying_data_copy.html">DataJoint pipeline: Querying data</a></li>
<li class="toctree-l2"><a class="reference internal" href="hmm_example.html">Hidden Markov Model analysis of mouse behavioural syntax</a></li>
<li class="toctree-l2"><a class="reference internal" href="io_api_example_copy.html">Data access using the low-level API</a></li>
<li class="toctree-l2 current active"><a class="current reference internal" href="#">Platform paper social experiment analysis: Part 1</a></li>
<li class="toctree-l2"><a class="reference internal" href="social_analysis2.html">Platform paper social experiment analysis: Part 2</a></li>
</ul>
</details></li>
</ul>
</div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../index.html" class="nav-link">User Guide</a></li>
    
    
    <li class="breadcrumb-item"><a href="../how_to.html" class="nav-link">How-to Guides</a></li>
    
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">Platform paper social experiment analysis: Part 1</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="platform-paper-social-experiment-analysis-part-1">
<h1>Platform paper social experiment analysis: Part 1<a class="headerlink" href="#platform-paper-social-experiment-analysis-part-1" title="Link to this heading">#</a></h1>
<p>In this example we will work with behavioural data collected from experiments <code class="docutils literal notranslate"><span class="pre">social0.2</span></code>, <code class="docutils literal notranslate"><span class="pre">social0.3</span></code>, and <code class="docutils literal notranslate"><span class="pre">social0.4</span></code>, in which two mice foraged for food in the <a class="reference internal" href="../aeon_modules/hardware/habitat.html#target-habitat"><span class="std std-ref">habitat</span></a> with three <a class="reference internal" href="../aeon_modules/hardware/foraging_patch.html#target-foraging-patch"><span class="std std-ref">foraging patches</span></a> whose reward rates changed dynamically over time.</p>
<p>The experiments each consist of three periods:</p>
<ol class="arabic simple">
<li><p>“presocial”, in which each mouse was in the habitat alone for 3-4 days.</p></li>
<li><p>“social”, in which both mice were in the habitat together for 2 weeks.</p></li>
<li><p>“postsocial”, in which each mouse was in the habitat alone again for 3-4 days.</p></li>
</ol>
<p>The goal of the experiments was to understand how the mice’s behaviour changes as they learn to forage for food in the habitat, and how their behaviour differs between social vs. solo settings.</p>
<p>The full datasets are available on the <a class="reference internal" href="../sample_datasets.html#target-full-datasets"><span class="std std-ref">Datasets</span></a> page but for the purpose of this example, we will be using the precomputed <a class="reference external" href="https://app.globus.org/file-manager?origin_id=48cc1398-b591-4f52-85d2-f68801306d4a&amp;amp;origin_path=%2F"><strong>Platform paper social analysis datasets</strong></a>.</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p>“Extended Data Fig. 7”, in “Extended Data” in the “Supplementary Material” of the <a class="reference external" href="https://www.biorxiv.org/content/10.1101/2025.07.31.664513">platform paper</a> for a detailed description of the experiments.</p>
</div>
<p>Below is a brief explanation of how the environment (i.e. patch properties) changed over <a class="reference internal" href="../../reference/glossary.html#term-Block"><span class="xref std std-term">blocks</span></a> (60–180 minute periods of time):</p>
<ol class="arabic">
<li><p>Every block begins at a random interval <span class="math notranslate nohighlight">\(t\)</span>:</p>
<div class="math notranslate nohighlight">
\[
    t \sim \mathrm{Uniform}(60,\,180) \quad \text{In minutes}
    \]</div>
</li>
<li><p>At the start of each block, sample a row from the predefined matrix <span class="math notranslate nohighlight">\(\lambda_{\mathrm{set}}\)</span>:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
    \lambda_{\mathrm{set}} = 
    \begin{pmatrix}
    1 &amp; 1 &amp; 1 \\
    5 &amp; 5 &amp; 5 \\
    1 &amp; 3 &amp; 5 \\
    1 &amp; 5 &amp; 3 \\
    3 &amp; 1 &amp; 5 \\
    3 &amp; 5 &amp; 1 \\
    5 &amp; 1 &amp; 3 \\
    5 &amp; 3 &amp; 1 \\
    \end{pmatrix}
    \quad \text{In meters}
    \end{split}\]</div>
</li>
<li><p>Assign the sampled row to specific patch means <span class="math notranslate nohighlight">\(\lambda_{\mathrm{1}}, \lambda_{\mathrm{2}}, \lambda_{\mathrm{3}}\)</span> and apply a constant offset <span class="math notranslate nohighlight">\(c\)</span> to all thresholds:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
    \begin{aligned}
    \lambda_{\mathrm{1}}, \lambda_{\mathrm{2}}, \lambda_{\mathrm{3}} &amp;\sim \mathrm{Uniform}(\lambda_{\mathrm{set}}) \\
    c &amp;= 0.75
    \end{aligned}
    \quad \text{Patch means and offset}
    \end{split}\]</div>
</li>
<li><p>Sample a value from each of <span class="math notranslate nohighlight">\(P_{\mathrm{1}}, P_{\mathrm{2}}, P_{\mathrm{3}}\)</span> as the initial threshold for the respective patch. Whenever a patch reaches its threshold, resample a new value from its corresponding distribution:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
    \begin{aligned}
    P_{\mathrm{1}} &amp;= c + \mathrm{Exp}(1/\lambda_{\mathrm{1}}) \\
    P_{\mathrm{2}} &amp;= c + \mathrm{Exp}(1/\lambda_{\mathrm{2}}) \\
    P_{\mathrm{3}} &amp;= c + \mathrm{Exp}(1/\lambda_{\mathrm{3}})
    \end{aligned}
    \quad \text{Patch distributions}
    \end{split}\]</div>
</li>
</ol>
<section id="set-up-environment">
<h2>Set up environment<a class="headerlink" href="#set-up-environment" title="Link to this heading">#</a></h2>
<p>Create and activate a virtual environment named <code class="docutils literal notranslate"><span class="pre">social-analysis</span></code> using <a class="reference external" href="https://docs.astral.sh/uv/getting-started/installation/">uv</a>.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>uv<span class="w"> </span>venv<span class="w"> </span>aeon-social-analysis<span class="w"> </span>--python<span class="w"> </span><span class="s2">&quot;&gt;=3.11&quot;</span><span class="w"> </span>
<span class="nb">source</span><span class="w"> </span>aeon-social-analysis/bin/activate<span class="w">   </span><span class="c1"># Unix</span>
.<span class="se">\a</span>eon-social-analysis<span class="se">\S</span>cripts<span class="se">\a</span>ctivate<span class="w">   </span><span class="c1"># Windows</span>
</pre></div>
</div>
<p>Install the required <a class="reference external" href="https://github.com/lindermanlab/ssm"><code class="docutils literal notranslate"><span class="pre">ssm</span></code> package</a> and its dependencies.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>uv<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>matplotlib<span class="w"> </span>numpy<span class="w"> </span>pandas<span class="w"> </span>plotly<span class="w"> </span>seaborn<span class="w"> </span>statsmodels<span class="w"> </span>pyyaml<span class="w"> </span>pyarrow<span class="w"> </span>tqdm<span class="w"> </span>scipy<span class="w"> </span>jupyter
</pre></div>
</div>
</section>
<section id="import-libraries-and-define-variables-and-helper-functions">
<h2>Import libraries and define variables and helper functions<a class="headerlink" href="#import-libraries-and-define-variables-and-helper-functions" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">math</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">plotly.express</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">px</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">plotly.graph_objs</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">go</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">plotly.io</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pio</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">statsmodels.api</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sm</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">yaml</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">plotly.subplots</span><span class="w"> </span><span class="kn">import</span> <span class="n">make_subplots</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">binomtest</span><span class="p">,</span> <span class="n">ttest_rel</span><span class="p">,</span> <span class="n">wilcoxon</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tqdm.notebook</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Constants</span>
<span class="n">cm2px</span> <span class="o">=</span> <span class="mf">5.2</span>  <span class="c1"># 1 cm = 5.2 px roughly in aeon habitats</span>
<span class="n">light_off</span><span class="p">,</span> <span class="n">light_on</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">20</span>  <span class="c1"># 7am to 8pm</span>
<span class="n">fps</span> <span class="o">=</span> <span class="mi">50</span>  <span class="c1"># frames per second for tracking camera</span>

<span class="c1"># Experiment timelines</span>
<span class="n">experiments</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;social0.2-aeon3&quot;</span><span class="p">,</span>
        <span class="s2">&quot;presocial_start&quot;</span><span class="p">:</span> <span class="s2">&quot;2024-01-31 11:00:00&quot;</span><span class="p">,</span>
        <span class="s2">&quot;presocial_end&quot;</span><span class="p">:</span> <span class="s2">&quot;2024-02-08 15:00:00&quot;</span><span class="p">,</span>
        <span class="s2">&quot;social_start&quot;</span><span class="p">:</span> <span class="s2">&quot;2024-02-09 16:00:00&quot;</span><span class="p">,</span>
        <span class="s2">&quot;social_end&quot;</span><span class="p">:</span> <span class="s2">&quot;2024-02-23 13:00:00&quot;</span><span class="p">,</span>
        <span class="s2">&quot;postsocial_start&quot;</span><span class="p">:</span> <span class="s2">&quot;2024-02-25 17:00:00&quot;</span><span class="p">,</span>
        <span class="s2">&quot;postsocial_end&quot;</span><span class="p">:</span> <span class="s2">&quot;2024-03-02 14:00:00&quot;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;social0.2-aeon4&quot;</span><span class="p">,</span>
        <span class="s2">&quot;presocial_start&quot;</span><span class="p">:</span> <span class="s2">&quot;2024-01-31 11:00:00&quot;</span><span class="p">,</span>
        <span class="s2">&quot;presocial_end&quot;</span><span class="p">:</span> <span class="s2">&quot;2024-02-08 15:00:00&quot;</span><span class="p">,</span>
        <span class="s2">&quot;social_start&quot;</span><span class="p">:</span> <span class="s2">&quot;2024-02-09 17:00:00&quot;</span><span class="p">,</span>
        <span class="s2">&quot;social_end&quot;</span><span class="p">:</span> <span class="s2">&quot;2024-02-23 12:00:00&quot;</span><span class="p">,</span>
        <span class="s2">&quot;postsocial_start&quot;</span><span class="p">:</span> <span class="s2">&quot;2024-02-25 18:00:00&quot;</span><span class="p">,</span>
        <span class="s2">&quot;postsocial_end&quot;</span><span class="p">:</span> <span class="s2">&quot;2024-03-02 13:00:00&quot;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;social0.3-aeon3&quot;</span><span class="p">,</span>
        <span class="s2">&quot;presocial_start&quot;</span><span class="p">:</span> <span class="s2">&quot;2024-06-08 19:00:00&quot;</span><span class="p">,</span>
        <span class="s2">&quot;presocial_end&quot;</span><span class="p">:</span> <span class="s2">&quot;2024-06-17 13:00:00&quot;</span><span class="p">,</span>
        <span class="s2">&quot;social_start&quot;</span><span class="p">:</span> <span class="s2">&quot;2024-06-25 11:00:00&quot;</span><span class="p">,</span>
        <span class="s2">&quot;social_end&quot;</span><span class="p">:</span> <span class="s2">&quot;2024-07-06 13:00:00&quot;</span><span class="p">,</span>
        <span class="s2">&quot;postsocial_start&quot;</span><span class="p">:</span> <span class="s2">&quot;2024-07-07 16:00:00&quot;</span><span class="p">,</span>
        <span class="s2">&quot;postsocial_end&quot;</span><span class="p">:</span> <span class="s2">&quot;2024-07-14 14:00:00&quot;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;social0.3-aeon4&quot;</span><span class="p">,</span>  <span class="c1"># TODO: Add missing times</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;social0.4-aeon3&quot;</span><span class="p">,</span>
        <span class="s2">&quot;presocial_start&quot;</span><span class="p">:</span> <span class="s2">&quot;2024-08-16 17:00:00&quot;</span><span class="p">,</span>
        <span class="s2">&quot;presocial_end&quot;</span><span class="p">:</span> <span class="s2">&quot;2024-08-24 10:00:00&quot;</span><span class="p">,</span>
        <span class="s2">&quot;social_start&quot;</span><span class="p">:</span> <span class="s2">&quot;2024-08-28 11:00:00&quot;</span><span class="p">,</span>
        <span class="s2">&quot;social_end&quot;</span><span class="p">:</span> <span class="s2">&quot;2024-09-09 13:00:00&quot;</span><span class="p">,</span>
        <span class="s2">&quot;postsocial_start&quot;</span><span class="p">:</span> <span class="s2">&quot;2024-09-09 18:00:00&quot;</span><span class="p">,</span>
        <span class="s2">&quot;postsocial_end&quot;</span><span class="p">:</span> <span class="s2">&quot;2024-09-22 16:00:00&quot;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;social0.4-aeon4&quot;</span><span class="p">,</span>
        <span class="s2">&quot;presocial_start&quot;</span><span class="p">:</span> <span class="s2">&quot;2024-08-16 15:00:00&quot;</span><span class="p">,</span>
        <span class="s2">&quot;presocial_end&quot;</span><span class="p">:</span> <span class="s2">&quot;2024-08-24 10:00:00&quot;</span><span class="p">,</span>
        <span class="s2">&quot;social_start&quot;</span><span class="p">:</span> <span class="s2">&quot;2024-08-28 10:00:00&quot;</span><span class="p">,</span>
        <span class="s2">&quot;social_end&quot;</span><span class="p">:</span> <span class="s2">&quot;2024-09-09 01:00:00&quot;</span><span class="p">,</span>
        <span class="s2">&quot;postsocial_start&quot;</span><span class="p">:</span> <span class="s2">&quot;2024-09-09 15:00:00&quot;</span><span class="p">,</span>
        <span class="s2">&quot;postsocial_end&quot;</span><span class="p">:</span> <span class="s2">&quot;2024-09-22 16:00:00&quot;</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">]</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">load_data_from_parquet</span><span class="p">(</span>
    <span class="n">experiment_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">period</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">data_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">data_dir</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
    <span class="n">set_time_index</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Loads saved data from parquet files.</span>

<span class="sd">    Args:</span>
<span class="sd">        experiment_name (str, optional): Filter by experiment name. If None, load all experiments.</span>
<span class="sd">        period (str, optional): Filter by period (presocial, social, postsocial). If None, load all periods.</span>
<span class="sd">        data_type (str): Type of data to load (position, patch, foraging, rfid, sleep, explore)</span>
<span class="sd">        data_dir (Path): Directory containing parquet files.</span>
<span class="sd">        set_time_index (bool, optional): If True, set &#39;time&#39; column as DataFrame index.</span>

<span class="sd">    Returns:</span>
<span class="sd">        pd.DataFrame: Combined DataFrame of all matching parquet files.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">data_dir</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Directory </span><span class="si">{</span><span class="n">data_dir</span><span class="si">}</span><span class="s2"> does not exist. No data files found.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

    <span class="c1"># Create pattern based on filters</span>
    <span class="n">pattern</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">experiment_name</span><span class="p">:</span>
        <span class="n">pattern</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">experiment_name</span><span class="si">}</span><span class="s2">_&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pattern</span> <span class="o">+=</span> <span class="s2">&quot;*_&quot;</span>

    <span class="k">if</span> <span class="n">period</span><span class="p">:</span>
        <span class="n">pattern</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">period</span><span class="si">}</span><span class="s2">_&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pattern</span> <span class="o">+=</span> <span class="s2">&quot;*_&quot;</span>

    <span class="n">pattern</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">data_type</span><span class="si">}</span><span class="s2">.parquet&quot;</span>

    <span class="c1"># Find matching files</span>
    <span class="n">matching_files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">data_dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">pattern</span><span class="p">))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">matching_files</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No matching data files found with pattern: </span><span class="si">{</span><span class="n">pattern</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">matching_files</span><span class="p">)</span><span class="si">}</span><span class="s2"> matching files&quot;</span><span class="p">)</span>

    <span class="c1"># Load and concatenate matching files</span>
    <span class="n">dfs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">total_rows</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">matching_files</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading </span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
        <span class="n">total_rows</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="n">dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Loaded </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="si">}</span><span class="s2"> rows&quot;</span><span class="p">)</span>

    <span class="c1"># Combine data</span>
    <span class="k">if</span> <span class="n">dfs</span><span class="p">:</span>
        <span class="n">combined_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">dfs</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">set_time_index</span> <span class="ow">and</span> <span class="s2">&quot;time&quot;</span> <span class="ow">in</span> <span class="n">combined_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">combined_df</span> <span class="o">=</span> <span class="n">combined_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Combined data: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">combined_df</span><span class="p">)</span><span class="si">}</span><span class="s2"> rows&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">combined_df</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>


<span class="k">def</span><span class="w"> </span><span class="nf">load_experiment_data</span><span class="p">(</span>
    <span class="n">data_dir</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
    <span class="n">experiment</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">periods</span><span class="p">:</span> <span class="nb">list</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">data_types</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;rfid&quot;</span><span class="p">,</span> <span class="s2">&quot;position&quot;</span><span class="p">],</span>
    <span class="n">trim_days</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Load all data types for specified periods of an experiment.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    - experiment: experiment dict with period start/end times</span>
<span class="sd">    - periods: list of periods to load</span>
<span class="sd">    - data_types: list of data types to load</span>
<span class="sd">    - data_dir: directory containing data files</span>
<span class="sd">    - trim_days: Optional number of days to trim from start (None = no trim)</span>

<span class="sd">    Returns:</span>
<span class="sd">    - Dictionary containing dataframes for each period/data type combination</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="n">periods</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">periods</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">period</span> <span class="ow">in</span> <span class="n">periods</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">data_type</span> <span class="ow">in</span> <span class="n">data_types</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading </span><span class="si">{</span><span class="n">period</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">data_type</span><span class="si">}</span><span class="s2"> data...&quot;</span><span class="p">)</span>

            <span class="c1"># Load data</span>
            <span class="n">experiment_name</span> <span class="o">=</span> <span class="n">experiment</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">experiment</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">load_data_from_parquet</span><span class="p">(</span>
                <span class="n">experiment_name</span><span class="o">=</span><span class="n">experiment_name</span><span class="p">,</span>
                <span class="n">period</span><span class="o">=</span><span class="n">period</span><span class="p">,</span>
                <span class="n">data_type</span><span class="o">=</span><span class="n">data_type</span><span class="p">,</span>
                <span class="n">data_dir</span><span class="o">=</span><span class="n">data_dir</span><span class="p">,</span>
                <span class="n">set_time_index</span><span class="o">=</span><span class="p">(</span><span class="n">data_type</span> <span class="o">==</span> <span class="s2">&quot;position&quot;</span><span class="p">),</span>
            <span class="p">)</span>

            <span class="c1"># Trim if requested</span>
            <span class="k">if</span> <span class="n">trim_days</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">data_type</span> <span class="o">==</span> <span class="s2">&quot;rfid&quot;</span><span class="p">:</span>
                    <span class="n">start_time</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;chunk_start&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
                    <span class="n">end_time</span> <span class="o">=</span> <span class="n">start_time</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">trim_days</span><span class="p">)</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;chunk_start&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">end_time</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">data_type</span> <span class="o">==</span> <span class="s2">&quot;foraging&quot;</span><span class="p">:</span>
                    <span class="n">start_time</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
                    <span class="n">end_time</span> <span class="o">=</span> <span class="n">start_time</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">trim_days</span><span class="p">)</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">end_time</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">data_type</span> <span class="o">==</span> <span class="s2">&quot;position&quot;</span><span class="p">:</span>
                    <span class="n">start_time</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
                    <span class="n">end_time</span> <span class="o">=</span> <span class="n">start_time</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">trim_days</span><span class="p">)</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">&lt;</span> <span class="n">end_time</span><span class="p">]</span>

                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Trimmed to </span><span class="si">{</span><span class="n">trim_days</span><span class="si">}</span><span class="s2"> days: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="si">}</span><span class="s2"> records&quot;</span><span class="p">)</span>

            <span class="c1"># Store in result</span>
            <span class="n">key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">period</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">data_type</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span>

            <span class="c1"># For position data, handle duplicates</span>
            <span class="k">if</span> <span class="n">data_type</span> <span class="o">==</span> <span class="s2">&quot;position&quot;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">original_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="s2">&quot;identity_name&quot;</span><span class="p">])</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">)</span>
                <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">original_len</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Removed duplicates: </span><span class="si">{</span><span class="n">original_len</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span><span class="w"> </span><span class="nf">extract_proximity_periods</span><span class="p">(</span>
    <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">distance_threshold</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">60</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="nb">list</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract time periods where mice are close to each other.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    - df: DataFrame with columns [&#39;time&#39;, &#39;identity_name&#39;, &#39;x&#39;, &#39;y&#39;]</span>
<span class="sd">    - distance_threshold: Maximum distance in pixels for considering mice &quot;close&quot; (default: 60)</span>

<span class="sd">    Returns:</span>
<span class="sd">    - Tuple of (start_times, end_times) lists of matching size</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Convert time to datetime if needed and sort</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">pd</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">is_datetime64_any_dtype</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">])</span>

    <span class="c1"># Get unique mice and times</span>
    <span class="n">mice</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;identity_name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
    <span class="n">n_mice</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mice</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">n_mice</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[],</span> <span class="p">[]</span>

    <span class="c1"># Create a more efficient data structure</span>
    <span class="c1"># Pivot to get x,y coordinates for each mouse at each time</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="n">n_mice</span><span class="si">}</span><span class="s2"> mice, reshaping data...&quot;</span><span class="p">)</span>
    <span class="n">df_pivot_x</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span>
        <span class="n">index</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s2">&quot;identity_name&quot;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">aggfunc</span><span class="o">=</span><span class="s2">&quot;first&quot;</span>
    <span class="p">)</span>
    <span class="n">df_pivot_y</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span>
        <span class="n">index</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s2">&quot;identity_name&quot;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">aggfunc</span><span class="o">=</span><span class="s2">&quot;first&quot;</span>
    <span class="p">)</span>

    <span class="c1"># Get common time points where we have data</span>
    <span class="n">times</span> <span class="o">=</span> <span class="n">df_pivot_x</span><span class="o">.</span><span class="n">index</span>

    <span class="c1"># Convert to numpy arrays for speed</span>
    <span class="n">x_coords</span> <span class="o">=</span> <span class="n">df_pivot_x</span><span class="o">.</span><span class="n">values</span>  <span class="c1"># shape: (n_times, n_mice)</span>
    <span class="n">y_coords</span> <span class="o">=</span> <span class="n">df_pivot_y</span><span class="o">.</span><span class="n">values</span>

    <span class="c1"># Pre-allocate boolean array for proximity status</span>
    <span class="n">is_close</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">times</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>

    <span class="c1"># Process in chunks to manage memory and provide progress</span>
    <span class="n">chunk_size</span> <span class="o">=</span> <span class="mi">10000</span>

    <span class="k">with</span> <span class="n">tqdm</span><span class="p">(</span>
        <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">times</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Calculating distances&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;timepoints&quot;</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">pbar</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">start_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">times</span><span class="p">),</span> <span class="n">chunk_size</span><span class="p">):</span>
            <span class="n">end_idx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">start_idx</span> <span class="o">+</span> <span class="n">chunk_size</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">times</span><span class="p">))</span>

            <span class="n">x_chunk</span> <span class="o">=</span> <span class="n">x_coords</span><span class="p">[</span><span class="n">start_idx</span><span class="p">:</span><span class="n">end_idx</span><span class="p">]</span>  <span class="c1"># shape: (chunk_size, n_mice)</span>
            <span class="n">y_chunk</span> <span class="o">=</span> <span class="n">y_coords</span><span class="p">[</span><span class="n">start_idx</span><span class="p">:</span><span class="n">end_idx</span><span class="p">]</span>

            <span class="c1"># For each time point in chunk, check if any pair is close</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">x_chunk</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">x_positions</span> <span class="o">=</span> <span class="n">x_chunk</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">y_positions</span> <span class="o">=</span> <span class="n">y_chunk</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

                <span class="c1"># Remove NaN positions (missing mice)</span>
                <span class="n">valid_mask</span> <span class="o">=</span> <span class="o">~</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">x_positions</span><span class="p">)</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">y_positions</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">valid_mask</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">x_valid</span> <span class="o">=</span> <span class="n">x_positions</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">]</span>
                <span class="n">y_valid</span> <span class="o">=</span> <span class="n">y_positions</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">]</span>

                <span class="c1"># Calculate all pairwise distances using broadcasting</span>
                <span class="n">dx</span> <span class="o">=</span> <span class="n">x_valid</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">-</span> <span class="n">x_valid</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>
                <span class="n">dy</span> <span class="o">=</span> <span class="n">y_valid</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">-</span> <span class="n">y_valid</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>
                <span class="n">distances</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dx</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">dy</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

                <span class="c1"># Check if any pair (excluding diagonal) is close</span>
                <span class="c1"># Use upper triangle to avoid checking same pair twice</span>
                <span class="n">upper_triangle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">triu</span><span class="p">(</span><span class="n">distances</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

                <span class="c1"># Only check non-zero distances (exclude the zeros from masking)</span>
                <span class="n">non_zero_distances</span> <span class="o">=</span> <span class="n">upper_triangle</span><span class="p">[</span><span class="n">upper_triangle</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
                <span class="n">is_close</span><span class="p">[</span><span class="n">start_idx</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">non_zero_distances</span> <span class="o">&lt;</span> <span class="n">distance_threshold</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">non_zero_distances</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
                    <span class="k">else</span> <span class="kc">False</span>
                <span class="p">)</span>

            <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">end_idx</span> <span class="o">-</span> <span class="n">start_idx</span><span class="p">)</span>

    <span class="c1"># Find transitions</span>
    <span class="c1"># Start: current is close and previous is not close (or first point)</span>
    <span class="n">starts_mask</span> <span class="o">=</span> <span class="n">is_close</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">is_close</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">starts_mask</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">is_close</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Handle first point</span>

    <span class="c1"># End: current is close and next is not close (or last point)</span>
    <span class="n">ends_mask</span> <span class="o">=</span> <span class="n">is_close</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">is_close</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ends_mask</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">is_close</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># Handle last point</span>

    <span class="n">start_times</span> <span class="o">=</span> <span class="n">times</span><span class="p">[</span><span class="n">starts_mask</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">end_times</span> <span class="o">=</span> <span class="n">times</span><span class="p">[</span><span class="n">ends_mask</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

    <span class="c1"># Ensure equal length</span>
    <span class="n">min_length</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">start_times</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">end_times</span><span class="p">))</span>
    <span class="n">start_times</span> <span class="o">=</span> <span class="n">start_times</span><span class="p">[:</span><span class="n">min_length</span><span class="p">]</span>
    <span class="n">end_times</span> <span class="o">=</span> <span class="n">end_times</span><span class="p">[:</span><span class="n">min_length</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">start_times</span><span class="p">,</span> <span class="n">end_times</span>


<span class="c1"># Create events DataFrame from proximity periods</span>
<span class="k">def</span><span class="w"> </span><span class="nf">create_events_df_from_proximity</span><span class="p">(</span>
    <span class="n">start_times</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">end_times</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">experiment_name</span><span class="p">:</span> <span class="nb">str</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create events DataFrame from proximity start/end times with root information.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    - start_times: List of proximity period start timestamps</span>
<span class="sd">    - end_times: List of proximity period end timestamps</span>
<span class="sd">    - experiment_name: Name of experiment in format &#39;experiment-computer&#39;</span>

<span class="sd">    Returns:</span>
<span class="sd">    - DataFrame with proximity events including timestamps, root path, and duration</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">events_data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">experiment</span><span class="p">,</span> <span class="n">acquisition_computer</span> <span class="o">=</span> <span class="n">experiment_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">acquisition_computer</span> <span class="o">=</span> <span class="n">acquisition_computer</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
    <span class="n">root_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;/ceph/aeon/aeon/data/raw/</span><span class="si">{</span><span class="n">acquisition_computer</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">experiment</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">for</span> <span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">start_times</span><span class="p">,</span> <span class="n">end_times</span><span class="p">):</span>
        <span class="n">events_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;start_timestamp&quot;</span><span class="p">:</span> <span class="n">start_time</span><span class="p">,</span>
                <span class="s2">&quot;end_timestamp&quot;</span><span class="p">:</span> <span class="n">end_time</span><span class="p">,</span>
                <span class="s2">&quot;root&quot;</span><span class="p">:</span> <span class="n">root_path</span><span class="p">,</span>
                <span class="s2">&quot;duration_seconds&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">(),</span>
            <span class="p">}</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">events_data</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">patch_info_df_to_dict</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert patch information DataFrame to nested dictionary format.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    - df: DataFrame containing patch information with columns [&#39;experiment_name&#39;, &#39;block_start&#39;, &#39;patch_name&#39;, &#39;patch_rate&#39;, &#39;patch_offset&#39;]</span>

<span class="sd">    Returns:</span>
<span class="sd">    - Dictionary with experiments as keys and lists of patch entries as values</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">result_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">exp</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;experiment_name&quot;</span><span class="p">]</span>

        <span class="c1"># Initialize experiment entry if it doesn&#39;t exist</span>
        <span class="k">if</span> <span class="n">exp</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">result_dict</span><span class="p">:</span>
            <span class="n">result_dict</span><span class="p">[</span><span class="n">exp</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Create entry dictionary</span>
        <span class="n">entry</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;block_start&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;block_start&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_pydatetime</span><span class="p">(),</span>
            <span class="s2">&quot;patch_name&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;patch_name&quot;</span><span class="p">],</span>
            <span class="s2">&quot;patch_rate&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;patch_rate&quot;</span><span class="p">],</span>
            <span class="s2">&quot;patch_offset&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;patch_offset&quot;</span><span class="p">],</span>
        <span class="p">}</span>

        <span class="c1"># Add entry to experiment list</span>
        <span class="n">result_dict</span><span class="p">[</span><span class="n">exp</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">result_dict</span>


<span class="k">def</span><span class="w"> </span><span class="nf">patch_df_to_dict</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert patch DataFrame to dictionary grouped by experiment.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    - df: DataFrame containing patch data with &#39;experiment_name&#39; column</span>

<span class="sd">    Returns:</span>
<span class="sd">    - Dictionary with experiment names as keys and filtered DataFrames as values</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">results_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">experiment</span> <span class="ow">in</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;experiment_name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
        <span class="c1"># Filter the dataframe to only include rows for this experiment</span>
        <span class="n">experiment_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;experiment_name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">experiment</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># Remove unwanted columns</span>
        <span class="n">experiment_df</span> <span class="o">=</span> <span class="n">experiment_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;experiment_name&quot;</span><span class="p">])</span>

        <span class="c1"># Assign the filtered DataFrame directly to the dictionary</span>
        <span class="n">results_dict</span><span class="p">[</span><span class="n">experiment</span><span class="p">]</span> <span class="o">=</span> <span class="n">experiment_df</span>

    <span class="k">return</span> <span class="n">results_dict</span>


<span class="k">def</span><span class="w"> </span><span class="nf">get_first_half_social</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract the first half of social period data for each experiment.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    - df: DataFrame containing experiment data with &#39;period&#39; and &#39;experiment_name&#39; columns</span>

<span class="sd">    Returns:</span>
<span class="sd">    - DataFrame containing first half of social data for all experiments</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get social data</span>
    <span class="n">social_data</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;period&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;social&quot;</span><span class="p">]</span>

    <span class="c1"># Group social data by experiment</span>
    <span class="n">social_by_exp</span> <span class="o">=</span> <span class="n">social_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;experiment_name&quot;</span><span class="p">)</span>

    <span class="c1"># For each experiment, take the first half of social data</span>
    <span class="n">half_social_data_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">_exp_name</span><span class="p">,</span> <span class="n">exp_data</span> <span class="ow">in</span> <span class="n">social_by_exp</span><span class="p">:</span>
        <span class="c1"># Sort by block_start to ensure chronological order</span>
        <span class="n">exp_data_sorted</span> <span class="o">=</span> <span class="n">exp_data</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;block_start&quot;</span><span class="p">)</span>

        <span class="c1"># Calculate the half-point</span>
        <span class="n">half_point</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">exp_data_sorted</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>

        <span class="c1"># Take the first half</span>
        <span class="n">first_half</span> <span class="o">=</span> <span class="n">exp_data_sorted</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="n">half_point</span><span class="p">]</span>

        <span class="c1"># Add to list</span>
        <span class="n">half_social_data_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">first_half</span><span class="p">)</span>

    <span class="c1"># Combine all first halves into one dataframe</span>
    <span class="n">half_social_data</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">half_social_data_list</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">half_social_data_list</span>
        <span class="k">else</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">social_data</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">half_social_data</span>


<span class="k">def</span><span class="w"> </span><span class="nf">compute_patch_probabilities</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute patch probabilities based on block and subject data.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    - df: DataFrame containing block, subject, pellet, and patch data</span>

<span class="sd">    Returns:</span>
<span class="sd">    - DataFrame with probabilities for each patch per pellet interval</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Precompute unique block-subject groups</span>
    <span class="n">grouped_data</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;block_start&quot;</span><span class="p">,</span> <span class="s2">&quot;subject_name&quot;</span><span class="p">])</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">block_start</span><span class="p">,</span> <span class="n">subject_name</span><span class="p">),</span> <span class="n">block_data</span> <span class="ow">in</span> <span class="n">grouped_data</span><span class="p">:</span>
        <span class="c1"># Process pellet timestamps once</span>
        <span class="c1"># Extract and ensure all pellet timestamps are float</span>
        <span class="n">all_pellet_timestamps</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="n">block_data</span><span class="p">[</span><span class="s2">&quot;pellet_timestamps&quot;</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">ts</span> <span class="ow">in</span> <span class="n">sublist</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">all_pellet_timestamps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">ts</span><span class="p">))</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
                    <span class="c1"># Skip values that can&#39;t be converted to float</span>
                    <span class="k">pass</span>

        <span class="n">pellet_timestamps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">all_pellet_timestamps</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pellet_timestamps</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># Create pellet intervals DataFrame</span>
        <span class="n">intervals_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;interval_start&quot;</span><span class="p">:</span> <span class="n">pellet_timestamps</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                <span class="s2">&quot;interval_end&quot;</span><span class="p">:</span> <span class="n">pellet_timestamps</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span>
                <span class="s2">&quot;pellet_number&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">pellet_timestamps</span><span class="p">)),</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="c1"># Prepare a dict to hold in_patch_timestamps for each patch</span>
        <span class="n">patches_data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">patch</span> <span class="ow">in</span> <span class="n">block_data</span><span class="p">[</span><span class="s2">&quot;patch_name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
            <span class="n">patch_data</span> <span class="o">=</span> <span class="n">block_data</span><span class="p">[</span><span class="n">block_data</span><span class="p">[</span><span class="s2">&quot;patch_name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">patch</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">patch_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;More than one row per block start, subject, patch combination.&quot;</span>
                <span class="p">)</span>

            <span class="c1"># Get timestamps and ensure they&#39;re floats</span>
            <span class="n">in_patch_ts_raw</span> <span class="o">=</span> <span class="n">patch_data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;in_patch_timestamps&quot;</span><span class="p">]</span>
            <span class="n">in_patch_timestamps</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">ts</span> <span class="ow">in</span> <span class="n">in_patch_ts_raw</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">in_patch_timestamps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">ts</span><span class="p">))</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
                    <span class="c1"># Skip values that can&#39;t be converted to float</span>
                    <span class="k">pass</span>

            <span class="n">patches_data</span><span class="p">[</span><span class="n">patch</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">in_patch_timestamps</span><span class="p">))</span>

        <span class="c1"># Initialize a DataFrame to store counts per patch</span>
        <span class="n">counts_df</span> <span class="o">=</span> <span class="n">intervals_df</span><span class="p">[[</span><span class="s2">&quot;pellet_number&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># For each patch, compute counts within each interval using numpy searchsorted</span>
        <span class="k">for</span> <span class="n">patch</span><span class="p">,</span> <span class="n">in_patch_ts</span> <span class="ow">in</span> <span class="n">patches_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">intervals_df</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">in_patch_ts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># Convert to float arrays explicitly</span>
                <span class="n">in_patch_ts</span> <span class="o">=</span> <span class="n">in_patch_ts</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
                <span class="n">interval_starts</span> <span class="o">=</span> <span class="n">intervals_df</span><span class="p">[</span><span class="s2">&quot;interval_start&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">float64</span>
                <span class="p">)</span>
                <span class="n">interval_ends</span> <span class="o">=</span> <span class="n">intervals_df</span><span class="p">[</span><span class="s2">&quot;interval_end&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

                <span class="n">idx_start</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">in_patch_ts</span><span class="p">,</span> <span class="n">interval_starts</span><span class="p">,</span> <span class="n">side</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
                <span class="n">idx_end</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">in_patch_ts</span><span class="p">,</span> <span class="n">interval_ends</span><span class="p">,</span> <span class="n">side</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">)</span>
                <span class="n">counts</span> <span class="o">=</span> <span class="n">idx_end</span> <span class="o">-</span> <span class="n">idx_start</span>
            <span class="n">counts_df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;count_in_</span><span class="si">{</span><span class="n">patch</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">counts</span>

        <span class="c1"># Compute total counts per interval</span>
        <span class="n">counts_df</span><span class="p">[</span><span class="s2">&quot;total_counts&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">counts_df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">like</span><span class="o">=</span><span class="s2">&quot;count_in_&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Avoid division by zero</span>
        <span class="n">counts_df</span><span class="p">[</span><span class="s2">&quot;total_counts&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">counts_df</span><span class="p">[</span><span class="s2">&quot;total_counts&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

        <span class="c1"># Compute probabilities per interval</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">counts_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">pellet_number</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;pellet_number&quot;</span><span class="p">]</span>
            <span class="n">row_data</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;block_start&quot;</span><span class="p">:</span> <span class="n">block_start</span><span class="p">,</span>
                <span class="s2">&quot;subject_name&quot;</span><span class="p">:</span> <span class="n">subject_name</span><span class="p">,</span>
                <span class="s2">&quot;pellet_number&quot;</span><span class="p">:</span> <span class="n">pellet_number</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">ts_in_patches</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">patch</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;count_in_</span><span class="si">{</span><span class="n">patch</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">patch</span> <span class="ow">in</span> <span class="n">patches_data</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="p">}</span>
            <span class="n">ts_in_patches_total</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;total_counts&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">ts_in_patches_total</span><span class="p">):</span>
                <span class="n">prob</span> <span class="o">=</span> <span class="p">{</span><span class="n">patch</span><span class="p">:</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">patch</span> <span class="ow">in</span> <span class="n">ts_in_patches</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">prob</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">patch</span><span class="p">:</span> <span class="n">ts_in_patches</span><span class="p">[</span><span class="n">patch</span><span class="p">]</span> <span class="o">/</span> <span class="n">ts_in_patches_total</span>
                    <span class="k">for</span> <span class="n">patch</span> <span class="ow">in</span> <span class="n">ts_in_patches</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                <span class="p">}</span>
            <span class="n">row_data</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="p">{</span><span class="sa">f</span><span class="s2">&quot;prob_in_</span><span class="si">{</span><span class="n">patch</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="n">prob</span><span class="p">[</span><span class="n">patch</span><span class="p">]</span> <span class="k">for</span> <span class="n">patch</span> <span class="ow">in</span> <span class="n">patches_data</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
            <span class="p">)</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row_data</span><span class="p">)</span>

    <span class="c1"># Create final DataFrame</span>
    <span class="n">prob_per_patch</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">prob_per_patch</span>


<span class="k">def</span><span class="w"> </span><span class="nf">extract_hard_patch_probabilities</span><span class="p">(</span>
    <span class="n">prob_per_patch</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">patch_info</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
    <span class="n">patch_rate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.002</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract probabilities for hard patches matching specified patch rate.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    - prob_per_patch: DataFrame containing probabilities per patch</span>
<span class="sd">    - patch_info: List of dictionaries with patch information</span>
<span class="sd">    - patch_rate: Patch rate to filter by (default: 0.002)</span>

<span class="sd">    Returns:</span>
<span class="sd">    - DataFrame with probabilities for each hard patch</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Filter the hard patches based on the patch_rate</span>
    <span class="n">hard_patches</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">patch_dict</span>
        <span class="k">for</span> <span class="n">patch_dict</span> <span class="ow">in</span> <span class="n">patch_info</span>
        <span class="k">if</span> <span class="n">patch_dict</span><span class="p">[</span><span class="s2">&quot;patch_rate&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">patch_rate</span>
    <span class="p">]</span>

    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">hard_patch</span> <span class="ow">in</span> <span class="n">hard_patches</span><span class="p">:</span>
        <span class="n">block_start</span> <span class="o">=</span> <span class="n">hard_patch</span><span class="p">[</span><span class="s2">&quot;block_start&quot;</span><span class="p">]</span>
        <span class="n">patch_name</span> <span class="o">=</span> <span class="n">hard_patch</span><span class="p">[</span><span class="s2">&quot;patch_name&quot;</span><span class="p">]</span>

        <span class="c1"># Extract the hard patch data</span>
        <span class="n">hard_patch_data</span> <span class="o">=</span> <span class="n">prob_per_patch</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="n">prob_per_patch</span><span class="p">[</span><span class="s2">&quot;block_start&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">block_start</span><span class="p">,</span>
            <span class="p">[</span><span class="s2">&quot;block_start&quot;</span><span class="p">,</span> <span class="s2">&quot;subject_name&quot;</span><span class="p">,</span> <span class="s2">&quot;pellet_number&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;prob_in_</span><span class="si">{</span><span class="n">patch_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span>
        <span class="p">]</span>

        <span class="c1"># Rename the column for hard patch probability</span>
        <span class="n">hard_patch_data</span> <span class="o">=</span> <span class="n">hard_patch_data</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
            <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="sa">f</span><span class="s2">&quot;prob_in_</span><span class="si">{</span><span class="n">patch_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="s2">&quot;prob_in_hard_patch&quot;</span><span class="p">}</span>
        <span class="p">)</span>

        <span class="c1"># Append the result to the list</span>
        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hard_patch_data</span><span class="p">)</span>

    <span class="c1"># Concatenate all results into a single DataFrame</span>
    <span class="n">prob_hard_patch</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">prob_hard_patch</span>


<span class="k">def</span><span class="w"> </span><span class="nf">analyze_patch_probabilities</span><span class="p">(</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">label</span><span class="p">:</span> <span class="nb">str</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">sm</span><span class="o">.</span><span class="n">OLS</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Analyze patch probabilities using linear regression model.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    - data: DataFrame containing pellet_number and prob_in_hard_patch columns</span>
<span class="sd">    - label: Label for the analysis output</span>

<span class="sd">    Returns:</span>
<span class="sd">    - Tuple of (fitted OLS model, predicted values array)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Prepare the data for statsmodels (add a constant for the intercept)</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;pellet_number&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">35</span><span class="p">])</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;prob_in_hard_patch&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">35</span><span class="p">])</span>
    <span class="c1"># Add a constant to the independent variable X to calculate the intercept</span>
    <span class="n">X_with_constant</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">add_constant</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    <span class="c1"># Fit the model using statsmodels</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">OLS</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">X_with_constant</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
    <span class="n">y_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_with_constant</span><span class="p">)</span>
    <span class="c1"># Get the p-value for the slope</span>
    <span class="n">p_value</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">pvalues</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;P-value for the </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2"> slope: </span><span class="si">{</span><span class="n">p_value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># Print full statistical summary</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2"> model summary: &quot;</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">summary</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">model</span><span class="p">,</span> <span class="n">y_pred</span>


<span class="k">def</span><span class="w"> </span><span class="nf">plot_in_chunks</span><span class="p">(</span><span class="n">ax</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="o">**</span><span class="n">plot_kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Break data into segments and plot each as separate path to avoid memory issues.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    - ax: Matplotlib axes object to plot on</span>
<span class="sd">    - x: X-coordinate data array</span>
<span class="sd">    - y: Y-coordinate data array</span>
<span class="sd">    - **plot_kwargs: Additional keyword arguments passed to plot function</span>

<span class="sd">    Returns:</span>
<span class="sd">    - None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="mi">20000</span><span class="p">):</span>
        <span class="n">xi</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">20000</span><span class="p">]</span>
        <span class="n">yi</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">20000</span><span class="p">]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">yi</span><span class="p">,</span> <span class="o">**</span><span class="n">plot_kwargs</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Change <code class="docutils literal notranslate"><span class="pre">data_dir</span></code> and <code class="docutils literal notranslate"><span class="pre">save_dir</span></code> to the paths where your local dataset (the parquet files) is stored and where you want to save the results.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># SET THESE VARIABLES ACCORDINGLY</span>
<span class="n">data_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="n">save_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

<span class="c1"># Load metadata</span>
<span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">data_dir</span> <span class="o">/</span> <span class="s2">&quot;Metadata_aeon3.yml&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
    <span class="n">metadata_aeon3</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">data_dir</span> <span class="o">/</span> <span class="s2">&quot;Metadata_aeon4.yml&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
    <span class="n">metadata_aeon4</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="dominance-plots">
<h2>Dominance plots<a class="headerlink" href="#dominance-plots" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Parameters</span>
<span class="n">DISTANCE_THRESH</span> <span class="o">=</span> <span class="mi">50</span>  <span class="c1"># px</span>
<span class="n">MIN_DUR</span><span class="p">,</span> <span class="n">MAX_DUR</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span>  <span class="c1"># seconds</span>
<span class="n">PADDING_SEC</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">SAMPLE_SIZE</span> <span class="o">=</span> <span class="mi">100</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load all periods for a given experiment</span>
<span class="n">experiment</span> <span class="o">=</span> <span class="n">experiments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">load_experiment_data</span><span class="p">(</span>
    <span class="n">experiment</span><span class="o">=</span><span class="n">experiment</span><span class="p">,</span>
    <span class="n">data_dir</span><span class="o">=</span><span class="n">data_dir</span><span class="p">,</span>
    <span class="n">periods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;social&quot;</span><span class="p">],</span>
    <span class="n">data_types</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;retreat&quot;</span><span class="p">,</span> <span class="s2">&quot;position&quot;</span><span class="p">],</span>
<span class="p">)</span>

<span class="n">social_retreat_df</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;social_retreat&quot;</span><span class="p">]</span>
<span class="n">social_position_df</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;social_position&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">exp</span><span class="p">,</span> <span class="n">acq_pc</span> <span class="o">=</span> <span class="n">experiment</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">metadata</span> <span class="o">=</span> <span class="n">metadata_aeon3</span> <span class="k">if</span> <span class="n">acq_pc</span> <span class="o">==</span> <span class="s2">&quot;aeon3&quot;</span> <span class="k">else</span> <span class="n">metadata_aeon4</span>

<span class="n">inner_radius</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;ActiveRegion&quot;</span><span class="p">][</span><span class="s2">&quot;ArenaInnerRadius&quot;</span><span class="p">])</span>
<span class="n">outer_radius</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;ActiveRegion&quot;</span><span class="p">][</span><span class="s2">&quot;ArenaOuterRadius&quot;</span><span class="p">])</span>
<span class="n">center_x</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;ActiveRegion&quot;</span><span class="p">][</span><span class="s2">&quot;ArenaCenter&quot;</span><span class="p">][</span><span class="s2">&quot;X&quot;</span><span class="p">])</span>
<span class="n">center_y</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;ActiveRegion&quot;</span><span class="p">][</span><span class="s2">&quot;ArenaCenter&quot;</span><span class="p">][</span><span class="s2">&quot;Y&quot;</span><span class="p">])</span>
<span class="n">nest_y1</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;ActiveRegion&quot;</span><span class="p">][</span><span class="s2">&quot;NestRegion&quot;</span><span class="p">][</span><span class="s2">&quot;ArrayOfPoint&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;Y&quot;</span><span class="p">])</span>
<span class="n">nest_y2</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;ActiveRegion&quot;</span><span class="p">][</span><span class="s2">&quot;NestRegion&quot;</span><span class="p">][</span><span class="s2">&quot;ArrayOfPoint&quot;</span><span class="p">][</span><span class="mi">2</span><span class="p">][</span><span class="s2">&quot;Y&quot;</span><span class="p">])</span>
<span class="n">gate_width</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">gate_coordinates</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">device</span> <span class="ow">in</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;Devices&quot;</span><span class="p">]:</span>
    <span class="k">if</span> <span class="s2">&quot;Gate&quot;</span> <span class="ow">in</span> <span class="n">device</span> <span class="ow">and</span> <span class="s2">&quot;Rfid&quot;</span> <span class="ow">in</span> <span class="n">device</span><span class="p">:</span>
        <span class="n">gate_coordinates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;Devices&quot;</span><span class="p">][</span><span class="n">device</span><span class="p">][</span><span class="s2">&quot;Location&quot;</span><span class="p">])</span>

<span class="c1"># Compute squared distance from arena center</span>
<span class="n">social_position_df</span><span class="p">[</span><span class="s2">&quot;dist2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">social_position_df</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">center_x</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span>
    <span class="n">social_position_df</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">center_y</span>
<span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>

<span class="c1"># Build “in‐corridor” mask (between inner &amp; outer radii)</span>
<span class="n">mask_corridor</span> <span class="o">=</span> <span class="n">social_position_df</span><span class="p">[</span><span class="s2">&quot;dist2&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="n">inner_radius</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">outer_radius</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

<span class="c1"># Exclude the nest region (to the right of center, between nest_y1 &amp; nest_y2)</span>
<span class="n">mask_nest</span> <span class="o">=</span> <span class="o">~</span><span class="p">(</span>
    <span class="p">(</span><span class="n">social_position_df</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">center_x</span><span class="p">)</span>
    <span class="o">&amp;</span> <span class="p">(</span><span class="n">social_position_df</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="n">nest_y1</span><span class="p">,</span> <span class="n">nest_y2</span><span class="p">))</span>
<span class="p">)</span>

<span class="c1"># Exclude all gate regions (within gate_width of any gate)</span>
<span class="n">mask_gate</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">social_position_df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<span class="k">for</span> <span class="n">loc</span> <span class="ow">in</span> <span class="n">gate_coordinates</span><span class="p">:</span>
    <span class="n">gx</span><span class="p">,</span> <span class="n">gy</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;X&quot;</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;Y&quot;</span><span class="p">])</span>
    <span class="n">d2</span> <span class="o">=</span> <span class="p">(</span><span class="n">social_position_df</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">gx</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">social_position_df</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">gy</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
    <span class="n">mask_gate</span> <span class="o">&amp;=</span> <span class="n">d2</span> <span class="o">&gt;</span> <span class="n">gate_width</span><span class="o">**</span><span class="mi">2</span>

<span class="c1"># Combine spatial masks</span>
<span class="n">spatial_mask</span> <span class="o">=</span> <span class="n">mask_corridor</span> <span class="o">&amp;</span> <span class="n">mask_nest</span> <span class="o">&amp;</span> <span class="n">mask_gate</span>

<span class="c1"># Apply spatial filter</span>
<span class="n">df_spatial</span> <span class="o">=</span> <span class="n">social_position_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spatial_mask</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">df_spatial</span> <span class="o">=</span> <span class="n">df_spatial</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="c1"># Exclude retreat‐event timestamps</span>
<span class="n">df_spatial</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df_spatial</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">])</span>
<span class="n">social_retreat_df</span><span class="p">[</span><span class="s2">&quot;start_timestamp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span>
    <span class="n">social_retreat_df</span><span class="p">[</span><span class="s2">&quot;start_timestamp&quot;</span><span class="p">]</span>
<span class="p">)</span>
<span class="n">social_retreat_df</span><span class="p">[</span><span class="s2">&quot;end_timestamp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">social_retreat_df</span><span class="p">[</span><span class="s2">&quot;end_timestamp&quot;</span><span class="p">])</span>

<span class="c1"># Build a mask for any retreat interval</span>
<span class="n">mask_retreat</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">df_spatial</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
    <span class="n">social_retreat_df</span><span class="p">[</span><span class="s2">&quot;start_timestamp&quot;</span><span class="p">],</span> <span class="n">social_retreat_df</span><span class="p">[</span><span class="s2">&quot;end_timestamp&quot;</span><span class="p">]</span>
<span class="p">):</span>
    <span class="n">mask_retreat</span> <span class="o">|=</span> <span class="n">df_spatial</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>

<span class="c1"># Final filtered DataFrame</span>
<span class="n">df_filtered</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">df_spatial</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="n">mask_retreat</span><span class="p">]</span>  <span class="c1"># drop retreat frames</span>
    <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;dist2&quot;</span><span class="p">])</span>  <span class="c1"># clean up helper column</span>
    <span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Run proximity and filter durations</span>
<span class="n">starts</span><span class="p">,</span> <span class="n">ends</span> <span class="o">=</span> <span class="n">extract_proximity_periods</span><span class="p">(</span><span class="n">df_filtered</span><span class="p">,</span> <span class="n">DISTANCE_THRESH</span><span class="p">)</span>

<span class="c1"># Compute durations &amp; keep short ones</span>
<span class="n">durations</span> <span class="o">=</span> <span class="p">[(</span><span class="n">e</span> <span class="o">-</span> <span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">starts</span><span class="p">,</span> <span class="n">ends</span><span class="p">)]</span>
<span class="n">periods</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">starts</span><span class="p">,</span> <span class="n">ends</span><span class="p">,</span> <span class="n">durations</span><span class="p">)</span> <span class="k">if</span> <span class="n">MIN_DUR</span> <span class="o">&lt;</span> <span class="n">d</span> <span class="o">&lt;</span> <span class="n">MAX_DUR</span>
<span class="p">]</span>
<span class="n">periods</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

<span class="n">filtered_starts</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">periods</span><span class="p">]</span>
<span class="n">filtered_ends</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">periods</span><span class="p">]</span>
<span class="n">filtered_durations</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">periods</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<section id="load-data">
<h3>Load data<a class="headerlink" href="#load-data" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">social_retreat_df_all_exps</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">social_fight_df_all_exps</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">social_patchinfo_df_all_exps</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">social_patch_df_all_exps</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">pbar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span>
    <span class="p">[</span><span class="n">experiments</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]],</span>
    <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Loading experiments&quot;</span><span class="p">,</span>
    <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;experiment&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">for</span> <span class="n">exp</span> <span class="ow">in</span> <span class="n">pbar</span><span class="p">:</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">load_experiment_data</span><span class="p">(</span>
        <span class="n">experiment</span><span class="o">=</span><span class="n">exp</span><span class="p">,</span>
        <span class="n">data_dir</span><span class="o">=</span><span class="n">data_dir</span><span class="p">,</span>
        <span class="n">periods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;social&quot;</span><span class="p">],</span>
        <span class="n">data_types</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;retreat&quot;</span><span class="p">,</span> <span class="s2">&quot;fight&quot;</span><span class="p">,</span> <span class="s2">&quot;patchinfo&quot;</span><span class="p">,</span> <span class="s2">&quot;patch&quot;</span><span class="p">],</span>
        <span class="c1"># trim_days=1  # Optional: trim</span>
    <span class="p">)</span>
    <span class="n">df_retreat</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;social_retreat&quot;</span><span class="p">]</span>
    <span class="n">df_fight</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;social_fight&quot;</span><span class="p">]</span>
    <span class="n">social_patchinfo_df</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;social_patchinfo&quot;</span><span class="p">]</span>
    <span class="n">social_patch_df</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;social_patch&quot;</span><span class="p">]</span>
    <span class="n">df_retreat</span><span class="p">[</span><span class="s2">&quot;experiment_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">exp</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
    <span class="n">df_fight</span><span class="p">[</span><span class="s2">&quot;experiment_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">exp</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
    <span class="n">social_retreat_df_all_exps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_retreat</span><span class="p">)</span>
    <span class="n">social_fight_df_all_exps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_fight</span><span class="p">)</span>
    <span class="n">social_patchinfo_df_all_exps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">social_patchinfo_df</span><span class="p">)</span>
    <span class="n">social_patch_df_all_exps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">social_patch_df</span><span class="p">)</span>

<span class="n">social_retreat_df_all_exps</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">social_retreat_df_all_exps</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">social_fight_df_all_exps</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">social_fight_df_all_exps</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">social_patchinfo_df_all_exps</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
    <span class="n">social_patchinfo_df_all_exps</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="n">social_patch_df_all_exps</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">social_patch_df_all_exps</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">tube_test_data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;social0.2-aeon3&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;BAA-1104045&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;pre&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;post&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
        <span class="s2">&quot;BAA-1104047&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;pre&quot;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span> <span class="s2">&quot;post&quot;</span><span class="p">:</span> <span class="mi">9</span><span class="p">},</span>
    <span class="p">},</span>
    <span class="s2">&quot;social0.2-aeon4&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;BAA-1104048&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;pre&quot;</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span> <span class="s2">&quot;post&quot;</span><span class="p">:</span> <span class="mi">8</span><span class="p">},</span>
        <span class="s2">&quot;BAA-1104049&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;pre&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;post&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">},</span>
    <span class="p">},</span>
    <span class="s2">&quot;social0.4-aeon3&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;BAA-1104794&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;pre&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s2">&quot;post&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">},</span>
        <span class="s2">&quot;BAA-1104792&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;pre&quot;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span> <span class="s2">&quot;post&quot;</span><span class="p">:</span> <span class="mi">13</span><span class="p">},</span>
    <span class="p">},</span>
    <span class="s2">&quot;social0.4-aeon4&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;BAA-1104795&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;pre&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s2">&quot;post&quot;</span><span class="p">:</span> <span class="mi">12</span><span class="p">},</span>
        <span class="s2">&quot;BAA-1104797&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;pre&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s2">&quot;post&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">},</span>
    <span class="p">},</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Tube test results, for reference:</strong></p>
<p><strong>SOCIAL 0.2</strong></p>
<p><em>Pre-social tube test results:</em></p>
<ul class="simple">
<li><p>BAA-1104045: 2, BAA-1104047: 8</p></li>
<li><p>BAA-1104048: 7, BAA-1104049: 3</p></li>
</ul>
<p><em>Post-social tube test results:</em></p>
<ul class="simple">
<li><p>BAA-1104045: 1, BAA-1104047: 9</p></li>
<li><p>BAA-1104048: 8, BAA-1104049: 2</p></li>
</ul>
<p><strong>SOCIAL 0.4</strong></p>
<p><em>Pre-social tube test results:</em></p>
<ul class="simple">
<li><p>BAA-1104795: 10, BAA-1104797: 4</p></li>
<li><p>BAA-1104792: 4, BAA-1104794: 12</p></li>
</ul>
<p><em>Post-social tube test results:</em></p>
<ul class="simple">
<li><p>BAA-1104795: 12, BAA-1104797: 3</p></li>
<li><p>BAA-1104792: 2, BAA-1104794: 13</p></li>
</ul>
</section>
<section id="fights-and-retreats-raster-plots">
<h3>1. Fights and retreats raster plots<a class="headerlink" href="#fights-and-retreats-raster-plots" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Build lookup of social_start &amp; compute per-exp offset to align at earliest start-time</span>
<span class="n">exp_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">experiments</span><span class="p">)</span>
<span class="n">exp_df</span><span class="p">[</span><span class="s2">&quot;social_start&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">exp_df</span><span class="p">[</span><span class="s2">&quot;social_start&quot;</span><span class="p">])</span>
<span class="n">exp_df</span><span class="p">[</span><span class="s2">&quot;tod_sec&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">exp_df</span><span class="p">[</span><span class="s2">&quot;social_start&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">hour</span> <span class="o">*</span> <span class="mi">3600</span>
    <span class="o">+</span> <span class="n">exp_df</span><span class="p">[</span><span class="s2">&quot;social_start&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">minute</span> <span class="o">*</span> <span class="mi">60</span>
    <span class="o">+</span> <span class="n">exp_df</span><span class="p">[</span><span class="s2">&quot;social_start&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">second</span>
<span class="p">)</span>

<span class="c1"># Earliest start-time (seconds since midnight)</span>
<span class="n">min_tod</span> <span class="o">=</span> <span class="n">exp_df</span><span class="p">[</span><span class="s2">&quot;tod_sec&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>

<span class="c1"># Offset seconds so each experiment’s Day 0 lines up at min_tod</span>
<span class="n">exp_df</span><span class="p">[</span><span class="s2">&quot;offset_sec&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">exp_df</span><span class="p">[</span><span class="s2">&quot;tod_sec&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">min_tod</span>

<span class="c1"># Compute absolute baseline timestamp per experiment</span>
<span class="n">exp_df</span><span class="p">[</span><span class="s2">&quot;baseline_ts&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">exp_df</span><span class="p">[</span><span class="s2">&quot;social_start&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span>
    <span class="n">exp_df</span><span class="p">[</span><span class="s2">&quot;offset_sec&quot;</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;s&quot;</span>
<span class="p">)</span>
<span class="n">exp_df</span> <span class="o">=</span> <span class="n">exp_df</span><span class="p">[[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;baseline_ts&quot;</span><span class="p">]]</span>

<span class="c1"># Keep original experiment order</span>
<span class="n">exp_order</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">experiments</span><span class="p">]</span>

<span class="n">dark_color</span> <span class="o">=</span> <span class="s2">&quot;#555555&quot;</span>

<span class="c1"># Dataframes and titles to plot</span>
<span class="n">raster_configs</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="n">social_fight_df_all_exps</span><span class="p">,</span> <span class="s2">&quot;Raster Plot: Social Fights&quot;</span><span class="p">,</span> <span class="s2">&quot;fights&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="n">social_retreat_df_all_exps</span><span class="p">,</span> <span class="s2">&quot;Raster Plot: Social Retreats&quot;</span><span class="p">,</span> <span class="s2">&quot;retreats&quot;</span><span class="p">),</span>
<span class="p">]</span>

<span class="c1"># Print aligned Day 0 hour (earliest start-time)</span>
<span class="n">aligned_hour</span> <span class="o">=</span> <span class="n">min_tod</span> <span class="o">//</span> <span class="mi">3600</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Aligned Day 0 starts at hour </span><span class="si">{</span><span class="n">aligned_hour</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Compute global end time across both datasets</span>
<span class="n">all_events</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="n">social_fight_df_all_exps</span><span class="p">[[</span><span class="s2">&quot;experiment_name&quot;</span><span class="p">,</span> <span class="s2">&quot;start_timestamp&quot;</span><span class="p">]],</span>
        <span class="n">social_retreat_df_all_exps</span><span class="p">[[</span><span class="s2">&quot;experiment_name&quot;</span><span class="p">,</span> <span class="s2">&quot;start_timestamp&quot;</span><span class="p">]],</span>
    <span class="p">]</span>
<span class="p">)</span>
<span class="n">all_events</span><span class="p">[</span><span class="s2">&quot;start_timestamp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">all_events</span><span class="p">[</span><span class="s2">&quot;start_timestamp&quot;</span><span class="p">])</span>

<span class="c1"># Merge baseline timestamps</span>
<span class="n">all_events</span> <span class="o">=</span> <span class="n">all_events</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
    <span class="n">exp_df</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="s2">&quot;experiment_name&quot;</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span>
<span class="p">)</span>

<span class="c1"># Compute seconds since baseline</span>
<span class="n">all_events</span><span class="p">[</span><span class="s2">&quot;rel_sec&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">all_events</span><span class="p">[</span><span class="s2">&quot;start_timestamp&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">all_events</span><span class="p">[</span><span class="s2">&quot;baseline_ts&quot;</span><span class="p">]</span>
<span class="p">)</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>

<span class="c1"># Find last event</span>
<span class="n">last</span> <span class="o">=</span> <span class="n">all_events</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">all_events</span><span class="p">[</span><span class="s2">&quot;rel_sec&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()]</span>

<span class="c1"># Compute end day and hour</span>
<span class="n">end_day</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">last</span><span class="p">[</span><span class="s2">&quot;rel_sec&quot;</span><span class="p">]</span> <span class="o">//</span> <span class="mi">86400</span><span class="p">)</span>
<span class="n">end_hour</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">last</span><span class="p">[</span><span class="s2">&quot;rel_sec&quot;</span><span class="p">]</span> <span class="o">%</span> <span class="mi">86400</span><span class="p">)</span> <span class="o">//</span> <span class="mi">3600</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Global end at Day </span><span class="si">{</span><span class="n">end_day</span><span class="si">}</span><span class="s2">, hour </span><span class="si">{</span><span class="n">end_hour</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Plot each raster</span>
<span class="k">for</span> <span class="n">df</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">behavior</span> <span class="ow">in</span> <span class="n">raster_configs</span><span class="p">:</span>
    <span class="n">df2</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s2">&quot;experiment_name&quot;</span><span class="p">,</span> <span class="s2">&quot;start_timestamp&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">df2</span><span class="p">[</span><span class="s2">&quot;start_timestamp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df2</span><span class="p">[</span><span class="s2">&quot;start_timestamp&quot;</span><span class="p">])</span>
    <span class="n">df2</span> <span class="o">=</span> <span class="n">df2</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">exp_df</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="s2">&quot;experiment_name&quot;</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>

    <span class="c1"># Compute rel_days</span>
    <span class="n">df2</span><span class="p">[</span><span class="s2">&quot;rel_days&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">df2</span><span class="p">[</span><span class="s2">&quot;start_timestamp&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df2</span><span class="p">[</span><span class="s2">&quot;baseline_ts&quot;</span><span class="p">]</span>
    <span class="p">)</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">/</span> <span class="mf">86400.0</span>

    <span class="c1"># Enforce experiment ordering</span>
    <span class="n">df2</span><span class="p">[</span><span class="s2">&quot;experiment_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span>
        <span class="n">df2</span><span class="p">[</span><span class="s2">&quot;experiment_name&quot;</span><span class="p">],</span> <span class="n">categories</span><span class="o">=</span><span class="n">exp_order</span><span class="p">,</span> <span class="n">ordered</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>

    <span class="c1"># Draw</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">(</span>
        <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="n">df2</span><span class="p">[</span><span class="s2">&quot;rel_days&quot;</span><span class="p">],</span>
            <span class="n">y</span><span class="o">=</span><span class="n">df2</span><span class="p">[</span><span class="s2">&quot;experiment_name&quot;</span><span class="p">],</span>
            <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;markers&quot;</span><span class="p">,</span>
            <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">symbol</span><span class="o">=</span><span class="s2">&quot;line-ns&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">dark_color</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">line_width</span><span class="o">=</span><span class="mf">1.2</span><span class="p">),</span>
            <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">hovertemplate</span><span class="o">=</span><span class="s2">&quot;Day: %</span><span class="si">{x:.2f}</span><span class="s2">&lt;br&gt;Experiment: %</span><span class="si">{y}</span><span class="s2">&lt;extra&gt;&lt;/extra&gt;&quot;</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">update_yaxes</span><span class="p">(</span>
        <span class="n">autorange</span><span class="o">=</span><span class="s2">&quot;reversed&quot;</span><span class="p">,</span>
        <span class="n">title_text</span><span class="o">=</span><span class="s2">&quot;Experiment&quot;</span><span class="p">,</span>
        <span class="n">showgrid</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">zeroline</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">showline</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">ticks</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">update_xaxes</span><span class="p">(</span>
        <span class="n">title_text</span><span class="o">=</span><span class="s2">&quot;Days since aligned Day 0&quot;</span><span class="p">,</span>
        <span class="n">tick0</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">dtick</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">tickformat</span><span class="o">=</span><span class="s2">&quot;.0f&quot;</span><span class="p">,</span>
        <span class="n">showgrid</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">zeroline</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">showline</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">linecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
        <span class="n">template</span><span class="o">=</span><span class="s2">&quot;simple_white&quot;</span><span class="p">,</span>
        <span class="n">margin</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">l</span><span class="o">=</span><span class="mi">120</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">40</span><span class="p">),</span>
        <span class="n">height</span><span class="o">=</span><span class="mi">100</span> <span class="o">+</span> <span class="mi">20</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">exp_order</span><span class="p">),</span>
        <span class="n">title</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="mf">0.5</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="c1"># pio.write_image(</span>
    <span class="c1">#     fig,</span>
    <span class="c1">#     save_dir / f&quot;{behavior}_raster.svg&quot;,</span>
    <span class="c1">#     format=&quot;svg&quot;</span>
    <span class="c1"># )</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Aligned Day 0 starts at hour 10.0
Global end at Day 14, hour 1
</pre></div>
</div>
<img alt="../../_images/e96321aff968385bafb17448101b413f6dac185853095748c5fd0cb7fcf7349d.png" src="../../_images/e96321aff968385bafb17448101b413f6dac185853095748c5fd0cb7fcf7349d.png" />
<img alt="../../_images/e7313cd65729b27f50e4fa3793ab7186316518b3036218f93f3918cca6acf785.png" src="../../_images/e7313cd65729b27f50e4fa3793ab7186316518b3036218f93f3918cca6acf785.png" />
</div>
</div>
</section>
<section id="proportion-of-retreat-event-wins-over-time-during-social-period">
<h3>2. Proportion of retreat event wins over time during social period<a class="headerlink" href="#proportion-of-retreat-event-wins-over-time-during-social-period" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># NOT SMOOTHED</span>
<span class="c1"># Ensure &#39;end_timestamp&#39; is datetime and extract &#39;date&#39;</span>
<span class="n">social_retreat_df_all_exps</span><span class="p">[</span><span class="s2">&quot;end_timestamp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span>
    <span class="n">social_retreat_df_all_exps</span><span class="p">[</span><span class="s2">&quot;end_timestamp&quot;</span><span class="p">]</span>
<span class="p">)</span>
<span class="n">social_retreat_df_all_exps</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">social_retreat_df_all_exps</span><span class="p">[</span><span class="s2">&quot;end_timestamp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span>

<span class="c1"># Loop over each experiment_name’s subset and build one plot per experiment</span>
<span class="k">for</span> <span class="n">exp_name</span><span class="p">,</span> <span class="n">df_group</span> <span class="ow">in</span> <span class="n">social_retreat_df_all_exps</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;experiment_name&quot;</span><span class="p">):</span>
    <span class="c1"># Compute daily win‐counts per mouse</span>
    <span class="n">wins</span> <span class="o">=</span> <span class="n">df_group</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="s2">&quot;winner_identity&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="c1"># Turn counts into proportions</span>
    <span class="n">proportions</span> <span class="o">=</span> <span class="n">wins</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">wins</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

    <span class="c1"># Melt to long form for plotting</span>
    <span class="n">df_long</span> <span class="o">=</span> <span class="n">proportions</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span>
        <span class="n">id_vars</span><span class="o">=</span><span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="n">var_name</span><span class="o">=</span><span class="s2">&quot;winner_identity&quot;</span><span class="p">,</span> <span class="n">value_name</span><span class="o">=</span><span class="s2">&quot;proportion&quot;</span>
    <span class="p">)</span>

    <span class="c1"># Create and show one figure for this experiment</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">line</span><span class="p">(</span>
        <span class="n">df_long</span><span class="p">,</span>
        <span class="n">x</span><span class="o">=</span><span class="s2">&quot;date&quot;</span><span class="p">,</span>
        <span class="n">y</span><span class="o">=</span><span class="s2">&quot;proportion&quot;</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="s2">&quot;winner_identity&quot;</span><span class="p">,</span>
        <span class="n">markers</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Experiment: </span><span class="si">{</span><span class="n">exp_name</span><span class="si">}</span><span class="s2">&lt;br&gt;Daily Proportion of Victories per Mouse&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
        <span class="n">xaxis_title</span><span class="o">=</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span>
        <span class="n">yaxis_title</span><span class="o">=</span><span class="s2">&quot;Proportion of Victories&quot;</span><span class="p">,</span>
        <span class="n">legend_title</span><span class="o">=</span><span class="s2">&quot;Mouse ID&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/48f54525f909c1a91e390716de9b6345ec7fec85114c2f8f325ef4449c9c51c3.png" src="../../_images/48f54525f909c1a91e390716de9b6345ec7fec85114c2f8f325ef4449c9c51c3.png" />
<img alt="../../_images/17fe816eb1ef6eddcf56ade9bdb4594d2c700223c47031431d6c4418a1183ea9.png" src="../../_images/17fe816eb1ef6eddcf56ade9bdb4594d2c700223c47031431d6c4418a1183ea9.png" />
<img alt="../../_images/82bf14e2ab3dd37212f71106af6d6633bf64a4a38e9b0f17a64d010ab816ae05.png" src="../../_images/82bf14e2ab3dd37212f71106af6d6633bf64a4a38e9b0f17a64d010ab816ae05.png" />
<img alt="../../_images/89d42bff0583a1217e85c1d09cd3c226355e13e31bddeccfa1de3b3bd1f40823.png" src="../../_images/89d42bff0583a1217e85c1d09cd3c226355e13e31bddeccfa1de3b3bd1f40823.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># SMOOTHED</span>
<span class="c1"># Parameters</span>
<span class="n">BIN_HOURS</span> <span class="o">=</span> <span class="mi">6</span>  <span class="c1"># how many hours per bin (e.g. 6, 8, 10, 12, etc.)</span>
<span class="n">SMOOTH_DAYS</span> <span class="o">=</span> <span class="mi">3</span>  <span class="c1"># how many days to smooth over (e.g. 3, 5, 7, etc.)</span>

<span class="c1"># Ensure &#39;end_timestamp&#39; is datetime</span>
<span class="n">social_retreat_df_all_exps</span><span class="p">[</span><span class="s2">&quot;end_timestamp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span>
    <span class="n">social_retreat_df_all_exps</span><span class="p">[</span><span class="s2">&quot;end_timestamp&quot;</span><span class="p">]</span>
<span class="p">)</span>

<span class="c1"># Loop over each experiment_name’s subset and build one plot per experiment</span>
<span class="k">for</span> <span class="n">exp_name</span><span class="p">,</span> <span class="n">df_group</span> <span class="ow">in</span> <span class="n">social_retreat_df_all_exps</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;experiment_name&quot;</span><span class="p">):</span>
    <span class="n">df_group</span> <span class="o">=</span> <span class="n">df_group</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># Compute bin start for each timestamp</span>
    <span class="n">earliest_midnight</span> <span class="o">=</span> <span class="n">df_group</span><span class="p">[</span><span class="s2">&quot;end_timestamp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">normalize</span><span class="p">()</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">bin_size</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="n">BIN_HOURS</span><span class="p">)</span>
    <span class="n">offsets</span> <span class="o">=</span> <span class="n">df_group</span><span class="p">[</span><span class="s2">&quot;end_timestamp&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">earliest_midnight</span>
    <span class="n">n_bins</span> <span class="o">=</span> <span class="p">(</span><span class="n">offsets</span> <span class="o">//</span> <span class="n">bin_size</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">df_group</span><span class="p">[</span><span class="s2">&quot;bin_start&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">earliest_midnight</span> <span class="o">+</span> <span class="n">n_bins</span> <span class="o">*</span> <span class="n">bin_size</span>

    <span class="c1"># Compute win-counts per bin per mouse</span>
    <span class="n">wins</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">df_group</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;bin_start&quot;</span><span class="p">,</span> <span class="s2">&quot;winner_identity&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># Drop bins with zero total wins</span>
    <span class="n">wins</span> <span class="o">=</span> <span class="n">wins</span><span class="p">[</span><span class="n">wins</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Turn counts into proportions</span>
    <span class="n">proportions</span> <span class="o">=</span> <span class="n">wins</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">wins</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

    <span class="c1"># Melt to long form for plotting</span>
    <span class="n">df_long</span> <span class="o">=</span> <span class="n">proportions</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span>
        <span class="n">id_vars</span><span class="o">=</span><span class="s2">&quot;bin_start&quot;</span><span class="p">,</span> <span class="n">var_name</span><span class="o">=</span><span class="s2">&quot;winner_identity&quot;</span><span class="p">,</span> <span class="n">value_name</span><span class="o">=</span><span class="s2">&quot;proportion&quot;</span>
    <span class="p">)</span>

    <span class="c1"># Compute moving average window size (in bins)</span>
    <span class="n">window_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">SMOOTH_DAYS</span> <span class="o">*</span> <span class="mi">24</span><span class="p">)</span> <span class="o">/</span> <span class="n">BIN_HOURS</span><span class="p">)</span>
    <span class="n">window_size</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">window_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Apply centered moving average per mouse</span>
    <span class="n">df_long</span> <span class="o">=</span> <span class="n">df_long</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s2">&quot;winner_identity&quot;</span><span class="p">,</span> <span class="s2">&quot;bin_start&quot;</span><span class="p">])</span>
    <span class="n">df_long</span><span class="p">[</span><span class="s2">&quot;smoothed_prop&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_long</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;winner_identity&quot;</span><span class="p">)[</span>
        <span class="s2">&quot;proportion&quot;</span>
    <span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">window_size</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">min_periods</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="p">)</span>

    <span class="c1"># Create and show one figure for this experiment</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">line</span><span class="p">(</span>
        <span class="n">df_long</span><span class="p">,</span>
        <span class="n">x</span><span class="o">=</span><span class="s2">&quot;bin_start&quot;</span><span class="p">,</span>
        <span class="n">y</span><span class="o">=</span><span class="s2">&quot;smoothed_prop&quot;</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="s2">&quot;winner_identity&quot;</span><span class="p">,</span>
        <span class="n">markers</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Experiment: </span><span class="si">{</span><span class="n">exp_name</span><span class="si">}</span><span class="s2">&lt;br&gt;&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">BIN_HOURS</span><span class="si">}</span><span class="s2">H Bins, </span><span class="si">{</span><span class="n">SMOOTH_DAYS</span><span class="si">}</span><span class="s2">‐Day Moving Average&quot;</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
        <span class="n">xaxis_title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Bin Start (every </span><span class="si">{</span><span class="n">BIN_HOURS</span><span class="si">}</span><span class="s2"> hours from </span><span class="si">{</span><span class="n">earliest_midnight</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
        <span class="n">yaxis_title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">SMOOTH_DAYS</span><span class="si">}</span><span class="s2">‐Day MA of Win Proportion&quot;</span><span class="p">,</span>
        <span class="n">legend_title</span><span class="o">=</span><span class="s2">&quot;Mouse ID&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="c1"># if exp_name == experiments[-1][&#39;name&#39;]:</span>
    <span class="c1"># pio.write_image(</span>
    <span class="c1">#     fig,</span>
    <span class="c1">#     str(save_dir / f&quot;social_retreat_{BIN_HOURS}h_bins_{SMOOTH_DAYS}day_smooth.svg&quot;),</span>
    <span class="c1">#     format=&quot;svg&quot;</span>
    <span class="c1"># )</span>

<span class="c1"># Compute average number of retreat events per experiment-day</span>
<span class="n">social_retreat_df_all_exps</span><span class="p">[</span><span class="s2">&quot;start_timestamp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span>
    <span class="n">social_retreat_df_all_exps</span><span class="p">[</span><span class="s2">&quot;start_timestamp&quot;</span><span class="p">]</span>
<span class="p">)</span>
<span class="c1"># Extract day from timestamp</span>
<span class="n">social_retreat_df_all_exps</span><span class="p">[</span><span class="s2">&quot;day&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">social_retreat_df_all_exps</span><span class="p">[</span>
    <span class="s2">&quot;start_timestamp&quot;</span>
<span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="s2">&quot;D&quot;</span><span class="p">)</span>
<span class="c1"># Count events per (experiment, day)</span>
<span class="n">daily_counts</span> <span class="o">=</span> <span class="n">social_retreat_df_all_exps</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;experiment_name&quot;</span><span class="p">,</span> <span class="s2">&quot;day&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
<span class="c1"># Compute global average</span>
<span class="n">avg_events_per_day</span> <span class="o">=</span> <span class="n">daily_counts</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Average number of retreat events per experiment-day: </span><span class="si">{</span><span class="n">avg_events_per_day</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/e680ca85a7466556ee4958d4f6f05f274170a9a6e20f357919fb4a181c2fd870.png" src="../../_images/e680ca85a7466556ee4958d4f6f05f274170a9a6e20f357919fb4a181c2fd870.png" />
<img alt="../../_images/4bb3d477c2e0b27320f3adbf4c3901912d5d87a7de970606f9f9f8cd129d0781.png" src="../../_images/4bb3d477c2e0b27320f3adbf4c3901912d5d87a7de970606f9f9f8cd129d0781.png" />
<img alt="../../_images/d2f99e4d3258ac35b5acee3fe926484b6c932e2d637af8020bd38514f64e432f.png" src="../../_images/d2f99e4d3258ac35b5acee3fe926484b6c932e2d637af8020bd38514f64e432f.png" />
<img alt="../../_images/0cec5b0882ff8fa4359bbcafd46d483b932f2f2894537f227d3ca9d836d01c91.png" src="../../_images/0cec5b0882ff8fa4359bbcafd46d483b932f2f2894537f227d3ca9d836d01c91.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Average number of retreat events per experiment-day: 9.89
</pre></div>
</div>
</div>
</div>
</section>
<section id="pre-during-post-tube-test-comparison">
<h3>3. Pre/during/post tube test comparison<a class="headerlink" href="#pre-during-post-tube-test-comparison" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Total win counts per subject during social phase</span>
<span class="n">social_counts_df</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">social_retreat_df_all_exps</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;experiment_name&quot;</span><span class="p">,</span> <span class="s2">&quot;winner_identity&quot;</span><span class="p">])</span>
    <span class="o">.</span><span class="n">size</span><span class="p">()</span>
    <span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="p">)</span>

<span class="c1"># Compute per-experiment summary metrics for dominant subject</span>
<span class="n">records</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">exp</span><span class="p">,</span> <span class="n">subj_dict</span> <span class="ow">in</span> <span class="n">tube_test_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">soc_counts</span> <span class="o">=</span> <span class="n">social_counts_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">exp</span><span class="p">]</span>
    <span class="n">total_pre</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;pre&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">subj_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    <span class="n">total_post</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;post&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">subj_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    <span class="n">total_soc</span> <span class="o">=</span> <span class="n">soc_counts</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="c1"># Identify dominant by total wins across all phases</span>
    <span class="n">total_wins</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">subj</span><span class="p">:</span> <span class="n">subj_dict</span><span class="p">[</span><span class="n">subj</span><span class="p">][</span><span class="s2">&quot;pre&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">soc_counts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">subj</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">subj_dict</span><span class="p">[</span><span class="n">subj</span><span class="p">][</span><span class="s2">&quot;post&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">subj</span> <span class="ow">in</span> <span class="n">subj_dict</span>
    <span class="p">}</span>
    <span class="n">dominant</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">total_wins</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">total_wins</span><span class="o">.</span><span class="n">get</span><span class="p">)</span>

    <span class="c1"># Compute win rates for dominant subject</span>
    <span class="n">pre_rate</span> <span class="o">=</span> <span class="n">subj_dict</span><span class="p">[</span><span class="n">dominant</span><span class="p">][</span><span class="s2">&quot;pre&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">total_pre</span>
    <span class="n">social_rate</span> <span class="o">=</span> <span class="n">soc_counts</span><span class="p">[</span><span class="n">dominant</span><span class="p">]</span> <span class="o">/</span> <span class="n">total_soc</span>
    <span class="n">post_rate</span> <span class="o">=</span> <span class="n">subj_dict</span><span class="p">[</span><span class="n">dominant</span><span class="p">][</span><span class="s2">&quot;post&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">total_post</span>
    <span class="n">baseline_rate</span> <span class="o">=</span> <span class="p">(</span><span class="n">subj_dict</span><span class="p">[</span><span class="n">dominant</span><span class="p">][</span><span class="s2">&quot;pre&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">subj_dict</span><span class="p">[</span><span class="n">dominant</span><span class="p">][</span><span class="s2">&quot;post&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span>
        <span class="n">total_pre</span> <span class="o">+</span> <span class="n">total_post</span>
    <span class="p">)</span>

    <span class="n">records</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s2">&quot;experiment&quot;</span><span class="p">:</span> <span class="n">exp</span><span class="p">,</span>
            <span class="s2">&quot;dominant&quot;</span><span class="p">:</span> <span class="n">dominant</span><span class="p">,</span>
            <span class="s2">&quot;pre_rate&quot;</span><span class="p">:</span> <span class="n">pre_rate</span><span class="p">,</span>
            <span class="s2">&quot;social_rate&quot;</span><span class="p">:</span> <span class="n">social_rate</span><span class="p">,</span>
            <span class="s2">&quot;post_rate&quot;</span><span class="p">:</span> <span class="n">post_rate</span><span class="p">,</span>
            <span class="s2">&quot;baseline_rate&quot;</span><span class="p">:</span> <span class="n">baseline_rate</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">)</span>

<span class="n">summary_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">records</span><span class="p">)</span>

<span class="c1"># Test: is social-phase rate higher than pre+post (Wilcoxon signed-rank)</span>
<span class="n">stat</span><span class="p">,</span> <span class="n">p_value</span> <span class="o">=</span> <span class="n">wilcoxon</span><span class="p">(</span><span class="n">summary_df</span><span class="p">[</span><span class="s2">&quot;baseline_rate&quot;</span><span class="p">],</span> <span class="n">summary_df</span><span class="p">[</span><span class="s2">&quot;social_rate&quot;</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Wilcoxon signed-rank: W = </span><span class="si">{</span><span class="n">stat</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, p-value = </span><span class="si">{</span><span class="n">p_value</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Per-experiment plotting and binomial tests</span>
<span class="n">x_positions</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
<span class="n">x_labels</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Tube test (pre)&quot;</span><span class="p">,</span> <span class="s2">&quot;Two weeks foraging&quot;</span><span class="p">,</span> <span class="s2">&quot;Tube test (post)&quot;</span><span class="p">]</span>

<span class="k">for</span> <span class="n">experiment</span><span class="p">,</span> <span class="n">subjects</span> <span class="ow">in</span> <span class="n">tube_test_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">subjects</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">pre_scores</span> <span class="o">=</span> <span class="p">{</span><span class="n">s</span><span class="p">:</span> <span class="n">subjects</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="s2">&quot;pre&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">}</span>
    <span class="n">post_scores</span> <span class="o">=</span> <span class="p">{</span><span class="n">s</span><span class="p">:</span> <span class="n">subjects</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="s2">&quot;post&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">}</span>
    <span class="n">soc_counts</span> <span class="o">=</span> <span class="n">social_counts_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">experiment</span><span class="p">]</span>

    <span class="c1"># Identify dominant and subordinate</span>
    <span class="n">dominant</span> <span class="o">=</span> <span class="n">summary_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">summary_df</span><span class="p">[</span><span class="s2">&quot;experiment&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">experiment</span><span class="p">,</span> <span class="s2">&quot;dominant&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span>
        <span class="mi">0</span>
    <span class="p">]</span>
    <span class="n">subordinate</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">ids</span> <span class="k">if</span> <span class="n">s</span> <span class="o">!=</span> <span class="n">dominant</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Win/loss counts</span>
    <span class="n">k_pre</span> <span class="o">=</span> <span class="n">pre_scores</span><span class="p">[</span><span class="n">dominant</span><span class="p">]</span>
    <span class="n">n_pre</span> <span class="o">=</span> <span class="n">k_pre</span> <span class="o">+</span> <span class="n">pre_scores</span><span class="p">[</span><span class="n">subordinate</span><span class="p">]</span>
    <span class="n">k_post</span> <span class="o">=</span> <span class="n">post_scores</span><span class="p">[</span><span class="n">dominant</span><span class="p">]</span>
    <span class="n">n_post</span> <span class="o">=</span> <span class="n">k_post</span> <span class="o">+</span> <span class="n">post_scores</span><span class="p">[</span><span class="n">subordinate</span><span class="p">]</span>
    <span class="n">k_social</span> <span class="o">=</span> <span class="n">soc_counts</span><span class="p">[</span><span class="n">dominant</span><span class="p">]</span>
    <span class="n">n_social</span> <span class="o">=</span> <span class="n">soc_counts</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="c1"># Binomial tests (one-sided: dominant &gt; 50%)</span>
    <span class="n">k_pool</span> <span class="o">=</span> <span class="n">k_pre</span> <span class="o">+</span> <span class="n">k_post</span>
    <span class="n">n_pool</span> <span class="o">=</span> <span class="n">n_pre</span> <span class="o">+</span> <span class="n">n_post</span>
    <span class="n">p_pool</span> <span class="o">=</span> <span class="n">binomtest</span><span class="p">(</span><span class="n">k_pool</span><span class="p">,</span> <span class="n">n_pool</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">alternative</span><span class="o">=</span><span class="s2">&quot;greater&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">pvalue</span>
    <span class="n">p_social</span> <span class="o">=</span> <span class="n">binomtest</span><span class="p">(</span><span class="n">k_social</span><span class="p">,</span> <span class="n">n_social</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">alternative</span><span class="o">=</span><span class="s2">&quot;greater&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">pvalue</span>

    <span class="c1"># Print results</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=== </span><span class="si">{</span><span class="n">experiment</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">dominant</span><span class="si">}</span><span class="s2"> dominant) ===&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pooled Pre+Post: wins=</span><span class="si">{</span><span class="n">k_pool</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">n_pool</span><span class="si">}</span><span class="s2"> → binom p=</span><span class="si">{</span><span class="n">p_pool</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Social:          wins=</span><span class="si">{</span><span class="n">k_social</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">n_social</span><span class="si">}</span><span class="s2"> → binom p=</span><span class="si">{</span><span class="n">p_social</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Plot win rates for both mice</span>
    <span class="n">proportions</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">dominant</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;pre&quot;</span><span class="p">:</span> <span class="n">k_pre</span> <span class="o">/</span> <span class="n">n_pre</span><span class="p">,</span>
            <span class="s2">&quot;social&quot;</span><span class="p">:</span> <span class="n">k_social</span> <span class="o">/</span> <span class="n">n_social</span><span class="p">,</span>
            <span class="s2">&quot;post&quot;</span><span class="p">:</span> <span class="n">k_post</span> <span class="o">/</span> <span class="n">n_post</span><span class="p">,</span>
            <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;gold&quot;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="n">subordinate</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;pre&quot;</span><span class="p">:</span> <span class="n">pre_scores</span><span class="p">[</span><span class="n">subordinate</span><span class="p">]</span> <span class="o">/</span> <span class="n">n_pre</span><span class="p">,</span>
            <span class="s2">&quot;social&quot;</span><span class="p">:</span> <span class="n">soc_counts</span><span class="p">[</span><span class="n">subordinate</span><span class="p">]</span> <span class="o">/</span> <span class="n">n_social</span><span class="p">,</span>
            <span class="s2">&quot;post&quot;</span><span class="p">:</span> <span class="n">post_scores</span><span class="p">[</span><span class="n">subordinate</span><span class="p">]</span> <span class="o">/</span> <span class="n">n_post</span><span class="p">,</span>
            <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;brown&quot;</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">}</span>

    <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">subj</span><span class="p">,</span> <span class="n">vals</span> <span class="ow">in</span> <span class="n">proportions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">x_positions</span><span class="p">):</span>
            <span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="n">vals</span><span class="p">[</span><span class="s2">&quot;pre&quot;</span><span class="p">],</span> <span class="n">vals</span><span class="p">[</span><span class="s2">&quot;social&quot;</span><span class="p">],</span> <span class="n">vals</span><span class="p">[</span><span class="s2">&quot;post&quot;</span><span class="p">]][</span><span class="n">i</span><span class="p">]</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
                <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
                    <span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">],</span>
                    <span class="n">y</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">y</span><span class="p">],</span>
                    <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;lines+markers&quot;</span><span class="p">,</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">subj</span><span class="p">,</span>
                    <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">vals</span><span class="p">[</span><span class="s2">&quot;color&quot;</span><span class="p">]),</span>
                    <span class="n">showlegend</span><span class="o">=</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">),</span>
                <span class="p">)</span>
            <span class="p">)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
        <span class="n">title</span><span class="o">=</span><span class="n">experiment</span><span class="p">,</span>
        <span class="n">plot_bgcolor</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span>
        <span class="n">width</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span>
        <span class="n">height</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span>
        <span class="n">xaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">tickvals</span><span class="o">=</span><span class="n">x_positions</span><span class="p">,</span> <span class="n">ticktext</span><span class="o">=</span><span class="n">x_labels</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">]),</span>
        <span class="n">yaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
            <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Proportion of victories&quot;</span><span class="p">,</span>
            <span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
            <span class="n">ticks</span><span class="o">=</span><span class="s2">&quot;outside&quot;</span><span class="p">,</span>
            <span class="n">ticklen</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
            <span class="n">tickwidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">showline</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">linecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="c1"># if experiment == experiments[-1][&#39;name&#39;]:</span>
    <span class="c1">#     pio.write_image(</span>
    <span class="c1">#         fig,</span>
    <span class="c1">#         str(save_dir / f&quot;tube_test_win_rates.svg&quot;),</span>
    <span class="c1">#         format=&quot;svg&quot;</span>
    <span class="c1">#     )</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Wilcoxon signed-rank: W = 2.000, p-value = 0.375


=== social0.2-aeon3 (BAA-1104047 dominant) ===
Pooled Pre+Post: wins=17/20 → binom p=0.001
Social:          wins=35/55 → binom p=0.029
</pre></div>
</div>
<img alt="../../_images/9ab99b95b856e2eb4ebad7687967e366f06617925bde67fc3b36ad87215c6c14.png" src="../../_images/9ab99b95b856e2eb4ebad7687967e366f06617925bde67fc3b36ad87215c6c14.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>=== social0.2-aeon4 (BAA-1104048 dominant) ===
Pooled Pre+Post: wins=15/20 → binom p=0.021
Social:          wins=183/251 → binom p=0.000
</pre></div>
</div>
<img alt="../../_images/3c568f20e80309f30e64b962cc9aa11bdcaabc5e59c11239fa2b4aedc5130afe.png" src="../../_images/3c568f20e80309f30e64b962cc9aa11bdcaabc5e59c11239fa2b4aedc5130afe.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>=== social0.4-aeon3 (BAA-1104792 dominant) ===
Pooled Pre+Post: wins=25/31 → binom p=0.000
Social:          wins=47/66 → binom p=0.000
</pre></div>
</div>
<img alt="../../_images/57e7adc20bf58df8ff0a448988c46ddf2e44cd9d7187a9b52fbe1e3c789b1c9c.png" src="../../_images/57e7adc20bf58df8ff0a448988c46ddf2e44cd9d7187a9b52fbe1e3c789b1c9c.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>=== social0.4-aeon4 (BAA-1104795 dominant) ===
Pooled Pre+Post: wins=22/29 → binom p=0.004
Social:          wins=139/172 → binom p=0.000
</pre></div>
</div>
<img alt="../../_images/c53be42d86e2e465ea7e7625e2c811cf1506056f1b075aabd8cb5a702fc3bb62.png" src="../../_images/c53be42d86e2e465ea7e7625e2c811cf1506056f1b075aabd8cb5a702fc3bb62.png" />
</div>
</div>
</section>
<section id="dominance-summary-plot">
<h3>4. Dominance summary plot<a class="headerlink" href="#dominance-summary-plot" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">social_win_proportions</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">social_retreat_df_all_exps</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;experiment_name&quot;</span><span class="p">,</span> <span class="s2">&quot;winner_identity&quot;</span><span class="p">])</span>
    <span class="o">.</span><span class="n">size</span><span class="p">()</span>
    <span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">social_win_proportions</span> <span class="o">=</span> <span class="n">social_win_proportions</span><span class="o">.</span><span class="n">div</span><span class="p">(</span>
    <span class="n">social_win_proportions</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span>
<span class="p">)</span>

<span class="c1"># Define plot</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>
<span class="n">legend_labels_added</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;gold&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;brown&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>

<span class="k">for</span> <span class="n">experiment</span><span class="p">,</span> <span class="n">subjects</span> <span class="ow">in</span> <span class="n">tube_test_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">subjects</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">pre_scores</span> <span class="o">=</span> <span class="p">{</span><span class="n">subj</span><span class="p">:</span> <span class="n">subjects</span><span class="p">[</span><span class="n">subj</span><span class="p">][</span><span class="s2">&quot;pre&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">subj</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">}</span>
    <span class="n">post_scores</span> <span class="o">=</span> <span class="p">{</span><span class="n">subj</span><span class="p">:</span> <span class="n">subjects</span><span class="p">[</span><span class="n">subj</span><span class="p">][</span><span class="s2">&quot;post&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">subj</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">}</span>

    <span class="n">pre_dominant</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">pre_scores</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">pre_scores</span><span class="o">.</span><span class="n">get</span><span class="p">)</span>
    <span class="n">post_dominant</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">post_scores</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">post_scores</span><span class="o">.</span><span class="n">get</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">experiment</span> <span class="ow">in</span> <span class="n">social_win_proportions</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
        <span class="n">social_scores</span> <span class="o">=</span> <span class="n">social_win_proportions</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">experiment</span><span class="p">]</span>
        <span class="n">social_dominant</span> <span class="o">=</span> <span class="n">social_scores</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No social data for </span><span class="si">{</span><span class="n">experiment</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">({</span><span class="n">pre_dominant</span><span class="p">,</span> <span class="n">post_dominant</span><span class="p">,</span> <span class="n">social_dominant</span><span class="p">})</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Inconsistent dominant subject in </span><span class="si">{</span><span class="n">experiment</span><span class="si">}</span><span class="s2">: pre=</span><span class="si">{</span><span class="n">pre_dominant</span><span class="si">}</span><span class="s2">, social=</span><span class="si">{</span><span class="n">social_dominant</span><span class="si">}</span><span class="s2">, post=</span><span class="si">{</span><span class="n">post_dominant</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="n">dominant</span> <span class="o">=</span> <span class="n">pre_dominant</span>
    <span class="n">subordinate</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">ids</span> <span class="k">if</span> <span class="n">s</span> <span class="o">!=</span> <span class="n">dominant</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">total_pre</span> <span class="o">=</span> <span class="n">pre_scores</span><span class="p">[</span><span class="n">dominant</span><span class="p">]</span> <span class="o">+</span> <span class="n">pre_scores</span><span class="p">[</span><span class="n">subordinate</span><span class="p">]</span>
    <span class="n">total_post</span> <span class="o">=</span> <span class="n">post_scores</span><span class="p">[</span><span class="n">dominant</span><span class="p">]</span> <span class="o">+</span> <span class="n">post_scores</span><span class="p">[</span><span class="n">subordinate</span><span class="p">]</span>

    <span class="n">social_dom</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">social_win_proportions</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">experiment</span><span class="p">,</span> <span class="n">dominant</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">dominant</span> <span class="ow">in</span> <span class="n">social_win_proportions</span><span class="o">.</span><span class="n">columns</span>
        <span class="k">else</span> <span class="mi">0</span>
    <span class="p">)</span>
    <span class="n">social_sub</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">social_win_proportions</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">experiment</span><span class="p">,</span> <span class="n">subordinate</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">subordinate</span> <span class="ow">in</span> <span class="n">social_win_proportions</span><span class="o">.</span><span class="n">columns</span>
        <span class="k">else</span> <span class="mi">0</span>
    <span class="p">)</span>

    <span class="n">proportions</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">dominant</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;pre&quot;</span><span class="p">:</span> <span class="o">-</span><span class="n">pre_scores</span><span class="p">[</span><span class="n">dominant</span><span class="p">]</span> <span class="o">/</span> <span class="n">total_pre</span><span class="p">,</span>
            <span class="s2">&quot;post&quot;</span><span class="p">:</span> <span class="n">post_scores</span><span class="p">[</span><span class="n">dominant</span><span class="p">]</span> <span class="o">/</span> <span class="n">total_post</span><span class="p">,</span>
            <span class="s2">&quot;social&quot;</span><span class="p">:</span> <span class="o">-</span><span class="n">social_dom</span><span class="p">,</span>
            <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;gold&quot;</span><span class="p">,</span>
            <span class="s2">&quot;legend&quot;</span><span class="p">:</span> <span class="s2">&quot;Dominant&quot;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="n">subordinate</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;pre&quot;</span><span class="p">:</span> <span class="o">-</span><span class="n">pre_scores</span><span class="p">[</span><span class="n">subordinate</span><span class="p">]</span> <span class="o">/</span> <span class="n">total_pre</span><span class="p">,</span>
            <span class="s2">&quot;post&quot;</span><span class="p">:</span> <span class="n">post_scores</span><span class="p">[</span><span class="n">subordinate</span><span class="p">]</span> <span class="o">/</span> <span class="n">total_post</span><span class="p">,</span>
            <span class="s2">&quot;social&quot;</span><span class="p">:</span> <span class="o">-</span><span class="n">social_sub</span><span class="p">,</span>
            <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;brown&quot;</span><span class="p">,</span>
            <span class="s2">&quot;legend&quot;</span><span class="p">:</span> <span class="s2">&quot;Subordinate&quot;</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="n">subj</span><span class="p">,</span> <span class="n">vals</span> <span class="ow">in</span> <span class="n">proportions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">color</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="s2">&quot;color&quot;</span><span class="p">]</span>
        <span class="n">legend_name</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="s2">&quot;legend&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">legend_labels_added</span><span class="p">[</span><span class="n">color</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">legend_labels_added</span><span class="p">[</span><span class="n">color</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Pre point</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
            <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
                <span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="n">vals</span><span class="p">[</span><span class="s2">&quot;pre&quot;</span><span class="p">]],</span>
                <span class="n">y</span><span class="o">=</span><span class="p">[</span><span class="n">vals</span><span class="p">[</span><span class="s2">&quot;social&quot;</span><span class="p">]],</span>
                <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;markers&quot;</span><span class="p">,</span>
                <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">10</span><span class="p">),</span>
                <span class="n">name</span><span class="o">=</span><span class="n">legend_name</span><span class="p">,</span>
                <span class="n">showlegend</span><span class="o">=</span><span class="n">legend_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Post point</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
            <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
                <span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="n">vals</span><span class="p">[</span><span class="s2">&quot;post&quot;</span><span class="p">]],</span>
                <span class="n">y</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="n">vals</span><span class="p">[</span><span class="s2">&quot;social&quot;</span><span class="p">]],</span>
                <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;markers&quot;</span><span class="p">,</span>
                <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">10</span><span class="p">),</span>
                <span class="n">name</span><span class="o">=</span><span class="n">legend_name</span><span class="p">,</span>
                <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

<span class="c1"># Final layout</span>
<span class="c1"># Hide everything</span>
<span class="n">fig</span><span class="o">.</span><span class="n">update_xaxes</span><span class="p">(</span>
    <span class="n">showgrid</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">showline</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">zeroline</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">showticklabels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ticks</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
<span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">update_yaxes</span><span class="p">(</span>
    <span class="n">showgrid</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">showline</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">zeroline</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">showticklabels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ticks</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
<span class="p">)</span>

<span class="c1"># Draw the two axes as black lines</span>
<span class="n">fig</span><span class="o">.</span><span class="n">add_shape</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s2">&quot;line&quot;</span><span class="p">,</span> <span class="n">x0</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">x1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">y0</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">y1</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
<span class="n">fig</span><span class="o">.</span><span class="n">add_shape</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s2">&quot;line&quot;</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">x1</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">y0</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">y1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

<span class="c1"># Draw little ticks at ±1</span>
<span class="n">tick_len</span> <span class="o">=</span> <span class="mf">0.02</span>
<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
    <span class="c1"># x‐axis tick</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">add_shape</span><span class="p">(</span>
        <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;line&quot;</span><span class="p">,</span>
        <span class="n">x0</span><span class="o">=</span><span class="n">t</span><span class="p">,</span>
        <span class="n">x1</span><span class="o">=</span><span class="n">t</span><span class="p">,</span>
        <span class="n">y0</span><span class="o">=-</span><span class="n">tick_len</span><span class="p">,</span>
        <span class="n">y1</span><span class="o">=+</span><span class="n">tick_len</span><span class="p">,</span>
        <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="c1"># y‐axis tick</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">add_shape</span><span class="p">(</span>
        <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;line&quot;</span><span class="p">,</span>
        <span class="n">x0</span><span class="o">=-</span><span class="n">tick_len</span><span class="p">,</span>
        <span class="n">x1</span><span class="o">=+</span><span class="n">tick_len</span><span class="p">,</span>
        <span class="n">y0</span><span class="o">=</span><span class="n">t</span><span class="p">,</span>
        <span class="n">y1</span><span class="o">=</span><span class="n">t</span><span class="p">,</span>
        <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
    <span class="p">)</span>

<span class="c1"># Annotate labels at ±1</span>
<span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">txt</span> <span class="ow">in</span> <span class="p">[(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;−1&quot;</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">)]:</span>
    <span class="c1"># x‐axis label</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">add_annotation</span><span class="p">(</span>
        <span class="n">x</span><span class="o">=</span><span class="n">t</span><span class="p">,</span>
        <span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">text</span><span class="o">=</span><span class="n">txt</span><span class="p">,</span>
        <span class="n">yshift</span><span class="o">=-</span><span class="mi">16</span><span class="p">,</span>  <span class="c1"># move it down in px</span>
        <span class="n">showarrow</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">font</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">14</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="c1"># y‐axis label</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">add_annotation</span><span class="p">(</span>
        <span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">y</span><span class="o">=</span><span class="n">t</span><span class="p">,</span>
        <span class="n">text</span><span class="o">=</span><span class="n">txt</span><span class="p">,</span>
        <span class="n">xshift</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>  <span class="c1"># move it left in px</span>
        <span class="n">showarrow</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">font</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">14</span><span class="p">),</span>
    <span class="p">)</span>

<span class="c1"># Finally, re-add title &amp; legend layout</span>
<span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Pre vs Post Tube Test (Reflected by Social Proportion)&quot;</span><span class="p">,</span>
    <span class="n">plot_bgcolor</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span>
    <span class="n">width</span><span class="o">=</span><span class="mi">700</span><span class="p">,</span>
    <span class="n">height</span><span class="o">=</span><span class="mi">700</span><span class="p">,</span>
    <span class="n">legend</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;Subject role&quot;</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s2">&quot;v&quot;</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="mf">1.02</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
<span class="p">)</span>

<span class="c1"># Draw y=x as a dashed grey line (behind the points)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">add_shape</span><span class="p">(</span>
    <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;line&quot;</span><span class="p">,</span>
    <span class="n">x0</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">y0</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">x1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">y1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;lightgrey&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dash</span><span class="o">=</span><span class="s2">&quot;dash&quot;</span><span class="p">),</span>
    <span class="n">layer</span><span class="o">=</span><span class="s2">&quot;below&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Re-add title, legend, and now axis titles</span>
<span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Pre vs Post Tube Test (Reflected by Social Proportion)&quot;</span><span class="p">,</span>
    <span class="n">xaxis_title</span><span class="o">=</span><span class="s2">&quot;Tube test victory proportion (−pre, +post)&quot;</span><span class="p">,</span>
    <span class="n">yaxis_title</span><span class="o">=</span><span class="s2">&quot;Social phase proportion (−plotted pre, +plotted post)&quot;</span><span class="p">,</span>
    <span class="n">plot_bgcolor</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span>
    <span class="n">width</span><span class="o">=</span><span class="mi">700</span><span class="p">,</span>
    <span class="n">height</span><span class="o">=</span><span class="mi">700</span><span class="p">,</span>
    <span class="n">legend</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;Subject role&quot;</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s2">&quot;v&quot;</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="mf">1.02</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
<span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># pio.write_image(</span>
<span class="c1">#     fig,</span>
<span class="c1">#     str(save_dir / &quot;tube_test_scatter.svg&quot;),</span>
<span class="c1">#     format=&quot;svg&quot;</span>
<span class="c1"># )</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/2f6d5a8aeecfe6739ccca57c9421b777a96218659f54a34763583716f7e85805.png" src="../../_images/2f6d5a8aeecfe6739ccca57c9421b777a96218659f54a34763583716f7e85805.png" />
</div>
</div>
</section>
<section id="dominant-vs-subordinate-comparison-of-time-spent-and-distance-spun-at-best-patch">
<h3>5. Dominant vs subordinate comparison of time spent and distance spun at best patch<a class="headerlink" href="#dominant-vs-subordinate-comparison-of-time-spent-and-distance-spun-at-best-patch" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">social_patch_df_all_exps</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
    <span class="n">social_patchinfo_df_all_exps</span><span class="p">[</span>
        <span class="p">[</span><span class="s2">&quot;experiment_name&quot;</span><span class="p">,</span> <span class="s2">&quot;block_start&quot;</span><span class="p">,</span> <span class="s2">&quot;patch_name&quot;</span><span class="p">,</span> <span class="s2">&quot;patch_rate&quot;</span><span class="p">]</span>
    <span class="p">],</span>
    <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;experiment_name&quot;</span><span class="p">,</span> <span class="s2">&quot;block_start&quot;</span><span class="p">,</span> <span class="s2">&quot;patch_name&quot;</span><span class="p">],</span>
    <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
<span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">dummy</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;patch_name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">&quot;dummy&quot;</span><span class="p">,</span> <span class="n">case</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

<span class="c1"># Keep only blocks where non-dummy patches have exactly 3 different rates</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span>
    <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;experiment_name&quot;</span><span class="p">,</span> <span class="s2">&quot;block_start&quot;</span><span class="p">])[</span><span class="s2">&quot;patch_rate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span><span class="p">[</span><span class="o">~</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s2">&quot;dummy&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span> <span class="o">==</span> <span class="mi">3</span>
    <span class="p">)</span>
<span class="p">]</span>

<span class="c1"># Create a ranking only for non-dummy patches</span>
<span class="n">non_dummy_ranks</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">df</span><span class="p">[</span><span class="o">~</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;dummy&quot;</span><span class="p">]]</span>
    <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;experiment_name&quot;</span><span class="p">,</span> <span class="s2">&quot;block_start&quot;</span><span class="p">])[</span><span class="s2">&quot;patch_rate&quot;</span><span class="p">]</span>
    <span class="o">.</span><span class="n">rank</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s2">&quot;dense&quot;</span><span class="p">)</span>
<span class="p">)</span>

<span class="c1"># Add the ranks back to the full dataframe</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;patch_rank&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
<span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;dummy&quot;</span><span class="p">],</span> <span class="s2">&quot;patch_rank&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">non_dummy_ranks</span>

<span class="c1"># Assign difficulty (rank 1=hard, rank 3=easy, rank 2=medium)</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;patch_difficulty&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;dummy&quot;</span><span class="p">],</span>
    <span class="s2">&quot;dummy&quot;</span><span class="p">,</span>
    <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;patch_rank&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;hard&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;patch_rank&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;easy&quot;</span><span class="p">,</span> <span class="s2">&quot;medium&quot;</span><span class="p">)</span>
    <span class="p">),</span>
<span class="p">)</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;patch_rank&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute social‐win proportions</span>
<span class="n">swp</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">social_retreat_df_all_exps</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;experiment_name&quot;</span><span class="p">,</span> <span class="s2">&quot;winner_identity&quot;</span><span class="p">])</span>
    <span class="o">.</span><span class="n">size</span><span class="p">()</span>
    <span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">swp</span> <span class="o">=</span> <span class="n">swp</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">swp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># Build the dominance DataFrame in one comprehension</span>
<span class="n">dominance_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&quot;experiment_name&quot;</span><span class="p">:</span> <span class="n">exp</span><span class="p">,</span>
            <span class="s2">&quot;dominant&quot;</span><span class="p">:</span> <span class="n">dom</span><span class="p">,</span>
            <span class="s2">&quot;subordinate&quot;</span><span class="p">:</span> <span class="nb">next</span><span class="p">(</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">subs</span> <span class="k">if</span> <span class="n">s</span> <span class="o">!=</span> <span class="n">dom</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="n">exp</span><span class="p">,</span> <span class="n">subs</span> <span class="ow">in</span> <span class="n">tube_test_data</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">exp</span> <span class="ow">in</span> <span class="n">swp</span><span class="o">.</span><span class="n">index</span>
        <span class="c1"># pick the pre‐tube top scorer…</span>
        <span class="k">for</span> <span class="n">dom</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="n">subs</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">subs</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="s2">&quot;pre&quot;</span><span class="p">])]</span>
        <span class="c1"># …only keep if post‐tube and social‐win agree</span>
        <span class="k">if</span> <span class="n">dom</span> <span class="o">==</span> <span class="nb">max</span><span class="p">(</span><span class="n">subs</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">subs</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="s2">&quot;post&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="n">swp</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">exp</span><span class="p">]</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()</span>
    <span class="p">]</span>
<span class="p">)</span>

<span class="n">dominance_df</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>experiment_name</th>
      <th>dominant</th>
      <th>subordinate</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>social0.2-aeon3</td>
      <td>BAA-1104047</td>
      <td>BAA-1104045</td>
    </tr>
    <tr>
      <th>1</th>
      <td>social0.2-aeon4</td>
      <td>BAA-1104048</td>
      <td>BAA-1104049</td>
    </tr>
    <tr>
      <th>2</th>
      <td>social0.4-aeon3</td>
      <td>BAA-1104792</td>
      <td>BAA-1104794</td>
    </tr>
    <tr>
      <th>3</th>
      <td>social0.4-aeon4</td>
      <td>BAA-1104795</td>
      <td>BAA-1104797</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute per‐subject, per‐block easy‐time fraction, but only keep blocks ≥1 min</span>
<span class="n">time_df</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;experiment_name&quot;</span><span class="p">,</span> <span class="s2">&quot;block_start&quot;</span><span class="p">,</span> <span class="s2">&quot;subject_name&quot;</span><span class="p">,</span> <span class="s2">&quot;patch_difficulty&quot;</span><span class="p">])[</span>
        <span class="s2">&quot;in_patch_time&quot;</span>
    <span class="p">]</span>
    <span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="s2">&quot;patch_difficulty&quot;</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">total_time</span><span class="o">=</span><span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="n">d</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
    <span class="c1"># filter out blocks with &lt; 60 s total patch time</span>
    <span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;total_time&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">60</span><span class="p">]</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">easy_ratio</span><span class="o">=</span><span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;easy&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;total_time&quot;</span><span class="p">])</span>
    <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="p">)</span>

<span class="c1"># Merge in dominant/subordinate labels and tag role</span>
<span class="n">time_df</span> <span class="o">=</span> <span class="n">time_df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">dominance_df</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;experiment_name&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
    <span class="n">role</span><span class="o">=</span><span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="n">d</span><span class="p">[</span><span class="s2">&quot;subject_name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;dominant&quot;</span><span class="p">],</span> <span class="s2">&quot;dominant&quot;</span><span class="p">,</span> <span class="s2">&quot;subordinate&quot;</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="c1"># Box‐plot of easy_ratio by role</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">box</span><span class="p">(</span>
    <span class="n">time_df</span><span class="p">,</span>
    <span class="n">x</span><span class="o">=</span><span class="s2">&quot;role&quot;</span><span class="p">,</span>
    <span class="n">y</span><span class="o">=</span><span class="s2">&quot;easy_ratio&quot;</span><span class="p">,</span>
    <span class="n">points</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span>
    <span class="n">category_orders</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;dominant&quot;</span><span class="p">,</span> <span class="s2">&quot;subordinate&quot;</span><span class="p">]},</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Relative time in easy patch by role (≥ 1 min total time spent in patches per block)&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">update_yaxes</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;Easy‐patch time / total patch time&quot;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">update_xaxes</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Print the medians</span>
<span class="n">medians</span> <span class="o">=</span> <span class="n">time_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;role&quot;</span><span class="p">)[</span><span class="s2">&quot;easy_ratio&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Median easy patch time ratio by role:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">role</span><span class="p">,</span> <span class="n">median</span> <span class="ow">in</span> <span class="n">medians</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">role</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">median</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/bc8b671ae3a8b681c8740221ff78e2407a4b4357a3142a9e3c4bb03938c75683.png" src="../../_images/bc8b671ae3a8b681c8740221ff78e2407a4b4357a3142a9e3c4bb03938c75683.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Median easy patch time ratio by role:
dominant: 0.52
subordinate: 0.53
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get per‐subject, per‐block time by difficulty</span>
<span class="n">time_df</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;experiment_name&quot;</span><span class="p">,</span> <span class="s2">&quot;block_start&quot;</span><span class="p">,</span> <span class="s2">&quot;subject_name&quot;</span><span class="p">,</span> <span class="s2">&quot;patch_difficulty&quot;</span><span class="p">])[</span>
        <span class="s2">&quot;in_patch_time&quot;</span>
    <span class="p">]</span>
    <span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="s2">&quot;patch_difficulty&quot;</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="c1"># drop any block‐subject that didn’t spend ≥10 s in each of hard/medium/easy</span>
    <span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="p">(</span><span class="n">d</span><span class="p">[[</span><span class="s2">&quot;hard&quot;</span><span class="p">,</span> <span class="s2">&quot;medium&quot;</span><span class="p">,</span> <span class="s2">&quot;easy&quot;</span><span class="p">]]</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
        <span class="n">total_time</span><span class="o">=</span><span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="n">d</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
        <span class="n">easy_ratio</span><span class="o">=</span><span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;easy&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;total_time&quot;</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="p">)</span>

<span class="c1"># Merge in dominant/subordinate and label role</span>
<span class="n">time_df</span> <span class="o">=</span> <span class="n">time_df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">dominance_df</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;experiment_name&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
    <span class="n">role</span><span class="o">=</span><span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="n">d</span><span class="p">[</span><span class="s2">&quot;subject_name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;dominant&quot;</span><span class="p">],</span> <span class="s2">&quot;dominant&quot;</span><span class="p">,</span> <span class="s2">&quot;subordinate&quot;</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="c1"># Box‐plot of easy_ratio by role</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">box</span><span class="p">(</span>
    <span class="n">time_df</span><span class="p">,</span>
    <span class="n">x</span><span class="o">=</span><span class="s2">&quot;role&quot;</span><span class="p">,</span>
    <span class="n">y</span><span class="o">=</span><span class="s2">&quot;easy_ratio&quot;</span><span class="p">,</span>
    <span class="n">points</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span>
    <span class="n">category_orders</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;dominant&quot;</span><span class="p">,</span> <span class="s2">&quot;subordinate&quot;</span><span class="p">]},</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Easy‐patch fraction by role (≥10 s in each non‐dummy patch)&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">update_yaxes</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;Easy time / total patch time&quot;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">update_xaxes</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/b7ea1465f09f896f8ce2e5d83fea8fc7bbb58cae30dfc2c13ac19dc7747b504d.png" src="../../_images/b7ea1465f09f896f8ce2e5d83fea8fc7bbb58cae30dfc2c13ac19dc7747b504d.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute true traveled distance for each patch‐visit, thresholding &lt;1→0</span>
<span class="n">df2</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
        <span class="c1"># sum of abs steps = true distance</span>
        <span class="n">traveled</span><span class="o">=</span><span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;wheel_cumsum_distance_travelled&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">arr</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">arr</span><span class="p">)))</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="c1"># any tiny (&lt;1) distance becomes 0</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">traveled</span><span class="o">=</span><span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;traveled&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mask</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;traveled&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
<span class="p">)</span>

<span class="c1"># Pivot to one row per subject‐block with columns [hard, medium, easy]</span>
<span class="n">dist_df</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">df2</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;experiment_name&quot;</span><span class="p">,</span> <span class="s2">&quot;block_start&quot;</span><span class="p">,</span> <span class="s2">&quot;subject_name&quot;</span><span class="p">,</span> <span class="s2">&quot;patch_difficulty&quot;</span><span class="p">])[</span>
        <span class="s2">&quot;traveled&quot;</span>
    <span class="p">]</span>
    <span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="s2">&quot;patch_difficulty&quot;</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
        <span class="n">total_dist</span><span class="o">=</span><span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="n">d</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
        <span class="n">easy_ratio</span><span class="o">=</span><span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;easy&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;total_dist&quot;</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="p">)</span>

<span class="c1"># Merge in dominance &amp; tag role</span>
<span class="n">dist_df</span> <span class="o">=</span> <span class="n">dist_df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">dominance_df</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;experiment_name&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
    <span class="n">role</span><span class="o">=</span><span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="n">d</span><span class="p">[</span><span class="s2">&quot;subject_name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;dominant&quot;</span><span class="p">],</span> <span class="s2">&quot;dominant&quot;</span><span class="p">,</span> <span class="s2">&quot;subordinate&quot;</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="c1"># Box‐plot of easy_ratio by role</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">box</span><span class="p">(</span>
    <span class="n">dist_df</span><span class="p">,</span>
    <span class="n">x</span><span class="o">=</span><span class="s2">&quot;role&quot;</span><span class="p">,</span>
    <span class="n">y</span><span class="o">=</span><span class="s2">&quot;easy_ratio&quot;</span><span class="p">,</span>
    <span class="n">points</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span>
    <span class="n">category_orders</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;dominant&quot;</span><span class="p">,</span> <span class="s2">&quot;subordinate&quot;</span><span class="p">]},</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Easy‐patch distance fraction by role (tiny spins &lt;1 set to 0)&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">update_yaxes</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;Easy‐patch distance / total distance&quot;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">update_xaxes</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Print the medians</span>
<span class="n">medians</span> <span class="o">=</span> <span class="n">dist_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;role&quot;</span><span class="p">)[</span><span class="s2">&quot;easy_ratio&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Median easy patch distance ratio by role:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">role</span><span class="p">,</span> <span class="n">median</span> <span class="ow">in</span> <span class="n">medians</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">role</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">median</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/937377e3e83bf7a7346193ee70fa0019e8c31d3eb97d76c247e76968309367eb.png" src="../../_images/937377e3e83bf7a7346193ee70fa0019e8c31d3eb97d76c247e76968309367eb.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Median easy patch distance ratio by role:
dominant: 0.33
subordinate: 0.33
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute true traveled distance per patch‐visit, tiny spins → 0</span>
<span class="n">df2</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
    <span class="n">traveled</span><span class="o">=</span><span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;wheel_cumsum_distance_travelled&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">arr</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">arr</span><span class="p">)))</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="p">)</span>
<span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">traveled</span><span class="o">=</span><span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;traveled&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mask</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;traveled&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

<span class="c1"># Pivot to one row per subject‐block, but only keep rows where hard,medium,easy &gt;5</span>
<span class="n">dist_df</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">df2</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;experiment_name&quot;</span><span class="p">,</span> <span class="s2">&quot;block_start&quot;</span><span class="p">,</span> <span class="s2">&quot;subject_name&quot;</span><span class="p">,</span> <span class="s2">&quot;patch_difficulty&quot;</span><span class="p">])[</span>
        <span class="s2">&quot;traveled&quot;</span>
    <span class="p">]</span>
    <span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="s2">&quot;patch_difficulty&quot;</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="p">(</span><span class="n">d</span><span class="p">[[</span><span class="s2">&quot;hard&quot;</span><span class="p">,</span> <span class="s2">&quot;medium&quot;</span><span class="p">,</span> <span class="s2">&quot;easy&quot;</span><span class="p">]]</span> <span class="o">&gt;</span> <span class="mi">500</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
        <span class="n">total_dist</span><span class="o">=</span><span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="n">d</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
        <span class="n">easy_ratio</span><span class="o">=</span><span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;easy&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;total_dist&quot;</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="p">)</span>

<span class="c1"># Merge in dominance &amp; tag role</span>
<span class="n">dist_df</span> <span class="o">=</span> <span class="n">dist_df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">dominance_df</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;experiment_name&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
    <span class="n">role</span><span class="o">=</span><span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="n">d</span><span class="p">[</span><span class="s2">&quot;subject_name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;dominant&quot;</span><span class="p">],</span> <span class="s2">&quot;dominant&quot;</span><span class="p">,</span> <span class="s2">&quot;subordinate&quot;</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="c1"># Box‐plot of easy_ratio by role (dominant first)</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">box</span><span class="p">(</span>
    <span class="n">dist_df</span><span class="p">,</span>
    <span class="n">x</span><span class="o">=</span><span class="s2">&quot;role&quot;</span><span class="p">,</span>
    <span class="n">y</span><span class="o">=</span><span class="s2">&quot;easy_ratio&quot;</span><span class="p">,</span>
    <span class="n">points</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span>
    <span class="n">category_orders</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;dominant&quot;</span><span class="p">,</span> <span class="s2">&quot;subordinate&quot;</span><span class="p">]},</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Easy‐patch distance fraction by role (all wheels &gt;500cm)&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">update_yaxes</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;Easy‐patch distance / total distance&quot;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">update_xaxes</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/93b01605f8d71a45dc9d037a4423f13ca9cce4246123db555a8458ca7661d8b3.png" src="../../_images/93b01605f8d71a45dc9d037a4423f13ca9cce4246123db555a8458ca7661d8b3.png" />
</div>
</div>
</section>
</section>
<section id="patch-preference-plots">
<h2>Patch preference plots<a class="headerlink" href="#patch-preference-plots" title="Link to this heading">#</a></h2>
<section id="id1">
<h3>Load data<a class="headerlink" href="#id1" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">load_experiment_data</span><span class="p">(</span>
    <span class="n">data_dir</span><span class="o">=</span><span class="n">data_dir</span><span class="p">,</span>
    <span class="n">data_types</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;patch&quot;</span><span class="p">,</span> <span class="s2">&quot;patchinfo&quot;</span><span class="p">],</span>
<span class="p">)</span>

<span class="n">patch_df</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;None_patch&quot;</span><span class="p">]</span>
<span class="n">patch_info_df</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;None_patchinfo&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">block_subject_patch_data_social_combined</span> <span class="o">=</span> <span class="n">patch_df</span><span class="p">[</span>
    <span class="n">patch_df</span><span class="p">[</span><span class="s2">&quot;period&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;social&quot;</span>
<span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">block_subject_patch_data_social_combined</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;period&quot;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">block_subject_patch_data_social_dict</span> <span class="o">=</span> <span class="n">patch_df_to_dict</span><span class="p">(</span>
    <span class="n">block_subject_patch_data_social_combined</span>
<span class="p">)</span>
<span class="n">block_subject_patch_data_post_social_combined</span> <span class="o">=</span> <span class="n">patch_df</span><span class="p">[</span>
    <span class="n">patch_df</span><span class="p">[</span><span class="s2">&quot;period&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;postsocial&quot;</span>
<span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">block_subject_patch_data_post_social_combined</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;period&quot;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">block_subject_patch_data_post_social_dict</span> <span class="o">=</span> <span class="n">patch_df_to_dict</span><span class="p">(</span>
    <span class="n">block_subject_patch_data_post_social_combined</span>
<span class="p">)</span>
<span class="n">block_subject_patch_data_social_first_half_combined</span> <span class="o">=</span> <span class="n">get_first_half_social</span><span class="p">(</span>
    <span class="n">patch_df</span>
<span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">block_subject_patch_data_social_first_half_combined</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span>
    <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;period&quot;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="n">block_subject_patch_data_social_first_half_dict</span> <span class="o">=</span> <span class="n">patch_df_to_dict</span><span class="p">(</span>
    <span class="n">block_subject_patch_data_social_first_half_combined</span>
<span class="p">)</span>
<span class="n">patch_info_dict</span> <span class="o">=</span> <span class="n">patch_info_df_to_dict</span><span class="p">(</span><span class="n">patch_info_df</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="wheel-distance-spun-per-block-averaged-by-the-number-of-mice">
<h3>1. Wheel distance spun per block, averaged by the number of mice<a class="headerlink" href="#wheel-distance-spun-per-block-averaged-by-the-number-of-mice" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">block_subject_patch_data_social_combined</span><span class="p">[</span><span class="s2">&quot;final_wheel_cumsum&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">block_subject_patch_data_social_combined</span><span class="p">[</span><span class="s2">&quot;wheel_cumsum_distance_travelled&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="p">)</span>
<span class="p">)</span>
<span class="n">wheel_total_dist_averaged_social</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">block_subject_patch_data_social_combined</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;block_start&quot;</span><span class="p">)[</span>
        <span class="s2">&quot;final_wheel_cumsum&quot;</span>
    <span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="o">/</span> <span class="mi">2</span>
<span class="p">)</span>
<span class="n">wheel_total_dist_averaged_social</span> <span class="o">=</span> <span class="n">wheel_total_dist_averaged_social</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

<span class="n">block_subject_patch_data_post_social_combined</span><span class="p">[</span><span class="s2">&quot;final_wheel_cumsum&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">block_subject_patch_data_post_social_combined</span><span class="p">[</span>
        <span class="s2">&quot;wheel_cumsum_distance_travelled&quot;</span>
    <span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">wheel_total_dist_averaged_post_social</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">block_subject_patch_data_post_social_combined</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;block_start&quot;</span><span class="p">)[</span>
        <span class="s2">&quot;final_wheel_cumsum&quot;</span>
    <span class="p">]</span>
    <span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="p">)</span>

<span class="n">wheel_total_dist_averaged_social</span><span class="p">[</span><span class="s2">&quot;condition&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;social&quot;</span>
<span class="n">wheel_total_dist_averaged_post_social</span><span class="p">[</span><span class="s2">&quot;condition&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;post_social&quot;</span>
<span class="n">wheel_total_dist_averaged</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
    <span class="p">[</span><span class="n">wheel_total_dist_averaged_social</span><span class="p">,</span> <span class="n">wheel_total_dist_averaged_post_social</span><span class="p">]</span>
<span class="p">)</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">box</span><span class="p">(</span>
    <span class="n">wheel_total_dist_averaged</span><span class="p">,</span>
    <span class="n">x</span><span class="o">=</span><span class="s2">&quot;condition&quot;</span><span class="p">,</span>
    <span class="n">y</span><span class="o">=</span><span class="s2">&quot;final_wheel_cumsum&quot;</span><span class="p">,</span>
    <span class="n">points</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Wheel Distance Spun Per Block Averaged By Number Of Subjects&quot;</span><span class="p">,</span>
    <span class="n">labels</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;final_wheel_cumsum&quot;</span><span class="p">:</span> <span class="s2">&quot;Wheel Distance Spun Per Block (cm)&quot;</span><span class="p">},</span>
<span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/0216db9b5a67dec2c397496ff27a6b59057f24ed04fa033eb2a54ff15695ffab.png" src="../../_images/0216db9b5a67dec2c397496ff27a6b59057f24ed04fa033eb2a54ff15695ffab.png" />
</div>
</div>
</section>
<section id="number-of-patch-switches-by-each-mouse-per-block">
<h3>2. Number of patch switches by each mouse per block<a class="headerlink" href="#number-of-patch-switches-by-each-mouse-per-block" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">prob_per_patch_social_first_half_dict</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">prob_per_patch_social_dict</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">prob_per_patch_post_social_dict</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">prob_hard_patch_social_first_half_dict</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">prob_hard_patch_social_dict</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">prob_hard_patch_post_social_dict</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">prob_hard_patch_mean_social_first_half_dict</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">prob_hard_patch_mean_social_dict</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">prob_hard_patch_mean_post_social_dict</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">for</span> <span class="n">exp</span> <span class="ow">in</span> <span class="n">experiments</span><span class="p">:</span>
    <span class="n">exp_name</span> <span class="o">=</span> <span class="n">exp</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
    <span class="n">block_subject_patch_data_social_first_half</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">block_subject_patch_data_social_first_half_dict</span><span class="p">[</span><span class="n">exp_name</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">block_subject_patch_data_social</span> <span class="o">=</span> <span class="n">block_subject_patch_data_social_dict</span><span class="p">[</span><span class="n">exp_name</span><span class="p">]</span>
    <span class="n">block_subject_patch_data_post_social</span> <span class="o">=</span> <span class="n">block_subject_patch_data_post_social_dict</span><span class="p">[</span>
        <span class="n">exp_name</span>
    <span class="p">]</span>
    <span class="n">patch_info</span> <span class="o">=</span> <span class="n">patch_info_dict</span><span class="p">[</span><span class="n">exp_name</span><span class="p">]</span>

    <span class="c1"># Compute patch probabilities</span>
    <span class="n">prob_per_patch_social_first_half_dict</span><span class="p">[</span><span class="n">exp_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">compute_patch_probabilities</span><span class="p">(</span>
        <span class="n">block_subject_patch_data_social_first_half</span>
    <span class="p">)</span>
    <span class="n">prob_per_patch_social_dict</span><span class="p">[</span><span class="n">exp_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">compute_patch_probabilities</span><span class="p">(</span>
        <span class="n">block_subject_patch_data_social</span>
    <span class="p">)</span>
    <span class="n">prob_per_patch_post_social_dict</span><span class="p">[</span><span class="n">exp_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">compute_patch_probabilities</span><span class="p">(</span>
        <span class="n">block_subject_patch_data_post_social</span>
    <span class="p">)</span>

    <span class="c1"># Extract hard patch probabilities</span>
    <span class="n">prob_hard_patch_social_first_half_dict</span><span class="p">[</span><span class="n">exp_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">extract_hard_patch_probabilities</span><span class="p">(</span>
        <span class="n">prob_per_patch_social_first_half_dict</span><span class="p">[</span><span class="n">exp_name</span><span class="p">],</span> <span class="n">patch_info</span>
    <span class="p">)</span>
    <span class="n">prob_hard_patch_social_dict</span><span class="p">[</span><span class="n">exp_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">extract_hard_patch_probabilities</span><span class="p">(</span>
        <span class="n">prob_per_patch_social_dict</span><span class="p">[</span><span class="n">exp_name</span><span class="p">],</span> <span class="n">patch_info</span>
    <span class="p">)</span>
    <span class="n">prob_hard_patch_post_social_dict</span><span class="p">[</span><span class="n">exp_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">extract_hard_patch_probabilities</span><span class="p">(</span>
        <span class="n">prob_per_patch_post_social_dict</span><span class="p">[</span><span class="n">exp_name</span><span class="p">],</span> <span class="n">patch_info</span>
    <span class="p">)</span>

    <span class="c1"># Calculate the mean hard patch probability per pellet number</span>
    <span class="n">prob_hard_patch_mean_social_first_half_dict</span><span class="p">[</span><span class="n">exp_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">prob_hard_patch_social_first_half_dict</span><span class="p">[</span><span class="n">exp_name</span><span class="p">]</span>
        <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;pellet_number&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">numeric_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="p">)</span>
    <span class="n">prob_hard_patch_mean_social_dict</span><span class="p">[</span><span class="n">exp_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">prob_hard_patch_social_dict</span><span class="p">[</span><span class="n">exp_name</span><span class="p">]</span>
        <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;pellet_number&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">numeric_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="p">)</span>
    <span class="n">prob_hard_patch_mean_post_social_dict</span><span class="p">[</span><span class="n">exp_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">prob_hard_patch_post_social_dict</span><span class="p">[</span><span class="n">exp_name</span><span class="p">]</span>
        <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;pellet_number&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">numeric_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="p">)</span>

<span class="c1"># Combine the results</span>
<span class="n">prob_hard_patch_social_first_half_combined</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
    <span class="n">prob_hard_patch_social_first_half_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
<span class="p">)</span>
<span class="n">prob_hard_patch_social_combined</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">prob_hard_patch_social_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
<span class="n">prob_hard_patch_post_social_combined</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
    <span class="n">prob_hard_patch_post_social_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
<span class="p">)</span>

<span class="n">prob_hard_patch_mean_social_first_half_combined</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">prob_hard_patch_social_first_half_combined</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;pellet_number&quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">numeric_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="p">)</span>
<span class="n">prob_hard_patch_mean_social_combined</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">prob_hard_patch_social_combined</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;pellet_number&quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">numeric_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="p">)</span>
<span class="n">prob_hard_patch_mean_post_social_combined</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">prob_hard_patch_post_social_combined</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;pellet_number&quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">numeric_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_social_first_half</span><span class="p">,</span> <span class="n">y_pred_social_first_half</span> <span class="o">=</span> <span class="n">analyze_patch_probabilities</span><span class="p">(</span>
    <span class="n">prob_hard_patch_mean_social_first_half_combined</span><span class="p">,</span> <span class="s2">&quot;social first half&quot;</span>
<span class="p">)</span>
<span class="n">model_social</span><span class="p">,</span> <span class="n">y_pred_social</span> <span class="o">=</span> <span class="n">analyze_patch_probabilities</span><span class="p">(</span>
    <span class="n">prob_hard_patch_mean_social_combined</span><span class="p">,</span> <span class="s2">&quot;social&quot;</span>
<span class="p">)</span>
<span class="n">model_post_social</span><span class="p">,</span> <span class="n">y_pred_post_social</span> <span class="o">=</span> <span class="n">analyze_patch_probabilities</span><span class="p">(</span>
    <span class="n">prob_hard_patch_mean_post_social_combined</span><span class="p">,</span> <span class="s2">&quot;post-social&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>P-value for the social first half slope: 5.936891089220609e-14
social first half model summary:                              OLS Regression Results                            
==============================================================================
Dep. Variable:                      y   R-squared:                       0.823
Model:                            OLS   Adj. R-squared:                  0.818
Method:                 Least Squares   F-statistic:                     153.4
Date:                Thu, 21 Aug 2025   Prob (F-statistic):           5.94e-14
Time:                        17:37:33   Log-Likelihood:                 93.236
No. Observations:                  35   AIC:                            -182.5
Df Residuals:                      33   BIC:                            -179.4
Df Model:                           1                                         
Covariance Type:            nonrobust                                         
==============================================================================
                 coef    std err          t      P&gt;|t|      [0.025      0.975]
------------------------------------------------------------------------------
const          0.2611      0.006     43.528      0.000       0.249       0.273
x1            -0.0036      0.000    -12.384      0.000      -0.004      -0.003
==============================================================================
Omnibus:                        1.794   Durbin-Watson:                   0.708
Prob(Omnibus):                  0.408   Jarque-Bera (JB):                1.503
Skew:                          -0.353   Prob(JB):                        0.472
Kurtosis:                       2.270   Cond. No.                         42.3
==============================================================================

Notes:
[1] Standard Errors assume that the covariance matrix of the errors is correctly specified.
P-value for the social slope: 2.2319432890179306e-18
social model summary:                              OLS Regression Results                            
==============================================================================
Dep. Variable:                      y   R-squared:                       0.904
Model:                            OLS   Adj. R-squared:                  0.901
Method:                 Least Squares   F-statistic:                     311.6
Date:                Thu, 21 Aug 2025   Prob (F-statistic):           2.23e-18
Time:                        17:37:33   Log-Likelihood:                 102.24
No. Observations:                  35   AIC:                            -200.5
Df Residuals:                      33   BIC:                            -197.4
Df Model:                           1                                         
Covariance Type:            nonrobust                                         
==============================================================================
                 coef    std err          t      P&gt;|t|      [0.025      0.975]
------------------------------------------------------------------------------
const          0.2490      0.005     53.700      0.000       0.240       0.258
x1            -0.0040      0.000    -17.654      0.000      -0.004      -0.004
==============================================================================
Omnibus:                        2.251   Durbin-Watson:                   0.657
Prob(Omnibus):                  0.325   Jarque-Bera (JB):                1.851
Skew:                          -0.556   Prob(JB):                        0.396
Kurtosis:                       2.820   Cond. No.                         42.3
==============================================================================

Notes:
[1] Standard Errors assume that the covariance matrix of the errors is correctly specified.
P-value for the post-social slope: 2.5099330775172165e-07
post-social model summary:                              OLS Regression Results                            
==============================================================================
Dep. Variable:                      y   R-squared:                       0.558
Model:                            OLS   Adj. R-squared:                  0.545
Method:                 Least Squares   F-statistic:                     41.73
Date:                Thu, 21 Aug 2025   Prob (F-statistic):           2.51e-07
Time:                        17:37:33   Log-Likelihood:                 84.637
No. Observations:                  35   AIC:                            -165.3
Df Residuals:                      33   BIC:                            -162.2
Df Model:                           1                                         
Covariance Type:            nonrobust                                         
==============================================================================
                 coef    std err          t      P&gt;|t|      [0.025      0.975]
------------------------------------------------------------------------------
const          0.2283      0.008     29.774      0.000       0.213       0.244
x1            -0.0024      0.000     -6.460      0.000      -0.003      -0.002
==============================================================================
Omnibus:                        0.420   Durbin-Watson:                   0.735
Prob(Omnibus):                  0.810   Jarque-Bera (JB):                0.556
Skew:                           0.003   Prob(JB):                        0.757
Kurtosis:                       2.383   Cond. No.                         42.3
==============================================================================

Notes:
[1] Standard Errors assume that the covariance matrix of the errors is correctly specified.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>

<span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
    <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
        <span class="n">x</span><span class="o">=</span><span class="n">prob_hard_patch_mean_social_first_half_combined</span><span class="p">[</span><span class="s2">&quot;pellet_number&quot;</span><span class="p">],</span>  <span class="c1"># [0:35],</span>
        <span class="n">y</span><span class="o">=</span><span class="n">prob_hard_patch_mean_social_first_half_combined</span><span class="p">[</span>
            <span class="s2">&quot;prob_in_hard_patch&quot;</span>
        <span class="p">],</span>  <span class="c1"># [0:35],</span>
        <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;lines&quot;</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;First Half of Social Data&quot;</span><span class="p">,</span>
        <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">),</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
    <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
        <span class="n">x</span><span class="o">=</span><span class="n">prob_hard_patch_mean_social_combined</span><span class="p">[</span><span class="s2">&quot;pellet_number&quot;</span><span class="p">],</span>  <span class="c1"># [0:35],</span>
        <span class="n">y</span><span class="o">=</span><span class="n">prob_hard_patch_mean_social_combined</span><span class="p">[</span><span class="s2">&quot;prob_in_hard_patch&quot;</span><span class="p">],</span>  <span class="c1"># [0:35],</span>
        <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;lines&quot;</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Social Data&quot;</span><span class="p">,</span>
        <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">),</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
    <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
        <span class="n">x</span><span class="o">=</span><span class="n">prob_hard_patch_mean_post_social_combined</span><span class="p">[</span><span class="s2">&quot;pellet_number&quot;</span><span class="p">],</span>  <span class="c1"># [0:35],</span>
        <span class="n">y</span><span class="o">=</span><span class="n">prob_hard_patch_mean_post_social_combined</span><span class="p">[</span><span class="s2">&quot;prob_in_hard_patch&quot;</span><span class="p">],</span>  <span class="c1"># [0:35],</span>
        <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;lines&quot;</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Post Social Data&quot;</span><span class="p">,</span>
        <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;#00CC96&quot;</span><span class="p">),</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
    <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
        <span class="n">x</span><span class="o">=</span><span class="n">prob_hard_patch_mean_social_first_half_combined</span><span class="p">[</span><span class="s2">&quot;pellet_number&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">35</span><span class="p">],</span>
        <span class="n">y</span><span class="o">=</span><span class="n">y_pred_social_first_half</span><span class="p">,</span>
        <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;lines&quot;</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Social First Half Linear Regression Line&quot;</span><span class="p">,</span>
        <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">dash</span><span class="o">=</span><span class="s2">&quot;dash&quot;</span><span class="p">),</span>
        <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">),</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
    <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
        <span class="n">x</span><span class="o">=</span><span class="n">prob_hard_patch_mean_social_combined</span><span class="p">[</span><span class="s2">&quot;pellet_number&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">35</span><span class="p">],</span>
        <span class="n">y</span><span class="o">=</span><span class="n">y_pred_social</span><span class="p">,</span>
        <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;lines&quot;</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Social Linear Regression Line&quot;</span><span class="p">,</span>
        <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">dash</span><span class="o">=</span><span class="s2">&quot;dash&quot;</span><span class="p">),</span>
        <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">),</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
    <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
        <span class="n">x</span><span class="o">=</span><span class="n">prob_hard_patch_mean_social_combined</span><span class="p">[</span><span class="s2">&quot;pellet_number&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">35</span><span class="p">],</span>
        <span class="n">y</span><span class="o">=</span><span class="n">y_pred_post_social</span><span class="p">,</span>
        <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;lines&quot;</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Post Social Linear Regression Line&quot;</span><span class="p">,</span>
        <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">dash</span><span class="o">=</span><span class="s2">&quot;dash&quot;</span><span class="p">),</span>
        <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;#00CC96&quot;</span><span class="p">),</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Probability of being in hard patch over time&quot;</span><span class="p">,</span>
    <span class="n">xaxis_title</span><span class="o">=</span><span class="s2">&quot;Pellet number in block&quot;</span><span class="p">,</span>
    <span class="n">yaxis_title</span><span class="o">=</span><span class="s2">&quot;Hard patch probability&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Save the figure as an SVG file</span>
<span class="c1"># fig.write_image(&quot;hard_patch_probability.svg&quot;)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/83c4a4d8616d5a205b3b79d6ff74e766bf8789cc134c3454d3428b1346480e0d.png" src="../../_images/83c4a4d8616d5a205b3b79d6ff74e766bf8789cc134c3454d3428b1346480e0d.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define the number of rows and columns for the subplot grid</span>
<span class="n">num_experiments</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">experiments</span><span class="p">)</span>
<span class="n">num_cols</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">num_rows</span> <span class="o">=</span> <span class="p">(</span><span class="n">num_experiments</span> <span class="o">+</span> <span class="n">num_cols</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">num_cols</span>

<span class="c1"># Create a subplot grid</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">make_subplots</span><span class="p">(</span>
    <span class="n">rows</span><span class="o">=</span><span class="n">num_rows</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="n">num_cols</span><span class="p">,</span> <span class="n">subplot_titles</span><span class="o">=</span><span class="p">[</span><span class="n">exp</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">exp</span> <span class="ow">in</span> <span class="n">experiments</span><span class="p">]</span>
<span class="p">)</span>

<span class="c1"># Iterate over each experiment and add a plot to the grid</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">exp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">experiments</span><span class="p">):</span>
    <span class="n">exp_name</span> <span class="o">=</span> <span class="n">exp</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
    <span class="n">row</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">//</span> <span class="n">num_cols</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">col</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="n">num_cols</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="c1"># Add the plot to the grid</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
        <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="n">prob_hard_patch_mean_social_first_half_dict</span><span class="p">[</span><span class="n">exp_name</span><span class="p">][</span><span class="s2">&quot;pellet_number&quot;</span><span class="p">][</span>
                <span class="mi">0</span><span class="p">:</span><span class="mi">35</span>
            <span class="p">],</span>
            <span class="n">y</span><span class="o">=</span><span class="n">prob_hard_patch_mean_social_first_half_dict</span><span class="p">[</span><span class="n">exp_name</span><span class="p">][</span>
                <span class="s2">&quot;prob_in_hard_patch&quot;</span>
            <span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">35</span><span class="p">],</span>
            <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;lines&quot;</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;First Half of Social Data&quot;</span><span class="p">,</span>
            <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">),</span>
            <span class="n">showlegend</span><span class="o">=</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">),</span>
        <span class="p">),</span>
        <span class="n">row</span><span class="o">=</span><span class="n">row</span><span class="p">,</span>
        <span class="n">col</span><span class="o">=</span><span class="n">col</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
        <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="n">prob_hard_patch_mean_social_dict</span><span class="p">[</span><span class="n">exp_name</span><span class="p">][</span><span class="s2">&quot;pellet_number&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">35</span><span class="p">],</span>
            <span class="n">y</span><span class="o">=</span><span class="n">prob_hard_patch_mean_social_dict</span><span class="p">[</span><span class="n">exp_name</span><span class="p">][</span><span class="s2">&quot;prob_in_hard_patch&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">35</span><span class="p">],</span>
            <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;lines&quot;</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Social Data&quot;</span><span class="p">,</span>
            <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">),</span>
            <span class="n">showlegend</span><span class="o">=</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">),</span>
        <span class="p">),</span>
        <span class="n">row</span><span class="o">=</span><span class="n">row</span><span class="p">,</span>
        <span class="n">col</span><span class="o">=</span><span class="n">col</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
        <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="n">prob_hard_patch_mean_post_social_dict</span><span class="p">[</span><span class="n">exp_name</span><span class="p">][</span><span class="s2">&quot;pellet_number&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">35</span><span class="p">],</span>
            <span class="n">y</span><span class="o">=</span><span class="n">prob_hard_patch_mean_post_social_dict</span><span class="p">[</span><span class="n">exp_name</span><span class="p">][</span><span class="s2">&quot;prob_in_hard_patch&quot;</span><span class="p">][</span>
                <span class="mi">0</span><span class="p">:</span><span class="mi">35</span>
            <span class="p">],</span>
            <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;lines&quot;</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Post Social Data&quot;</span><span class="p">,</span>
            <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;#00CC96&quot;</span><span class="p">),</span>
            <span class="n">showlegend</span><span class="o">=</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">),</span>
        <span class="p">),</span>
        <span class="n">row</span><span class="o">=</span><span class="n">row</span><span class="p">,</span>
        <span class="n">col</span><span class="o">=</span><span class="n">col</span><span class="p">,</span>
    <span class="p">)</span>


<span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">height</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/634f656fbb54098ac74a06a8d130385ad1dedb5b3525a44dc83bce7d9027f9c5.png" src="../../_images/634f656fbb54098ac74a06a8d130385ad1dedb5b3525a44dc83bce7d9027f9c5.png" />
</div>
</div>
</section>
</section>
<section id="data-overview-plot">
<h2>Data overview plot<a class="headerlink" href="#data-overview-plot" title="Link to this heading">#</a></h2>
<section id="id2">
<h3>Load data<a class="headerlink" href="#id2" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">experiment</span> <span class="o">=</span> <span class="n">experiments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">load_experiment_data</span><span class="p">(</span>
    <span class="n">experiment</span><span class="o">=</span><span class="n">experiment</span><span class="p">,</span>
    <span class="n">data_dir</span><span class="o">=</span><span class="n">data_dir</span><span class="p">,</span>
    <span class="n">periods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;social&quot;</span><span class="p">],</span>
    <span class="n">data_types</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;patch&quot;</span><span class="p">,</span> <span class="s2">&quot;position&quot;</span><span class="p">,</span> <span class="s2">&quot;foraging&quot;</span><span class="p">,</span> <span class="s2">&quot;weight&quot;</span><span class="p">],</span>
    <span class="c1"># trim_days=1 # Opional: trim</span>
<span class="p">)</span>
<span class="n">social_patch_df</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;social_patch&quot;</span><span class="p">]</span>
<span class="n">social_position_df</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;social_position&quot;</span><span class="p">]</span>
<span class="n">social_foraging_df</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;social_foraging&quot;</span><span class="p">]</span>
<span class="n">social_weight_df</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;social_weight&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="position-heatmaps-over-time-per-subject">
<h3>1. Position heatmaps over time per subject<a class="headerlink" href="#position-heatmaps-over-time-per-subject" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Copy and sort dataframe</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">social_position_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>

<span class="c1"># Compute time-of-day and flag dark vs light periods</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;tod&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">hour</span>
    <span class="o">+</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">minute</span> <span class="o">/</span> <span class="mi">60</span>
    <span class="o">+</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">second</span> <span class="o">/</span> <span class="mi">3600</span>
    <span class="o">+</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">microsecond</span> <span class="o">/</span> <span class="mf">1e6</span> <span class="o">/</span> <span class="mi">3600</span>
<span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;is_dark&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;tod&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">light_off</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;tod&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">light_on</span><span class="p">)</span>

<span class="c1"># Detect light/dark transitions and assign period IDs</span>
<span class="n">first_dark</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;identity_name&quot;</span><span class="p">)[</span><span class="s2">&quot;is_dark&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="s2">&quot;first&quot;</span><span class="p">)</span>
<span class="n">shifted</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;identity_name&quot;</span><span class="p">)[</span><span class="s2">&quot;is_dark&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">()</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">first_dark</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;light_change&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;is_dark&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">shifted</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;light_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;identity_name&quot;</span><span class="p">)[</span><span class="s2">&quot;light_change&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/tmp/ipykernel_1141116/3605859362.py:15: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option(&#39;future.no_silent_downcasting&#39;, True)`
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Save the original index name and reset to unique integer indices</span>
<span class="n">original_index_name</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="ow">or</span> <span class="s2">&quot;time&quot;</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

<span class="c1"># Initialize speed column</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;speed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

<span class="c1"># Calculate the speed of each subject based on position data</span>
<span class="k">for</span> <span class="n">subject</span> <span class="ow">in</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;identity_name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
    <span class="n">subject_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;identity_name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">subject</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">subject_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">original_index_name</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># sort by time</span>
    <span class="k">if</span> <span class="n">subject_df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="k">continue</span>

    <span class="c1"># Calculate the difference in position and time</span>
    <span class="n">dxy</span> <span class="o">=</span> <span class="n">subject_df</span><span class="p">[[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>  <span class="c1"># skip the first row (NaN)</span>
    <span class="n">dt_ms</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">subject_df</span><span class="p">[</span><span class="n">original_index_name</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">*</span> <span class="mi">1000</span>
    <span class="p">)</span>  <span class="c1"># convert to milliseconds</span>

    <span class="c1"># Calculate speed in cm/s</span>
    <span class="n">speed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">dxy</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">dt_ms</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">/</span> <span class="n">cm2px</span>  <span class="c1"># convert to cm/s</span>
    <span class="n">subject_df</span><span class="p">[</span><span class="s2">&quot;speed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(([</span><span class="mi">0</span><span class="p">],</span> <span class="n">speed</span><span class="p">))</span>  <span class="c1"># add zero for the first row</span>

    <span class="c1"># Apply a running average filter</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10</span>  <span class="c1"># running avg filter kernel (10 frames)</span>
    <span class="n">subject_df</span><span class="p">[</span><span class="s2">&quot;speed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">subject_df</span><span class="p">[</span><span class="s2">&quot;speed&quot;</span><span class="p">],</span> <span class="n">k</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;same&quot;</span><span class="p">)</span>

    <span class="c1"># Update the original dataframe</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;identity_name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">subject</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="s2">&quot;speed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">subject_df</span><span class="p">[</span><span class="s2">&quot;speed&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

<span class="c1"># Set the index back to time</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">original_index_name</span><span class="p">)</span>

<span class="c1"># Remove rows where speed is above 250cm/s</span>
<span class="n">df_filtered</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;speed&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">250</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_plot</span> <span class="o">=</span> <span class="n">df_filtered</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

<span class="n">dark_color</span> <span class="o">=</span> <span class="s2">&quot;#555555&quot;</span>
<span class="n">light_color</span> <span class="o">=</span> <span class="s2">&quot;#CCCCCC&quot;</span>
<span class="n">subjects</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">df_plot</span><span class="p">[</span><span class="s2">&quot;identity_name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
<span class="n">n_subj</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">subjects</span><span class="p">)</span>
<span class="n">n_per</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">df_plot</span><span class="p">[</span><span class="s2">&quot;light_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>

<span class="c1"># Set up subplots</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
    <span class="n">nrows</span><span class="o">=</span><span class="n">n_subj</span><span class="p">,</span>
    <span class="n">ncols</span><span class="o">=</span><span class="n">n_per</span><span class="p">,</span>
    <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">n_per</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">n_subj</span><span class="p">),</span>
    <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Loop over axes and draw</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">subj</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">subjects</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_per</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">sub</span> <span class="o">=</span> <span class="n">df_plot</span><span class="p">[(</span><span class="n">df_plot</span><span class="o">.</span><span class="n">identity_name</span> <span class="o">==</span> <span class="n">subj</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df_plot</span><span class="o">.</span><span class="n">light_id</span> <span class="o">==</span> <span class="n">j</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">sub</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>
            <span class="k">continue</span>

        <span class="n">col</span> <span class="o">=</span> <span class="n">dark_color</span> <span class="k">if</span> <span class="n">sub</span><span class="o">.</span><span class="n">is_dark</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">else</span> <span class="n">light_color</span>

        <span class="n">plot_in_chunks</span><span class="p">(</span>
            <span class="n">ax</span><span class="p">,</span> <span class="n">sub</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">sub</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">col</span>
        <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s2">&quot;equal&quot;</span><span class="p">,</span> <span class="s2">&quot;box&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>

<span class="c1"># Scale bar in bottom-right</span>
<span class="n">last_ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">length_px</span> <span class="o">=</span> <span class="mf">0.2</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">cm2px</span>
<span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span> <span class="o">=</span> <span class="n">last_ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()</span>
<span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="n">last_ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>
<span class="n">x1</span> <span class="o">=</span> <span class="n">xmax</span> <span class="o">-</span> <span class="mf">0.02</span> <span class="o">*</span> <span class="p">(</span><span class="n">xmax</span> <span class="o">-</span> <span class="n">xmin</span><span class="p">)</span>
<span class="n">x0</span> <span class="o">=</span> <span class="n">x1</span> <span class="o">-</span> <span class="n">length_px</span>
<span class="n">y0</span> <span class="o">=</span> <span class="n">ymin</span> <span class="o">+</span> <span class="mf">0.02</span> <span class="o">*</span> <span class="p">(</span><span class="n">ymax</span> <span class="o">-</span> <span class="n">ymin</span><span class="p">)</span>
<span class="n">last_ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">],</span> <span class="p">[</span><span class="n">y0</span><span class="p">,</span> <span class="n">y0</span><span class="p">],</span> <span class="s2">&quot;k-&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">last_ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
    <span class="p">(</span><span class="n">x0</span> <span class="o">+</span> <span class="n">x1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
    <span class="n">y0</span> <span class="o">-</span> <span class="mf">0.06</span> <span class="o">*</span> <span class="p">(</span><span class="n">ymax</span> <span class="o">-</span> <span class="n">ymin</span><span class="p">),</span>
    <span class="s2">&quot;0.2 m&quot;</span><span class="p">,</span>
    <span class="n">va</span><span class="o">=</span><span class="s2">&quot;top&quot;</span><span class="p">,</span>
    <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
    <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

<span class="c1"># svg_path = save_dir / &quot;position_maps.pdf&quot;</span>
<span class="c1"># plt.savefig(svg_path, format=&quot;pdf&quot;, dpi=300)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/4fc8f3f80a3410dded00f4b5126a6c7e32e19831e4438242cb48053a120e335a.png" src="../../_images/4fc8f3f80a3410dded00f4b5126a6c7e32e19831e4438242cb48053a120e335a.png" />
</div>
</div>
</section>
<section id="locomotion-speed-over-time-per-subject">
<h3>2. Locomotion speed over time per subject<a class="headerlink" href="#locomotion-speed-over-time-per-subject" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_speed</span> <span class="o">=</span> <span class="n">df_filtered</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">df_speed</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;time&quot;</span>

<span class="n">dark_color</span> <span class="o">=</span> <span class="s2">&quot;#555555&quot;</span>
<span class="n">light_color</span> <span class="o">=</span> <span class="s2">&quot;#CCCCCC&quot;</span>
<span class="n">subjects</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">df_speed</span><span class="p">[</span><span class="s2">&quot;identity_name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>

<span class="n">agg</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">df_speed</span><span class="p">[[</span><span class="s2">&quot;identity_name&quot;</span><span class="p">,</span> <span class="s2">&quot;speed&quot;</span><span class="p">]]</span>
    <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;identity_name&quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s2">&quot;1s&quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="p">)</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>
<span class="k">for</span> <span class="n">subj</span> <span class="ow">in</span> <span class="n">subjects</span><span class="p">:</span>
    <span class="n">sub</span> <span class="o">=</span> <span class="n">agg</span><span class="p">[</span><span class="n">agg</span><span class="p">[</span><span class="s2">&quot;identity_name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">subj</span><span class="p">]</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
        <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="n">sub</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">],</span>
            <span class="n">y</span><span class="o">=</span><span class="n">sub</span><span class="p">[</span><span class="s2">&quot;speed&quot;</span><span class="p">],</span>
            <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;lines&quot;</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="n">subj</span><span class="p">,</span>
            <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
            <span class="n">opacity</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Speed over Time&quot;</span><span class="p">,</span>
    <span class="n">xaxis_title</span><span class="o">=</span><span class="s2">&quot;Time&quot;</span><span class="p">,</span>
    <span class="n">yaxis_title</span><span class="o">=</span><span class="s2">&quot;Speed&quot;</span><span class="p">,</span>
    <span class="n">legend_title</span><span class="o">=</span><span class="s2">&quot;Subject&quot;</span><span class="p">,</span>
    <span class="n">plot_bgcolor</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># pio.write_image(</span>
<span class="c1">#     fig,</span>
<span class="c1">#     str(save_dir / &quot;speed_over_time.svg&quot;),</span>
<span class="c1">#     format=&quot;svg&quot;</span>
<span class="c1"># )</span>

<span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/13f42be388c7426f76e2d930685dbad770789bdff2f65387a638a3fa14f303c4.png" src="../../_images/13f42be388c7426f76e2d930685dbad770789bdff2f65387a638a3fa14f303c4.png" />
</div>
</div>
</section>
<section id="foraging-bouts-raster-plot">
<h3>3. Foraging bouts raster plot<a class="headerlink" href="#foraging-bouts-raster-plot" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dark_color</span> <span class="o">=</span> <span class="s2">&quot;#555555&quot;</span>
<span class="n">subjects</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">social_foraging_df</span><span class="p">[</span><span class="s2">&quot;subject&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">timeline</span><span class="p">(</span>
    <span class="n">social_foraging_df</span><span class="p">,</span>
    <span class="n">x_start</span><span class="o">=</span><span class="s2">&quot;start&quot;</span><span class="p">,</span>
    <span class="n">x_end</span><span class="o">=</span><span class="s2">&quot;end&quot;</span><span class="p">,</span>
    <span class="n">y</span><span class="o">=</span><span class="s2">&quot;subject&quot;</span><span class="p">,</span>
    <span class="n">hover_data</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;n_pellets&quot;</span><span class="p">,</span> <span class="s2">&quot;cum_wheel_dist&quot;</span><span class="p">],</span>
    <span class="n">category_orders</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;subject&quot;</span><span class="p">:</span> <span class="n">subjects</span><span class="p">},</span>
<span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">update_traces</span><span class="p">(</span>
    <span class="n">opacity</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">marker_color</span><span class="o">=</span><span class="n">dark_color</span><span class="p">,</span>
    <span class="n">marker_line_color</span><span class="o">=</span><span class="n">dark_color</span><span class="p">,</span>
    <span class="n">marker_line_width</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
    <span class="n">template</span><span class="o">=</span><span class="s2">&quot;simple_white&quot;</span><span class="p">,</span>
    <span class="n">plot_bgcolor</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span>
    <span class="n">margin</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">l</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">20</span><span class="p">),</span>
    <span class="n">height</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">subjects</span><span class="p">)</span> <span class="o">*</span> <span class="mi">25</span> <span class="o">+</span> <span class="mi">50</span><span class="p">),</span>
    <span class="n">xaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
        <span class="n">showgrid</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">zeroline</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">showline</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ticks</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">showticklabels</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">),</span>
    <span class="n">yaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
        <span class="n">showgrid</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">zeroline</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">showline</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">ticks</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">showticklabels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="p">),</span>
<span class="p">)</span>

<span class="c1"># pio.write_image(</span>
<span class="c1">#     fig,</span>
<span class="c1">#     str(save_dir / &quot;foraging_bouts_raster.svg&quot;),</span>
<span class="c1">#     format=&quot;svg&quot;</span>
<span class="c1"># )</span>

<span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/7211b5424d4c75c47fdfa180481b53e8c22d5ac4ec9edc53d6bc50f28f04c76b.png" src="../../_images/7211b5424d4c75c47fdfa180481b53e8c22d5ac4ec9edc53d6bc50f28f04c76b.png" />
</div>
</div>
</section>
<section id="wheel-distance-spun">
<h3>4. Wheel distance spun<a class="headerlink" href="#wheel-distance-spun" title="Link to this heading">#</a></h3>
<section id="over-time-per-subject-patch">
<h4>Over time per subject patch<a class="headerlink" href="#over-time-per-subject-patch" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dt_seconds</span> <span class="o">=</span> <span class="mf">0.02</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>

<span class="c1"># Build each trace (continuous + Δ&gt;0.5 downsample)</span>
<span class="n">max_y</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="p">(</span><span class="n">subject</span><span class="p">,</span> <span class="n">patch</span><span class="p">),</span> <span class="n">grp</span> <span class="ow">in</span> <span class="n">social_patch_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;subject_name&quot;</span><span class="p">,</span> <span class="s2">&quot;patch_name&quot;</span><span class="p">]):</span>
    <span class="n">grp</span> <span class="o">=</span> <span class="n">grp</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;block_start&quot;</span><span class="p">)</span>
    <span class="n">total_n</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">grp</span><span class="o">.</span><span class="n">wheel_cumsum_distance_travelled</span><span class="p">)</span>

    <span class="n">times</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">total_n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;datetime64[ns]&quot;</span><span class="p">)</span>
    <span class="n">dists</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">total_n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">idx</span><span class="p">,</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.0</span>

    <span class="k">for</span> <span class="n">bs_val</span><span class="p">,</span> <span class="n">arr</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">grp</span><span class="o">.</span><span class="n">block_start</span><span class="p">,</span> <span class="n">grp</span><span class="o">.</span><span class="n">wheel_cumsum_distance_travelled</span><span class="p">):</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">size</span>
        <span class="n">offs</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">*</span> <span class="n">dt_seconds</span> <span class="o">*</span> <span class="mf">1e9</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;timedelta64[ns]&quot;</span><span class="p">)</span>
        <span class="n">times</span><span class="p">[</span><span class="n">idx</span> <span class="p">:</span> <span class="n">idx</span> <span class="o">+</span> <span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">(</span><span class="n">bs_val</span><span class="p">)</span> <span class="o">+</span> <span class="n">offs</span>
        <span class="n">dists</span><span class="p">[</span><span class="n">idx</span> <span class="p">:</span> <span class="n">idx</span> <span class="o">+</span> <span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">arr</span> <span class="o">+</span> <span class="n">offset</span>
        <span class="n">offset</span> <span class="o">+=</span> <span class="n">arr</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">idx</span> <span class="o">+=</span> <span class="n">n</span>

    <span class="n">max_y</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">max_y</span><span class="p">,</span> <span class="n">dists</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>

    <span class="c1"># Downsample</span>
    <span class="n">diffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">dists</span><span class="p">,</span> <span class="n">prepend</span><span class="o">=</span><span class="n">dists</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">diffs</span> <span class="o">&gt;</span> <span class="mf">0.5</span>
    <span class="n">mask</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
        <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="n">times</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span>
            <span class="n">y</span><span class="o">=</span><span class="n">dists</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span><span class="p">,</span>  <span class="c1"># convert to meters</span>
            <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;lines&quot;</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">subject</span><span class="si">}</span><span class="s2"> — </span><span class="si">{</span><span class="n">patch</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mf">1.5</span><span class="p">),</span>
        <span class="p">)</span>
    <span class="p">)</span>

<span class="c1"># Hide all ticks and tick lines; keep only the y-axis title</span>
<span class="n">fig</span><span class="o">.</span><span class="n">update_xaxes</span><span class="p">(</span>
    <span class="n">showgrid</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">zeroline</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">showline</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">showticklabels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ticks</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
<span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">update_yaxes</span><span class="p">(</span>
    <span class="n">title_text</span><span class="o">=</span><span class="s2">&quot;Distance spun on wheel (m)&quot;</span><span class="p">,</span>
    <span class="n">showgrid</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">zeroline</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">showline</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">showticklabels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">ticks</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Vertical scale bar: 250 m high at the right edge</span>
<span class="n">fig</span><span class="o">.</span><span class="n">add_shape</span><span class="p">(</span>
    <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;line&quot;</span><span class="p">,</span>
    <span class="n">xref</span><span class="o">=</span><span class="s2">&quot;paper&quot;</span><span class="p">,</span>
    <span class="n">x0</span><span class="o">=</span><span class="mf">1.02</span><span class="p">,</span>
    <span class="n">x1</span><span class="o">=</span><span class="mf">1.02</span><span class="p">,</span>
    <span class="n">yref</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span>
    <span class="n">y0</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">y1</span><span class="o">=</span><span class="mi">250</span><span class="p">,</span>
    <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>
<span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">add_annotation</span><span class="p">(</span>
    <span class="n">xref</span><span class="o">=</span><span class="s2">&quot;paper&quot;</span><span class="p">,</span>
    <span class="n">x</span><span class="o">=</span><span class="mf">1.04</span><span class="p">,</span>
    <span class="n">y</span><span class="o">=</span><span class="mi">125</span><span class="p">,</span>
    <span class="n">text</span><span class="o">=</span><span class="s2">&quot;250&quot;</span><span class="p">,</span>
    <span class="n">showarrow</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">xanchor</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
    <span class="n">yanchor</span><span class="o">=</span><span class="s2">&quot;middle&quot;</span><span class="p">,</span>
    <span class="n">font</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">),</span>
<span class="p">)</span>

<span class="c1"># Layout tweaks and show</span>
<span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
    <span class="n">template</span><span class="o">=</span><span class="s2">&quot;simple_white&quot;</span><span class="p">,</span> <span class="n">margin</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">l</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">20</span><span class="p">),</span> <span class="n">showlegend</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>

<span class="c1"># pio.write_image(</span>
<span class="c1">#     fig,</span>
<span class="c1">#     str(save_dir / &quot;wheel_dist_over_time.svg&quot;),</span>
<span class="c1">#     format=&quot;svg&quot;</span>
<span class="c1"># )</span>

<span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">(</span>
    <span class="n">config</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;staticPlot&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/745a3ce3867cda2553a403ee637fedbbf96c7ebdba8b8b0e66043a9f2dc86724.png" src="../../_images/745a3ce3867cda2553a403ee637fedbbf96c7ebdba8b8b0e66043a9f2dc86724.png" />
</div>
</div>
</section>
<section id="dummy-patch-vs-normal-patches">
<h4>Dummy patch vs normal patches<a class="headerlink" href="#dummy-patch-vs-normal-patches" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">patch_dfs</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">exp</span> <span class="ow">in</span> <span class="p">[</span><span class="n">experiments</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]]:</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">load_experiment_data</span><span class="p">(</span><span class="n">experiment</span><span class="o">=</span><span class="n">exp</span><span class="p">,</span> <span class="n">data_dir</span><span class="o">=</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">data_types</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;patch&quot;</span><span class="p">])</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;None_patch&quot;</span><span class="p">]</span>
    <span class="n">patch_dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

<span class="n">patch_df_s4</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">patch_dfs</span><span class="p">)</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dt_seconds</span> <span class="o">=</span> <span class="mf">0.02</span>
<span class="n">summary</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># Compute total distance spun per (subject, patch)</span>
<span class="k">for</span> <span class="p">(</span><span class="n">subject</span><span class="p">,</span> <span class="n">patch</span><span class="p">),</span> <span class="n">grp</span> <span class="ow">in</span> <span class="n">patch_df_s4</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;subject_name&quot;</span><span class="p">,</span> <span class="s2">&quot;patch_name&quot;</span><span class="p">]):</span>
    <span class="n">total_distance</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">w</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">grp</span><span class="p">[</span><span class="s2">&quot;wheel_cumsum_distance_travelled&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="p">)</span>
    <span class="n">summary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="p">{</span><span class="s2">&quot;subject&quot;</span><span class="p">:</span> <span class="n">subject</span><span class="p">,</span> <span class="s2">&quot;patch&quot;</span><span class="p">:</span> <span class="n">patch</span><span class="p">,</span> <span class="s2">&quot;distance&quot;</span><span class="p">:</span> <span class="n">total_distance</span> <span class="o">/</span> <span class="mi">100</span><span class="p">}</span>
    <span class="p">)</span>  <span class="c1"># convert to meters</span>

<span class="n">summary_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">summary</span><span class="p">)</span>

<span class="c1"># Pivot to subject x patch format</span>
<span class="n">pivot_df</span> <span class="o">=</span> <span class="n">summary_df</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s2">&quot;subject&quot;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s2">&quot;patch&quot;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s2">&quot;distance&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span>
    <span class="mi">0</span>
<span class="p">)</span>

<span class="c1"># Per-subject values for PatchDummy1 and mean of other patches</span>
<span class="n">patch_dummy1_vals</span> <span class="o">=</span> <span class="n">pivot_df</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;PatchDummy1&quot;</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">pivot_df</span><span class="o">.</span><span class="n">index</span><span class="p">))</span>
<span class="n">other_patch_vals</span> <span class="o">=</span> <span class="n">pivot_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s2">&quot;PatchDummy1&quot;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Compute means and SEMs</span>
<span class="n">means</span> <span class="o">=</span> <span class="p">[</span><span class="n">patch_dummy1_vals</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">other_patch_vals</span><span class="o">.</span><span class="n">mean</span><span class="p">()]</span>
<span class="n">sems</span> <span class="o">=</span> <span class="p">[</span><span class="n">patch_dummy1_vals</span><span class="o">.</span><span class="n">sem</span><span class="p">(),</span> <span class="n">other_patch_vals</span><span class="o">.</span><span class="n">sem</span><span class="p">()]</span>
<span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;PatchDummy1&quot;</span><span class="p">,</span> <span class="s2">&quot;Avg Other Patches&quot;</span><span class="p">]</span>

<span class="c1"># Plot</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">(</span>
    <span class="n">data</span><span class="o">=</span><span class="p">[</span>
        <span class="n">go</span><span class="o">.</span><span class="n">Bar</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="n">means</span><span class="p">,</span>
            <span class="n">error_y</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="n">array</span><span class="o">=</span><span class="n">sems</span><span class="p">,</span> <span class="n">visible</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
            <span class="n">marker_color</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;#636EFA&quot;</span><span class="p">,</span> <span class="s2">&quot;#EF553B&quot;</span><span class="p">],</span>
        <span class="p">)</span>
    <span class="p">]</span>
<span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Mean Wheel Distance Spun ± SEM&quot;</span><span class="p">,</span>
    <span class="n">yaxis_title</span><span class="o">=</span><span class="s2">&quot;Distance (m, log)&quot;</span><span class="p">,</span>
    <span class="n">xaxis_title</span><span class="o">=</span><span class="s2">&quot;Patch&quot;</span><span class="p">,</span>
    <span class="n">yaxis_type</span><span class="o">=</span><span class="s2">&quot;log&quot;</span><span class="p">,</span>
    <span class="n">template</span><span class="o">=</span><span class="s2">&quot;simple_white&quot;</span><span class="p">,</span>
    <span class="n">height</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># pio.write_image(</span>
<span class="c1">#     fig,</span>
<span class="c1">#     str(save_dir / &quot;dummy_vs_normal_patches.svg&quot;),</span>
<span class="c1">#     format=&quot;svg&quot;</span>
<span class="c1"># )</span>

<span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/9f32bc8686044363b7d0bd19d4b459b40fd34f68b69f122a07246f41227e79cf.png" src="../../_images/9f32bc8686044363b7d0bd19d4b459b40fd34f68b69f122a07246f41227e79cf.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">display</span><span class="p">(</span><span class="n">patch_dummy1_vals</span><span class="p">,</span> <span class="n">other_patch_vals</span><span class="p">)</span>

<span class="n">t_stat</span><span class="p">,</span> <span class="n">p_val</span> <span class="o">=</span> <span class="n">ttest_rel</span><span class="p">(</span><span class="n">patch_dummy1_vals</span><span class="p">,</span> <span class="n">other_patch_vals</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Paired t‐statistic = </span><span class="si">{</span><span class="n">t_stat</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">,  p‐value = </span><span class="si">{</span><span class="n">p_val</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>subject
BAA-1104792    25.288925
BAA-1104794    20.960074
BAA-1104795    24.882764
BAA-1104797     6.401984
Name: PatchDummy1, dtype: float64
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>subject
BAA-1104792    4300.985857
BAA-1104794    3847.328388
BAA-1104795    3551.048284
BAA-1104797    3306.791160
dtype: float64
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Paired t‐statistic = -17.706,  p‐value = 0.0004
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="pellets-raster-plot">
<h3>5. Pellets raster plot<a class="headerlink" href="#pellets-raster-plot" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">social_patch_df</span><span class="p">[[</span><span class="s2">&quot;subject_name&quot;</span><span class="p">,</span> <span class="s2">&quot;patch_name&quot;</span><span class="p">,</span> <span class="s2">&quot;pellet_timestamps&quot;</span><span class="p">]]</span>
    <span class="o">.</span><span class="n">explode</span><span class="p">(</span><span class="s2">&quot;pellet_timestamps&quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;pellet_timestamps&quot;</span><span class="p">])</span>
<span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;pellet_timestamps&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;pellet_timestamps&quot;</span><span class="p">])</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;patch_idx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;patch_name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(\d+)$&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="n">dark_color</span> <span class="o">=</span> <span class="s2">&quot;#555555&quot;</span>
<span class="n">subjects</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;subject_name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
<span class="n">n_subj</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">subjects</span><span class="p">)</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">make_subplots</span><span class="p">(</span><span class="n">rows</span><span class="o">=</span><span class="n">n_subj</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">shared_xaxes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">subplot_titles</span><span class="o">=</span><span class="n">subjects</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">subj</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">subjects</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">sub</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;subject_name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">subj</span><span class="p">]</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
        <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="n">sub</span><span class="p">[</span><span class="s2">&quot;pellet_timestamps&quot;</span><span class="p">],</span>
            <span class="n">y</span><span class="o">=</span><span class="n">sub</span><span class="p">[</span><span class="s2">&quot;patch_idx&quot;</span><span class="p">],</span>
            <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;markers&quot;</span><span class="p">,</span>
            <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">symbol</span><span class="o">=</span><span class="s2">&quot;line-ns&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">dark_color</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">line_width</span><span class="o">=</span><span class="mf">1.2</span><span class="p">),</span>
            <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">row</span><span class="o">=</span><span class="n">i</span><span class="p">,</span>
        <span class="n">col</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1"># Y-axis = patch numbers</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">update_yaxes</span><span class="p">(</span>
        <span class="n">row</span><span class="o">=</span><span class="n">i</span><span class="p">,</span>
        <span class="n">col</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Patches&quot;</span><span class="p">,</span>
        <span class="n">tickmode</span><span class="o">=</span><span class="s2">&quot;array&quot;</span><span class="p">,</span>
        <span class="n">showgrid</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">zeroline</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">showline</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">ticks</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1"># Remove x-labels on every row</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">update_xaxes</span><span class="p">(</span>
        <span class="n">row</span><span class="o">=</span><span class="n">i</span><span class="p">,</span>
        <span class="n">col</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">showticklabels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">showgrid</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">zeroline</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">showline</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">ticks</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="p">)</span>

<span class="c1"># Tighten the margins and overall height</span>
<span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
    <span class="n">template</span><span class="o">=</span><span class="s2">&quot;simple_white&quot;</span><span class="p">,</span>
    <span class="n">plot_bgcolor</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span>
    <span class="n">margin</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">l</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">20</span><span class="p">),</span>
    <span class="n">height</span><span class="o">=</span><span class="mi">120</span> <span class="o">*</span> <span class="n">n_subj</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Center subject titles</span>
<span class="k">for</span> <span class="n">ann</span> <span class="ow">in</span> <span class="n">fig</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">annotations</span><span class="p">:</span>
    <span class="n">ann</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="mf">0.5</span>
    <span class="n">ann</span><span class="o">.</span><span class="n">xanchor</span> <span class="o">=</span> <span class="s2">&quot;center&quot;</span>
    <span class="n">ann</span><span class="o">.</span><span class="n">font</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>

<span class="c1"># pio.write_image(</span>
<span class="c1">#     fig,</span>
<span class="c1">#     str(save_dir / &quot;pellets_raster.svg&quot;),</span>
<span class="c1">#     format=&quot;svg&quot;</span>
<span class="c1"># )</span>

<span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/0913eda17043e25461dd1e1bc53e7b3a3390410e8a0cb0a030b36229a64470a9.png" src="../../_images/0913eda17043e25461dd1e1bc53e7b3a3390410e8a0cb0a030b36229a64470a9.png" />
</div>
</div>
</section>
<section id="weight-over-time">
<h3>6. Weight over time<a class="headerlink" href="#weight-over-time" title="Link to this heading">#</a></h3>
<section id="per-subject-for-a-single-experiment">
<h4>Per subject for a single experiment<a class="headerlink" href="#per-subject-for-a-single-experiment" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Keep only rows that have timestamps</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">social_weight_df</span><span class="p">[</span>
    <span class="n">social_weight_df</span><span class="p">[</span><span class="s2">&quot;timestamps&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">lst</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">lst</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
<span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="c1"># Explode parallel list-columns into long form</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">explode</span><span class="p">([</span><span class="s2">&quot;timestamps&quot;</span><span class="p">,</span> <span class="s2">&quot;weight&quot;</span><span class="p">,</span> <span class="s2">&quot;subject_id&quot;</span><span class="p">])</span>

<span class="c1"># Type conversions</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;timestamps&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;timestamps&quot;</span><span class="p">])</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

<span class="c1"># Plot</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">line</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">x</span><span class="o">=</span><span class="s2">&quot;timestamps&quot;</span><span class="p">,</span>
    <span class="n">y</span><span class="o">=</span><span class="s2">&quot;weight&quot;</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;subject_id&quot;</span><span class="p">,</span>
    <span class="n">markers</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Subject Weights Over Time&quot;</span><span class="p">,</span>
    <span class="n">labels</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;timestamps&quot;</span><span class="p">:</span> <span class="s2">&quot;Time&quot;</span><span class="p">,</span> <span class="s2">&quot;weight&quot;</span><span class="p">:</span> <span class="s2">&quot;Weight&quot;</span><span class="p">,</span> <span class="s2">&quot;subject_id&quot;</span><span class="p">:</span> <span class="s2">&quot;Subject ID&quot;</span><span class="p">},</span>
<span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">legend_title_text</span><span class="o">=</span><span class="s2">&quot;Subject ID&quot;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/a090c8ef5d242b1761a57bd215060336e99385357a8adee755f73bad730109e8.png" src="../../_images/a090c8ef5d242b1761a57bd215060336e99385357a8adee755f73bad730109e8.png" />
</div>
</div>
</section>
<section id="averaged-over-time">
<h4>Averaged over time<a class="headerlink" href="#averaged-over-time" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">social_weight_dfs</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">exp</span> <span class="ow">in</span> <span class="p">[</span><span class="n">experiments</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]]:</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">load_experiment_data</span><span class="p">(</span>
        <span class="n">experiment</span><span class="o">=</span><span class="n">exp</span><span class="p">,</span> <span class="n">data_dir</span><span class="o">=</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;social&quot;</span><span class="p">],</span> <span class="n">data_types</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;social_weight&quot;</span><span class="p">]</span>
    <span class="n">social_weight_dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

<span class="n">social_weight_df_all_exps</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">social_weight_dfs</span><span class="p">)</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Flatten the “array-of-arrays” df into a long DataFrame</span>
<span class="n">records</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">social_weight_df_all_exps</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
    <span class="n">ts</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;timestamps&quot;</span><span class="p">])</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">sids</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;subject_id&quot;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">sid</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">sids</span><span class="p">):</span>
        <span class="n">records</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">t</span><span class="p">,</span> <span class="s2">&quot;subject_id&quot;</span><span class="p">:</span> <span class="n">sid</span><span class="p">,</span> <span class="s2">&quot;weight&quot;</span><span class="p">:</span> <span class="n">weight</span><span class="p">})</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">(</span><span class="n">records</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s2">&quot;subject_id&quot;</span><span class="p">,</span> <span class="s2">&quot;timestamp&quot;</span><span class="p">])</span>
<span class="c1"># Drop rows where subject_id is shorter than 11 characters, removes some erroneous entries</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;subject_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">len</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="mi">11</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Parameters &amp; 24 h cycle grid</span>
<span class="n">sampling_freq</span> <span class="o">=</span> <span class="s2">&quot;10min&quot;</span>  <span class="c1"># resample interval</span>
<span class="c1"># Choose any date at 08:00 to define “day zero”</span>
<span class="n">anchor</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;2020-01-01 </span><span class="si">{</span><span class="n">light_off</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">:00:00&quot;</span><span class="p">)</span>

<span class="c1"># Build the 24 h cycle index</span>
<span class="n">n_steps</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="s2">&quot;1D&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">sampling_freq</span><span class="p">))</span>
<span class="n">cycle_index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">timedelta_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="n">n_steps</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="n">sampling_freq</span><span class="p">)</span>

<span class="c1"># Will hold each mouse’s mean‐day</span>
<span class="n">cycle_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">cycle_index</span><span class="p">)</span>

<span class="c1"># Loop over each mouse, resample, fold into 24 h, average days</span>
<span class="k">for</span> <span class="n">sid</span><span class="p">,</span> <span class="n">grp</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;subject_id&quot;</span><span class="p">):</span>
    <span class="c1"># Series of weight vs time</span>
    <span class="n">ser</span> <span class="o">=</span> <span class="n">grp</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;timestamp&quot;</span><span class="p">)[</span><span class="s2">&quot;weight&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
    <span class="c1"># Collapse any exact-duplicate timestamps</span>
    <span class="n">ser</span> <span class="o">=</span> <span class="n">ser</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

    <span class="c1"># Resample into bins anchored at 08:00, then interpolate</span>
    <span class="n">ser_rs</span> <span class="o">=</span> <span class="n">ser</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">sampling_freq</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">anchor</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">interpolate</span><span class="p">()</span>

    <span class="c1"># Convert each timestamp into its offset (mod 24 h) from the anchor</span>
    <span class="n">offsets</span> <span class="o">=</span> <span class="p">(</span><span class="n">ser_rs</span><span class="o">.</span><span class="n">index</span> <span class="o">-</span> <span class="n">anchor</span><span class="p">)</span> <span class="o">%</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="s2">&quot;1D&quot;</span><span class="p">)</span>
    <span class="n">ser_rs</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">offsets</span>

    <span class="c1"># Average across all days for each offset</span>
    <span class="n">daily</span> <span class="o">=</span> <span class="n">ser_rs</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">ser_rs</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

    <span class="c1"># Align to uniform cycle grid</span>
    <span class="n">cycle_df</span><span class="p">[</span><span class="n">sid</span><span class="p">]</span> <span class="o">=</span> <span class="n">daily</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">cycle_index</span><span class="p">)</span>

<span class="c1"># Baseline‐subtract each mouse’s minimum, then grand‐mean</span>
<span class="n">cycle_df_baselined</span> <span class="o">=</span> <span class="n">cycle_df</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">cycle_df</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">grand_mean</span> <span class="o">=</span> <span class="n">cycle_df_baselined</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">sem</span> <span class="o">=</span> <span class="n">cycle_df_baselined</span><span class="o">.</span><span class="n">sem</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Smooth both mean and SEM with a centered rolling window</span>
<span class="n">window</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">grand_mean_smooth</span> <span class="o">=</span> <span class="n">grand_mean</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">min_periods</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">sem_smooth</span> <span class="o">=</span> <span class="n">sem</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">min_periods</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<span class="c1"># Plot each subject&#39;s mean-day curve in its own subplot</span>
<span class="n">n_subj</span> <span class="o">=</span> <span class="n">cycle_df_baselined</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">n_cols</span> <span class="o">=</span> <span class="mi">4</span>  <span class="c1"># adjust as needed</span>
<span class="n">n_rows</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">n_subj</span> <span class="o">/</span> <span class="n">n_cols</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
    <span class="n">n_rows</span><span class="p">,</span> <span class="n">n_cols</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">3.5</span> <span class="o">*</span> <span class="n">n_cols</span><span class="p">,</span> <span class="mf">2.5</span> <span class="o">*</span> <span class="n">n_rows</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="n">x_hours</span> <span class="o">=</span> <span class="n">cycle_df_baselined</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">/</span> <span class="mi">3600</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">sid</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cycle_df_baselined</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">cycle_df_baselined</span><span class="p">[</span><span class="n">sid</span><span class="p">]</span>
    <span class="n">y_smooth</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">min_periods</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_hours</span><span class="p">,</span> <span class="n">y_smooth</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">sid</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">24</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

<span class="c1"># Remove any unused axes</span>
<span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">[</span><span class="n">n_subj</span><span class="p">:]:</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;24 h weight cycle (baseline-subtracted) per subject&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">1.02</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.04</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Time since </span><span class="si">{</span><span class="n">light_off</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">:00:00 (hours)&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.04</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s2">&quot;Weight (baseline-subtracted)&quot;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="s2">&quot;vertical&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="mf">0.07</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mf">0.97</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="mf">0.90</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/0d6c96109558e4b3da4d0ba67e676e9a0713e85c2dfa3c5df83dcc65f838005e.png" src="../../_images/0d6c96109558e4b3da4d0ba67e676e9a0713e85c2dfa3c5df83dcc65f838005e.png" />
</div>
</div>
</section>
<section id="averaged-over-time-and-subjects">
<h4>Averaged over time and subjects<a class="headerlink" href="#averaged-over-time-and-subjects" title="Link to this heading">#</a></h4>
<p>Baselined by subtracting the minimum of each subject’s 24h mean-day curve</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Flatten the “array-of-arrays” df into a long DataFrame</span>
<span class="n">records</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">social_weight_df_all_exps</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
    <span class="n">ts</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;timestamps&quot;</span><span class="p">])</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">sids</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;subject_id&quot;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">sid</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">sids</span><span class="p">):</span>
        <span class="n">records</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">t</span><span class="p">,</span> <span class="s2">&quot;subject_id&quot;</span><span class="p">:</span> <span class="n">sid</span><span class="p">,</span> <span class="s2">&quot;weight&quot;</span><span class="p">:</span> <span class="n">weight</span><span class="p">})</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">(</span><span class="n">records</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s2">&quot;subject_id&quot;</span><span class="p">,</span> <span class="s2">&quot;timestamp&quot;</span><span class="p">])</span>
<span class="c1"># Drop rows where subject_id is shorter than 11 characters, removes some erroneous entries</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;subject_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">len</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="mi">11</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Parameters &amp; 24 h cycle grid</span>
<span class="n">sampling_freq</span> <span class="o">=</span> <span class="s2">&quot;10min&quot;</span>  <span class="c1"># resample interval</span>
<span class="c1"># Choose any date at 08:00 to define “day zero”</span>
<span class="n">anchor</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;2020-01-01 </span><span class="si">{</span><span class="n">light_off</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">:00:00&quot;</span><span class="p">)</span>

<span class="c1"># Build the 24 h cycle index</span>
<span class="n">n_steps</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="s2">&quot;1D&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">sampling_freq</span><span class="p">))</span>
<span class="n">cycle_index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">timedelta_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="n">n_steps</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="n">sampling_freq</span><span class="p">)</span>

<span class="c1"># Will hold each mouse’s mean‐day</span>
<span class="n">cycle_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">cycle_index</span><span class="p">)</span>

<span class="c1"># Loop over each mouse, resample, fold into 24 h, average days</span>
<span class="k">for</span> <span class="n">sid</span><span class="p">,</span> <span class="n">grp</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;subject_id&quot;</span><span class="p">):</span>
    <span class="c1"># Series of weight vs time</span>
    <span class="n">ser</span> <span class="o">=</span> <span class="n">grp</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;timestamp&quot;</span><span class="p">)[</span><span class="s2">&quot;weight&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
    <span class="c1"># Collapse any exact-duplicate timestamps</span>
    <span class="n">ser</span> <span class="o">=</span> <span class="n">ser</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

    <span class="c1"># Resample into bins anchored at 08:00, then interpolate</span>
    <span class="n">ser_rs</span> <span class="o">=</span> <span class="n">ser</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">sampling_freq</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">anchor</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">interpolate</span><span class="p">()</span>

    <span class="c1"># Convert each timestamp into its offset (mod 24 h) from the anchor</span>
    <span class="n">offsets</span> <span class="o">=</span> <span class="p">(</span><span class="n">ser_rs</span><span class="o">.</span><span class="n">index</span> <span class="o">-</span> <span class="n">anchor</span><span class="p">)</span> <span class="o">%</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="s2">&quot;1D&quot;</span><span class="p">)</span>
    <span class="n">ser_rs</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">offsets</span>

    <span class="c1"># Average across all days for each offset</span>
    <span class="n">daily</span> <span class="o">=</span> <span class="n">ser_rs</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">ser_rs</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

    <span class="c1"># Align to uniform cycle grid</span>
    <span class="n">cycle_df</span><span class="p">[</span><span class="n">sid</span><span class="p">]</span> <span class="o">=</span> <span class="n">daily</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">cycle_index</span><span class="p">)</span>

<span class="c1"># Baseline‐subtract each mouse’s minimum, then grand‐mean</span>
<span class="n">cycle_df_baselined</span> <span class="o">=</span> <span class="n">cycle_df</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">cycle_df</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
<span class="n">grand_mean</span> <span class="o">=</span> <span class="n">cycle_df_baselined</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">sem</span> <span class="o">=</span> <span class="n">cycle_df_baselined</span><span class="o">.</span><span class="n">sem</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Smooth both mean and SEM with a centered rolling window</span>
<span class="n">window</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">grand_mean_smooth</span> <span class="o">=</span> <span class="n">grand_mean</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">min_periods</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">sem_smooth</span> <span class="o">=</span> <span class="n">sem</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">min_periods</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<span class="c1"># Plot mean ± SEM</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">x_hours</span> <span class="o">=</span> <span class="n">cycle_df_baselined</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">/</span> <span class="mi">3600</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_hours</span><span class="p">,</span> <span class="n">grand_mean_smooth</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Mean weight&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span>
    <span class="n">x_hours</span><span class="p">,</span>
    <span class="n">grand_mean_smooth</span> <span class="o">-</span> <span class="n">sem_smooth</span><span class="p">,</span>
    <span class="n">grand_mean_smooth</span> <span class="o">+</span> <span class="n">sem_smooth</span><span class="p">,</span>
    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;± SEM&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Time since </span><span class="si">{</span><span class="n">light_off</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">:00:00 (hours)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Weight (baseline-subtracted)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Average 24 h weight cycle across all mice</span><span class="se">\n</span><span class="s2">(Mean ± SEM)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">24</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/cac9890795f11fdf9763cc9f7435851606c206c98070395a49c755a5760eb259.png" src="../../_images/cac9890795f11fdf9763cc9f7435851606c206c98070395a49c755a5760eb259.png" />
</div>
</div>
<p>Baselined by subtracting the minimum of each subject’s <em>smoothed</em> 24h mean-day curve</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Flatten the “array-of-arrays” df into a long DataFrame</span>
<span class="n">records</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">social_weight_df_all_exps</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
    <span class="n">ts</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;timestamps&quot;</span><span class="p">])</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">sids</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;subject_id&quot;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">sid</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">sids</span><span class="p">):</span>
        <span class="n">records</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">t</span><span class="p">,</span> <span class="s2">&quot;subject_id&quot;</span><span class="p">:</span> <span class="n">sid</span><span class="p">,</span> <span class="s2">&quot;weight&quot;</span><span class="p">:</span> <span class="n">weight</span><span class="p">})</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">(</span><span class="n">records</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s2">&quot;subject_id&quot;</span><span class="p">,</span> <span class="s2">&quot;timestamp&quot;</span><span class="p">])</span>
<span class="c1"># Drop rows where subject_id is shorter than 11 characters, removes some erroneous entries</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;subject_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">len</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="mi">11</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Parameters &amp; 24 h cycle grid</span>
<span class="n">sampling_freq</span> <span class="o">=</span> <span class="s2">&quot;10min&quot;</span>  <span class="c1"># resample interval</span>
<span class="c1"># Choose any date at 08:00 to define “day zero”</span>
<span class="n">anchor</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;2020-01-01 </span><span class="si">{</span><span class="n">light_off</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">:00:00&quot;</span><span class="p">)</span>

<span class="c1"># Build the 24 h cycle index</span>
<span class="n">n_steps</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="s2">&quot;1D&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">sampling_freq</span><span class="p">))</span>
<span class="n">cycle_index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">timedelta_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="n">n_steps</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="n">sampling_freq</span><span class="p">)</span>

<span class="c1"># Will hold each mouse’s mean‐day (unsmoothed)</span>
<span class="n">cycle_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">cycle_index</span><span class="p">)</span>

<span class="c1"># Loop over each mouse, resample, fold into 24 h, average days</span>
<span class="k">for</span> <span class="n">sid</span><span class="p">,</span> <span class="n">grp</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;subject_id&quot;</span><span class="p">):</span>
    <span class="c1"># Series of weight vs time</span>
    <span class="n">ser</span> <span class="o">=</span> <span class="n">grp</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;timestamp&quot;</span><span class="p">)[</span><span class="s2">&quot;weight&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
    <span class="c1"># Collapse any exact-duplicate timestamps</span>
    <span class="n">ser</span> <span class="o">=</span> <span class="n">ser</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

    <span class="c1"># Resample into bins anchored at 08:00, then interpolate</span>
    <span class="n">ser_rs</span> <span class="o">=</span> <span class="n">ser</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">sampling_freq</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">anchor</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">interpolate</span><span class="p">()</span>

    <span class="c1"># Convert each timestamp into its offset (mod 24 h) from the anchor</span>
    <span class="n">offsets</span> <span class="o">=</span> <span class="p">(</span><span class="n">ser_rs</span><span class="o">.</span><span class="n">index</span> <span class="o">-</span> <span class="n">anchor</span><span class="p">)</span> <span class="o">%</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="s2">&quot;1D&quot;</span><span class="p">)</span>
    <span class="n">ser_rs</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">offsets</span>

    <span class="c1"># Average across all days for each offset</span>
    <span class="n">daily</span> <span class="o">=</span> <span class="n">ser_rs</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">ser_rs</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

    <span class="c1"># Align to uniform cycle grid</span>
    <span class="n">cycle_df</span><span class="p">[</span><span class="n">sid</span><span class="p">]</span> <span class="o">=</span> <span class="n">daily</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">cycle_index</span><span class="p">)</span>

<span class="c1"># Baseline‐subtract using each subject’s smoothed minimum</span>
<span class="n">window</span> <span class="o">=</span> <span class="mi">20</span>  <span class="c1"># keep same smoothing window for per‐subject curves</span>
<span class="c1"># Smooth each column (i.e., each subject’s 24 h curve)</span>
<span class="n">cycle_df_smooth</span> <span class="o">=</span> <span class="n">cycle_df</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">min_periods</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<span class="c1"># Find the minimum of each subject’s smoothed curve</span>
<span class="n">minima_smooth</span> <span class="o">=</span> <span class="n">cycle_df_smooth</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>  <span class="c1"># series indexed by subject_id</span>

<span class="c1"># Subtract that baseline from the UNSMOOTHED cycle for each subject</span>
<span class="n">cycle_df_baselined</span> <span class="o">=</span> <span class="n">cycle_df</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">minima_smooth</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Now compute grand‐mean and SEM (over baselined, unsmoothed curves)</span>
<span class="n">grand_mean</span> <span class="o">=</span> <span class="n">cycle_df_baselined</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">sem</span> <span class="o">=</span> <span class="n">cycle_df_baselined</span><span class="o">.</span><span class="n">sem</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Smooth both grand‐mean and SEM for plotting</span>
<span class="n">grand_mean_smooth</span> <span class="o">=</span> <span class="n">grand_mean</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">min_periods</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">sem_smooth</span> <span class="o">=</span> <span class="n">sem</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">min_periods</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<span class="c1"># Plot mean ± SEM</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">x_hours</span> <span class="o">=</span> <span class="n">cycle_df_baselined</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">/</span> <span class="mi">3600</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_hours</span><span class="p">,</span> <span class="n">grand_mean_smooth</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Mean weight (baselined)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span>
    <span class="n">x_hours</span><span class="p">,</span>
    <span class="n">grand_mean_smooth</span> <span class="o">-</span> <span class="n">sem_smooth</span><span class="p">,</span>
    <span class="n">grand_mean_smooth</span> <span class="o">+</span> <span class="n">sem_smooth</span><span class="p">,</span>
    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;± SEM&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Time since </span><span class="si">{</span><span class="n">light_off</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">:00:00 (hours)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Weight (baseline‐subtracted)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Average 24 h weight cycle across all mice</span><span class="se">\n</span><span class="s2">(Mean ± SEM)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">24</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

<span class="c1"># svg_path = save_dir / &quot;24h_weight_cycle.svg&quot;</span>
<span class="c1"># plt.savefig(str(svg_path), format=&#39;svg&#39;)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/6e3c56248a9397950635bdffe3427c73ee4f5baedd4cb883e2d5683f956bd5b6.png" src="../../_images/6e3c56248a9397950635bdffe3427c73ee4f5baedd4cb883e2d5683f956bd5b6.png" />
</div>
</div>
</section>
</section>
</section>
</section>


                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="io_api_example_copy.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Data access using the low-level API</p>
      </div>
    </a>
    <a class="right-next"
       href="social_analysis2.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Platform paper social experiment analysis: Part 2</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <dialog id="pst-secondary-sidebar-modal"></dialog>
                <div id="pst-secondary-sidebar" class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
<div
    id="pst-page-navigation-heading-2"
    class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc" aria-labelledby="pst-page-navigation-heading-2">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#set-up-environment">Set up environment</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#import-libraries-and-define-variables-and-helper-functions">Import libraries and define variables and helper functions</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#dominance-plots">Dominance plots</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#load-data">Load data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#fights-and-retreats-raster-plots">1. Fights and retreats raster plots</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#proportion-of-retreat-event-wins-over-time-during-social-period">2. Proportion of retreat event wins over time during social period</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#pre-during-post-tube-test-comparison">3. Pre/during/post tube test comparison</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#dominance-summary-plot">4. Dominance summary plot</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#dominant-vs-subordinate-comparison-of-time-spent-and-distance-spun-at-best-patch">5. Dominant vs subordinate comparison of time spent and distance spun at best patch</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#patch-preference-plots">Patch preference plots</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">Load data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#wheel-distance-spun-per-block-averaged-by-the-number-of-mice">1. Wheel distance spun per block, averaged by the number of mice</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#number-of-patch-switches-by-each-mouse-per-block">2. Number of patch switches by each mouse per block</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data-overview-plot">Data overview plot</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">Load data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#position-heatmaps-over-time-per-subject">1. Position heatmaps over time per subject</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#locomotion-speed-over-time-per-subject">2. Locomotion speed over time per subject</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#foraging-bouts-raster-plot">3. Foraging bouts raster plot</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#wheel-distance-spun">4. Wheel distance spun</a><ul class="visible nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#over-time-per-subject-patch">Over time per subject patch</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#dummy-patch-vs-normal-patches">Dummy patch vs normal patches</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#pellets-raster-plot">5. Pellets raster plot</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#weight-over-time">6. Weight over time</a><ul class="visible nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#per-subject-for-a-single-experiment">Per subject for a single experiment</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#averaged-over-time">Averaged over time</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#averaged-over-time-and-subjects">Averaged over time and subjects</a></li>
</ul>
</li>
</ul>
</li>
</ul>
  </nav></div>

  <div class="sidebar-secondary-item">
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/user/how_to/social_analysis1_static.ipynb.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item"><p class="sphinx-version"></p>
    Created using <a href="https://sphinx-doc.org/">Sphinx</a> 8.2.3.
    <br/>
    </p>
    <p class="theme-version">
    Built with the
    <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a>
    0.16.1.
    </p></div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item"><div class="things-in-a-row">
    <a href="https://neurogears.org/">
        <img src="../../_static/images/light-logo-neurogears.png" alt="Sponsors" class="only-light img-sponsor"/>
        <img src="../../_static/images/dark-logo-neurogears.png" alt="Sponsors" class="only-dark img-sponsor"/>
    </a>
    <a href="https://www.datajoint.com/">
        <img src="../../_static/images/light-logo-datajoint.png" alt="Sponsors" class="only-light img-sponsor"/>
        <img src="../../_static/images/dark-logo-datajoint.png" alt="Sponsors" class="only-dark img-sponsor"/>
    </a>
    <a href="https://wellcome.org/">
        <img src="../../_static/images/light-logo-wellcome.png" alt="Sponsors" class="only-light img-sponsor"/>
        <img src="../../_static/images/dark-logo-wellcome.png" alt="Sponsors" class="only-dark img-sponsor"/>
    </a>
    <a href="https://www.sainsburywellcome.org/web/">
        <img src="../../_static/images/light-logo-swc.png" alt="Sponsors" class="only-light img-sponsor"/>
        <img src="../../_static/images/dark-logo-swc.png" alt="Sponsors" class="only-dark img-sponsor"/>
    </a>
    <a href="https://www.ucl.ac.uk/">
        <img src="../../_static/images/light-logo-ucl.png" alt="Sponsors" class="only-light img-sponsor"/>
        <img src="../../_static/images/dark-logo-ucl.png" alt="Sponsors" class="only-dark img-sponsor"/>
    </a>
    <a href="https://www.ucl.ac.uk/life-sciences/gatsby">
        <img src="../../_static/images/light-logo-gatsby.png" alt="Sponsors" class="only-light img-sponsor"/>
        <img src="../../_static/images/dark-logo-gatsby.png" alt="Sponsors" class="only-dark img-sponsor"/>
    </a>
    <a href="https://www.ukri.org/councils/bbsrc/">
        <img src="../../_static/images/light-logo-bbsrc.png" alt="Sponsors" class="only-light img-sponsor"/>
        <img src="../../_static/images/dark-logo-bbsrc.png" alt="Sponsors" class="only-dark img-sponsor"/>
    </a>
    <a href="https://www.simonsfoundation.org/">
        <img src="../../_static/images/light-logo-simons.png" alt="Sponsors" class="only-light img-sponsor"/>
        <img src="../../_static/images/dark-logo-simons.png" alt="Sponsors" class="only-dark img-sponsor"/>
    </a>
</div></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>