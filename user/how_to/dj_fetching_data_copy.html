
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>DataJoint pipeline: Fetching data as DataFrames &#8212; Aeon  documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/custom.css?v=9651da53" />
  
  <!-- So that users can add custom icons -->
  <script src="../../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'user/how_to/dj_fetching_data_copy';</script>
    <script src="../../_static/js/workflow.js?v=1800024c"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="DataJoint pipeline: On-premises deployment" href="dj_pipeline_local_deployment.html" />
    <link rel="prev" title="DataJoint pipeline: Data ingestion and processing" href="dj_data_ingestion_and_processing.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>
<aside class="bd-header-announcement" aria-label="Announcement">
  <div class="bd-header-announcement__content">This website is currently under active development. Please report any issues on <a href='https://github.com/SainsburyWellcomeCentre/aeon_docs/issues'>GitHub</a>.</div>
</aside>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
  
  
    <p class="title logo__title">Aeon </p>
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../getting_started/index.html">
    Getting Started
  </a>
</li>


<li class="nav-item current active">
  <a class="nav-link nav-internal" href="../index.html">
    User Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../contributor/index.html">
    Contributor’s Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../reference/index.html">
    Reference
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../about/index.html">
    About
  </a>
</li>

  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
        </div>
      
      
        <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/SainsburyWellcomeCentre/aeon_docs" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
    </div>
  

  
    <button class="pst-navbar-icon sidebar-toggle secondary-toggle" aria-label="On this page">
      <span class="fa-solid fa-outdent"></span>
    </button>
  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../getting_started/index.html">
    Getting Started
  </a>
</li>


<li class="nav-item current active">
  <a class="nav-link nav-internal" href="../index.html">
    User Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../contributor/index.html">
    Contributor’s Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../reference/index.html">
    Reference
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../about/index.html">
    About
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/SainsburyWellcomeCentre/aeon_docs" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
<nav class="bd-docs-nav bd-links"
     aria-label="Section Navigation">
  <p class="bd-links__title" role="heading" aria-level="1">Section Navigation</p>
  <div class="bd-toc-item navbar-nav"><ul class="current nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../aeon_modules.html">Aeon Modules</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../aeon_modules/hardware.html">Hardware Assembly</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../aeon_modules/hardware/commutation_translation.html">Commutation-Translation System</a></li>
<li class="toctree-l3"><a class="reference internal" href="../aeon_modules/hardware/foraging_patch.html">Foraging Patch</a></li>
<li class="toctree-l3"><a class="reference internal" href="../aeon_modules/hardware/habitat.html">Habitat</a></li>
<li class="toctree-l3"><a class="reference internal" href="../aeon_modules/hardware/nest.html">Nest</a></li>
<li class="toctree-l3"><a class="reference internal" href="../aeon_modules/connections/camera.html">Camera Wiring Schematic</a></li>
<li class="toctree-l3"><a class="reference internal" href="../aeon_modules/connections/camera_controller.html">Camera Controller Wiring Schematic</a></li>
<li class="toctree-l3"><a class="reference internal" href="../aeon_modules/connections/commutation_translation_system.html">Commutation-Translation System Wiring Schematic</a></li>
<li class="toctree-l3"><a class="reference internal" href="../aeon_modules/connections/foraging_patch.html">Foraging Patch Wiring Schematic</a></li>
<li class="toctree-l3"><a class="reference internal" href="../aeon_modules/connections/foraging_patch_output_expander.html">Foraging Patch Output Expander Wiring Schematic</a></li>
<li class="toctree-l3"><a class="reference internal" href="../aeon_modules/connections/microphone.html">Microphone Wiring Schematic</a></li>
<li class="toctree-l3"><a class="reference internal" href="../aeon_modules/connections/rfid_reader.html">RFID Reader Wiring Schematic</a></li>
<li class="toctree-l3"><a class="reference internal" href="../aeon_modules/connections/sound_card.html">Sound Card Wiring Schematic</a></li>
<li class="toctree-l3"><a class="reference internal" href="../aeon_modules/connections/timestamp_generator.html">Timestamp Generator Wiring Schematic</a></li>
<li class="toctree-l3"><a class="reference internal" href="../aeon_modules/connections/weighing_scale.html">Weighing Scale Wiring Schematic</a></li>
</ul>
</details></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../aeon_modules/acquisition.html">Acquisition Modules</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../aeon_modules/acquisition/activity_tracking.html">Activity Tracking</a></li>
<li class="toctree-l3"><a class="reference internal" href="../aeon_modules/acquisition/alerts.html">Alerts</a></li>
<li class="toctree-l3"><a class="reference internal" href="../aeon_modules/acquisition/camera.html">Spinnaker Camera</a></li>
<li class="toctree-l3"><a class="reference internal" href="../aeon_modules/acquisition/camera_controller.html">Multi-Camera Controller</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../aeon_modules/acquisition/control_panel.html">Control Panel</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l4"><a class="reference internal" href="../aeon_modules/acquisition/control_panel/annotation_source_GUI.html">AnnotationSource</a></li>
<li class="toctree-l4"><a class="reference internal" href="../aeon_modules/acquisition/control_panel/button_source_GUI.html">ButtonSource</a></li>
<li class="toctree-l4"><a class="reference internal" href="../aeon_modules/acquisition/control_panel/environment_state_GUI.html">EnvironmentState</a></li>
<li class="toctree-l4"><a class="reference internal" href="../aeon_modules/acquisition/control_panel/experiment_properties_GUI.html">ExperimentProperties</a></li>
<li class="toctree-l4"><a class="reference internal" href="../aeon_modules/acquisition/control_panel/label_control_GUI.html">LabelControl</a></li>
<li class="toctree-l4"><a class="reference internal" href="../aeon_modules/acquisition/control_panel/subject_database.html">SubjectDatabase <!--TODO: Placeholder content--></a></li>
</ul>
</details></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../aeon_modules/acquisition/foraging_patch.html">Foraging Patch</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l4"><a class="reference internal" href="../aeon_modules/acquisition/foraging_patch/patch_dispenser.html">PatchDispenser</a></li>
<li class="toctree-l4"><a class="reference internal" href="../aeon_modules/acquisition/foraging_patch/pellet_monitor.html">PelletMonitor</a></li>
<li class="toctree-l4"><a class="reference internal" href="../aeon_modules/acquisition/foraging_patch/time_since_last_event.html">TimeSinceLastEvent</a></li>
<li class="toctree-l4"><a class="reference internal" href="../aeon_modules/acquisition/foraging_patch/time_spent_on_wheel.html">TimeSpentOnWheel</a></li>
</ul>
</details></li>
<li class="toctree-l3"><a class="reference internal" href="../aeon_modules/acquisition/logging.html">Logging</a></li>
<li class="toctree-l3"><a class="reference internal" href="../aeon_modules/acquisition/monitors.html">Device Synchronisation Monitors</a></li>
<li class="toctree-l3"><a class="reference internal" href="../aeon_modules/acquisition/nest.html">Nest</a></li>
<li class="toctree-l3"><a class="reference internal" href="../aeon_modules/acquisition/rfid_reader.html">RFID Reader</a></li>
<li class="toctree-l3"><a class="reference internal" href="../aeon_modules/acquisition/subject_tracking.html">Subject Tracking</a></li>
</ul>
</details></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../sample_datasets.html">Sample Datasets</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../tutorials.html">Tutorials</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../tutorials/aeon_dj_pipeline.html">DataJoint pipeline for Aeon</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorials/general_experimental_workflow.html">General experimental workflow infrastructure</a></li>
</ul>
</details></li>
<li class="toctree-l1 current active has-children"><a class="reference internal" href="../how_to.html">How-to Guides</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="dj_compute_bouts_copy.html">DataJoint pipeline: Computing behavioural bouts</a></li>
<li class="toctree-l2"><a class="reference internal" href="dj_data_ingestion_and_processing.html">DataJoint pipeline: Data ingestion and processing</a></li>
<li class="toctree-l2 current active"><a class="current reference internal" href="#">DataJoint pipeline: Fetching data as DataFrames</a></li>
<li class="toctree-l2"><a class="reference internal" href="dj_pipeline_local_deployment.html">DataJoint pipeline: On-premises deployment</a></li>
<li class="toctree-l2"><a class="reference internal" href="dj_querying_data_copy.html">DataJoint pipeline: Querying data</a></li>
<li class="toctree-l2"><a class="reference internal" href="hmm_example.html">Hidden Markov Model analysis of mouse behavioural syntax</a></li>
<li class="toctree-l2"><a class="reference internal" href="io_api_example_copy.html">Data access using the low-level API</a></li>
<li class="toctree-l2"><a class="reference internal" href="social_analysis1_static.html">Platform paper social experiment analysis: Part 1</a></li>
<li class="toctree-l2"><a class="reference internal" href="social_analysis2.html">Platform paper social experiment analysis: Part 2</a></li>
</ul>
</details></li>
</ul>
</div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../index.html" class="nav-link">User Guide</a></li>
    
    
    <li class="breadcrumb-item"><a href="../how_to.html" class="nav-link">How-to Guides</a></li>
    
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">DataJoint pipeline: Fetching data as DataFrames</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="datajoint-pipeline-fetching-data-as-dataframes">
<span id="target-dj-fetching-data"></span><h1>DataJoint pipeline: Fetching data as DataFrames<a class="headerlink" href="#datajoint-pipeline-fetching-data-as-dataframes" title="Link to this heading">#</a></h1>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>This guide assumes you have a <a class="reference internal" href="dj_pipeline_local_deployment.html#target-dj-pipeline-deployment"><span class="std std-ref">DataJoint pipeline deployed</span></a> with <a class="reference internal" href="dj_data_ingestion_and_processing.html#target-dj-data-ingestion-processing"><span class="std std-ref">data already ingested</span></a>.</p>
</div>
<p>This guide builds upon the <a class="reference internal" href="dj_querying_data_copy.html#target-dj-querying-data"><span class="std std-ref">Querying data</span></a> guide and provides further examples on fetching various kinds of data as <code class="docutils literal notranslate"><span class="pre">pandas.DataFrames</span></code> from the <a class="reference internal" href="../tutorials/aeon_dj_pipeline.html#target-aeon-dj-pipeline"><span class="std std-ref">Aeon DataJoint pipeline</span></a>.</p>
<p>You can also run this notebook online at <a class="reference external" href="https://works.datajoint.com/"><code class="docutils literal notranslate"><span class="pre">works.datajoint.com</span></code></a> using the following credentials:</p>
<ul class="simple">
<li><p>Username: aeondemo</p></li>
<li><p>Password: aeon_djworks</p></li>
</ul>
<p>To access it, go to the Notebook tab at the top and in the File Browser on the left, navigate to <code class="docutils literal notranslate"><span class="pre">ucl-swc_aeon</span> <span class="pre">&gt;</span> <span class="pre">docs</span> <span class="pre">&gt;</span> <span class="pre">examples</span></code>, where this notebook <code class="docutils literal notranslate"><span class="pre">dj_fetching_data.ipynb</span></code> is located.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The examples here use the <em>social</em> period of the <a class="reference internal" href="../sample_datasets.html#target-full-datasets"><span class="std std-ref">social0.2-aeon4</span></a> dataset which spans 2 weeks.
To keep examples concise, we limit retrieval to the first 3 days for all data types except for position, which is restricted to the first light-dark cycle.</p>
<p>If you are using a different dataset, be sure to replace the experiment name and parameters in the code below accordingly.</p>
</div>
<section id="import-libraries-and-define-variables-and-helper-functions">
<h2>Import libraries and define variables and helper functions<a class="headerlink" href="#import-libraries-and-define-variables-and-helper-functions" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.cm</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">cm</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.colors</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mcolors</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mpl</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">aeon.dj_pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">acquisition</span><span class="p">,</span> <span class="n">streams</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="n">tracking</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">aeon.dj_pipeline.analysis.block_analysis</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">Block</span><span class="p">,</span>
    <span class="n">BlockAnalysis</span><span class="p">,</span>
    <span class="n">BlockSubjectAnalysis</span><span class="p">,</span>
    <span class="n">BlockForaging</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">ensure_ts_arr_datetime</span><span class="p">(</span><span class="n">array</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Ensure array is a numpy array of datetime64[ns] type.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">array</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;datetime64[ns]&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;datetime64[ns]&quot;</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">next_light_dark_cycle</span><span class="p">(</span><span class="n">start_dt</span><span class="p">,</span> <span class="n">light_off</span><span class="p">,</span> <span class="n">light_on</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the nearest 24-hour window aligned with the start of a light/dark cycle. &quot;&quot;&quot;</span>
    <span class="n">date</span> <span class="o">=</span> <span class="n">start_dt</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
    <span class="n">light_off_dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="n">time</span><span class="p">(</span><span class="n">light_off</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
    <span class="n">light_on_dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="n">time</span><span class="p">(</span><span class="n">light_on</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">start_dt</span> <span class="o">&lt;</span> <span class="n">light_off_dt</span><span class="p">:</span>
        <span class="n">new_start_dt</span> <span class="o">=</span> <span class="n">light_off_dt</span>
    <span class="k">elif</span> <span class="n">start_dt</span> <span class="o">&lt;</span> <span class="n">light_on_dt</span><span class="p">:</span>
        <span class="n">new_start_dt</span> <span class="o">=</span> <span class="n">light_on_dt</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">next_day</span> <span class="o">=</span> <span class="n">date</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">new_start_dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">next_day</span><span class="p">,</span> <span class="n">time</span><span class="p">(</span><span class="n">light_off</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
    <span class="n">new_end_dt</span> <span class="o">=</span> <span class="n">new_start_dt</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">new_start_dt</span><span class="p">,</span> <span class="n">new_end_dt</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">exp</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;social0.2-aeon4&quot;</span><span class="p">,</span>
    <span class="s2">&quot;presocial_start&quot;</span><span class="p">:</span> <span class="s2">&quot;2024-01-31 11:00:00&quot;</span><span class="p">,</span>
    <span class="s2">&quot;presocial_end&quot;</span><span class="p">:</span> <span class="s2">&quot;2024-02-08 15:00:00&quot;</span><span class="p">,</span>
    <span class="s2">&quot;social_start&quot;</span><span class="p">:</span> <span class="s2">&quot;2024-02-09 17:00:00&quot;</span><span class="p">,</span>
    <span class="s2">&quot;social_end&quot;</span><span class="p">:</span> <span class="s2">&quot;2024-02-23 12:00:00&quot;</span><span class="p">,</span>
    <span class="s2">&quot;postsocial_start&quot;</span><span class="p">:</span> <span class="s2">&quot;2024-02-25 18:00:00&quot;</span><span class="p">,</span>
    <span class="s2">&quot;postsocial_end&quot;</span><span class="p">:</span> <span class="s2">&quot;2024-03-02 13:00:00&quot;</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">key</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;experiment_name&quot;</span><span class="p">:</span> <span class="n">exp</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]}</span>
<span class="n">light_off</span><span class="p">,</span> <span class="n">light_on</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">20</span>  <span class="c1"># 7am to 8pm</span>
<span class="n">cm2px</span> <span class="o">=</span> <span class="mf">5.2</span>  <span class="c1"># 1 cm = 5.2 px roughly for top camera</span>
<span class="n">dark_color</span> <span class="o">=</span> <span class="s2">&quot;#555555&quot;</span>
<span class="n">light_color</span> <span class="o">=</span> <span class="s2">&quot;#CCCCCC&quot;</span>

<span class="c1"># Define periods</span>
<span class="n">periods</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;presocial&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">exp</span><span class="p">[</span><span class="s2">&quot;presocial_start&quot;</span><span class="p">],</span> <span class="n">exp</span><span class="p">[</span><span class="s2">&quot;presocial_end&quot;</span><span class="p">]),</span>
    <span class="s2">&quot;social&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">exp</span><span class="p">[</span><span class="s2">&quot;social_start&quot;</span><span class="p">],</span> <span class="n">exp</span><span class="p">[</span><span class="s2">&quot;social_end&quot;</span><span class="p">]),</span>
    <span class="s2">&quot;postsocial&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">exp</span><span class="p">[</span><span class="s2">&quot;postsocial_start&quot;</span><span class="p">],</span> <span class="n">exp</span><span class="p">[</span><span class="s2">&quot;postsocial_end&quot;</span><span class="p">]),</span>
<span class="p">}</span>
<span class="c1"># Select the social period and limit to first 3 days for brevity</span>
<span class="n">period_name</span> <span class="o">=</span> <span class="s2">&quot;social&quot;</span>
<span class="n">start</span> <span class="o">=</span> <span class="n">periods</span><span class="p">[</span><span class="n">period_name</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="n">start_dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span>
<span class="n">end_dt</span> <span class="o">=</span> <span class="n">start_dt</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="position-data">
<h2>Position data<a class="headerlink" href="#position-data" title="Link to this heading">#</a></h2>
<p>Raw <a class="reference internal" href="../../getting_started/multianimal_tracking.html#target-multianimal-tracking"><span class="std std-ref">multi-animal SLEAP tracking data</span></a> is stored in the <code class="docutils literal notranslate"><span class="pre">tracking.SLEAPTracking</span></code> tables.
This data undergoes post-processing to denoise trajectories and correct identity swaps, but only for the anchor node—in this case, the centroid.
The corrected positions are then stored in the <code class="docutils literal notranslate"><span class="pre">tracking.DenoisedTracking</span></code> table.</p>
<p>Here, we will extract these centroid positions from the <code class="docutils literal notranslate"><span class="pre">tracking.DenoisedTracking</span></code> table for each subject across all <a class="reference internal" href="../../reference/glossary.html#term-Acquisition-Chunk"><span class="xref std std-term">chunks</span></a> occurring within the first 24-hour window aligned with the start of a light/dark cycle during the social period.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The full pose data with all tracked body parts can be fetched from the <code class="docutils literal notranslate"><span class="pre">tracking.SLEAPTracking.Part</span></code> table.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">load_position_data</span><span class="p">(</span>
    <span class="n">key</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">period_start</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">period_end</span><span class="p">:</span> <span class="nb">str</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Loads position data (centroid tracking) for a specified time period.</span>

<span class="sd">    Args:</span>
<span class="sd">        key (dict): Key to identify experiment data (e.g., {&quot;experiment_name&quot;: &quot;Exp1&quot;}).</span>
<span class="sd">        period_start (str): Start datetime of the time period.</span>
<span class="sd">        period_end (str): End datetime of the time period.</span>

<span class="sd">    Returns:</span>
<span class="sd">        pd.DataFrame: DataFrame containing position data for the specified period.</span>
<span class="sd">                     Returns an empty DataFrame if no data found.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Querying data from </span><span class="si">{</span><span class="n">period_start</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">period_end</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
        <span class="c1"># Create chunk restriction for the time period</span>
        <span class="n">chunk_restriction</span> <span class="o">=</span> <span class="n">acquisition</span><span class="o">.</span><span class="n">create_chunk_restriction</span><span class="p">(</span>
            <span class="n">key</span><span class="p">[</span><span class="s2">&quot;experiment_name&quot;</span><span class="p">],</span> <span class="n">period_start</span><span class="p">,</span> <span class="n">period_end</span>
        <span class="p">)</span>
        <span class="c1"># Fetch centroid tracking data for the specified period</span>
        <span class="n">centroid_df</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">streams</span><span class="o">.</span><span class="n">SpinnakerVideoSource</span> <span class="o">*</span> <span class="n">tracking</span><span class="o">.</span><span class="n">DenoisedTracking</span><span class="o">.</span><span class="n">Subject</span>
            <span class="o">&amp;</span> <span class="n">key</span>
            <span class="o">&amp;</span> <span class="p">{</span><span class="s2">&quot;spinnaker_video_source_name&quot;</span><span class="p">:</span> <span class="s2">&quot;CameraTop&quot;</span><span class="p">}</span>
            <span class="o">&amp;</span> <span class="n">chunk_restriction</span>
        <span class="p">)</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="s2">&quot;frame&quot;</span><span class="p">)</span>
        <span class="n">centroid_df</span> <span class="o">=</span> <span class="n">centroid_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">centroid_df</span> <span class="o">=</span> <span class="n">centroid_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
            <span class="n">columns</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;subject_name&quot;</span><span class="p">:</span> <span class="s2">&quot;identity_name&quot;</span><span class="p">,</span>
                <span class="s2">&quot;timestamps&quot;</span><span class="p">:</span> <span class="s2">&quot;time&quot;</span><span class="p">,</span>
                <span class="s2">&quot;subject_likelihood&quot;</span><span class="p">:</span> <span class="s2">&quot;identity_likelihood&quot;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="n">centroid_df</span> <span class="o">=</span> <span class="n">centroid_df</span><span class="o">.</span><span class="n">explode</span><span class="p">(</span>
            <span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="s2">&quot;identity_likelihood&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;likelihood&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">centroid_df</span> <span class="o">=</span> <span class="n">centroid_df</span><span class="p">[</span>
            <span class="p">[</span>
                <span class="s2">&quot;time&quot;</span><span class="p">,</span>
                <span class="s2">&quot;experiment_name&quot;</span><span class="p">,</span>
                <span class="s2">&quot;identity_name&quot;</span><span class="p">,</span>
                <span class="s2">&quot;identity_likelihood&quot;</span><span class="p">,</span>
                <span class="s2">&quot;x&quot;</span><span class="p">,</span>
                <span class="s2">&quot;y&quot;</span><span class="p">,</span>
                <span class="s2">&quot;likelihood&quot;</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">]</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">)</span>
        <span class="c1"># Clean up the dataframe</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">centroid_df</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">centroid_df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;spinnaker_video_source_name&quot;</span> <span class="ow">in</span> <span class="n">centroid_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">centroid_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;spinnaker_video_source_name&quot;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">centroid_df</span> <span class="o">=</span> <span class="n">centroid_df</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()[</span><span class="n">period_start</span><span class="p">:</span><span class="n">period_end</span><span class="p">]</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Retrieved </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">centroid_df</span><span class="p">)</span><span class="si">}</span><span class="s2"> rows of position data&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  No data found for the specified period&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">centroid_df</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;  Error loading position data for </span><span class="si">{</span><span class="n">key</span><span class="p">[</span><span class="s1">&#39;experiment_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">period_start</span><span class="si">}</span><span class="s2"> &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;to </span><span class="si">{</span><span class="n">period_end</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>


<span class="c1"># Load position data</span>
<span class="c1"># If this takes too long, consider changing light_dark_cycle_end to an earlier time</span>
<span class="n">light_dark_cycle_start</span><span class="p">,</span> <span class="n">light_dark_cycle_end</span> <span class="o">=</span> <span class="n">next_light_dark_cycle</span><span class="p">(</span><span class="n">start_dt</span><span class="p">,</span> <span class="n">light_off</span><span class="p">,</span> <span class="n">light_on</span><span class="p">)</span>
<span class="n">position_df</span> <span class="o">=</span> <span class="n">load_position_data</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">light_dark_cycle_start</span><span class="p">,</span> <span class="n">light_dark_cycle_end</span><span class="p">)</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  Querying data from 2024-02-09 20:00:00 to 2024-02-10 20:00:00...
  Retrieved 6487333 rows of position data
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">position_df</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>experiment_name</th>
      <th>identity_name</th>
      <th>identity_likelihood</th>
      <th>x</th>
      <th>y</th>
      <th>likelihood</th>
    </tr>
    <tr>
      <th>time</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2024-02-09 20:00:00.000</th>
      <td>social0.2-aeon4</td>
      <td>BAA-1104048</td>
      <td>0.999994</td>
      <td>179.181152</td>
      <td>597.614685</td>
      <td>0.977871</td>
    </tr>
    <tr>
      <th>2024-02-09 20:00:00.000</th>
      <td>social0.2-aeon4</td>
      <td>BAA-1104048</td>
      <td>0.999994</td>
      <td>179.181152</td>
      <td>597.614685</td>
      <td>0.977871</td>
    </tr>
    <tr>
      <th>2024-02-09 20:00:00.000</th>
      <td>social0.2-aeon4</td>
      <td>BAA-1104049</td>
      <td>0.94294</td>
      <td>1237.617676</td>
      <td>576.79834</td>
      <td>0.977871</td>
    </tr>
    <tr>
      <th>2024-02-09 20:00:00.000</th>
      <td>social0.2-aeon4</td>
      <td>BAA-1104049</td>
      <td>0.94294</td>
      <td>1237.617676</td>
      <td>576.79834</td>
      <td>0.977871</td>
    </tr>
    <tr>
      <th>2024-02-09 20:00:00.020</th>
      <td>social0.2-aeon4</td>
      <td>BAA-1104049</td>
      <td>0.962744</td>
      <td>1237.676514</td>
      <td>576.779053</td>
      <td>0.981167</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>2024-02-10 19:59:59.920</th>
      <td>social0.2-aeon4</td>
      <td>BAA-1104048</td>
      <td>0.040165</td>
      <td>1208.623779</td>
      <td>531.122375</td>
      <td>0.901075</td>
    </tr>
    <tr>
      <th>2024-02-10 19:59:59.940</th>
      <td>social0.2-aeon4</td>
      <td>BAA-1104048</td>
      <td>0.037304</td>
      <td>1208.618652</td>
      <td>531.125305</td>
      <td>0.900917</td>
    </tr>
    <tr>
      <th>2024-02-10 19:59:59.960</th>
      <td>social0.2-aeon4</td>
      <td>BAA-1104048</td>
      <td>0.02502</td>
      <td>1208.620117</td>
      <td>531.122009</td>
      <td>0.90098</td>
    </tr>
    <tr>
      <th>2024-02-10 19:59:59.980</th>
      <td>social0.2-aeon4</td>
      <td>BAA-1104048</td>
      <td>0.028876</td>
      <td>1208.613281</td>
      <td>531.119995</td>
      <td>0.901786</td>
    </tr>
    <tr>
      <th>2024-02-10 20:00:00.000</th>
      <td>social0.2-aeon4</td>
      <td>BAA-1104048</td>
      <td>0.957639</td>
      <td>1208.57666</td>
      <td>531.117493</td>
      <td>0.895605</td>
    </tr>
  </tbody>
</table>
<p>6487333 rows × 6 columns</p>
</div></div></div>
</div>
<p>To visualise movement patterns across circadian phases, we will first downsample the position data to 1-second intervals and then plot each subject’s position data segmented by light and dark periods.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Downsample position_df for plotting</span>
<span class="n">position_df_downsampled</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">position_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;identity_name&quot;</span><span class="p">],</span> <span class="n">group_keys</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s2">&quot;1s&quot;</span><span class="p">)</span>  <span class="c1"># 1-second intervals</span>
    <span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">])</span>
<span class="p">)</span>
<span class="c1"># Compute time-of-day and flag dark vs light periods</span>
<span class="n">position_df_downsampled</span><span class="p">[</span><span class="s2">&quot;tod&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">position_df_downsampled</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">hour</span>
    <span class="o">+</span> <span class="n">position_df_downsampled</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">minute</span> <span class="o">/</span> <span class="mi">60</span>
    <span class="o">+</span> <span class="n">position_df_downsampled</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">second</span> <span class="o">/</span> <span class="mi">3600</span>
    <span class="o">+</span> <span class="n">position_df_downsampled</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">microsecond</span> <span class="o">/</span> <span class="mf">1e6</span> <span class="o">/</span> <span class="mi">3600</span>
<span class="p">)</span>
<span class="c1"># Detect light/dark transitions and assign period IDs</span>
<span class="n">position_df_downsampled</span><span class="p">[</span><span class="s2">&quot;is_dark&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">position_df_downsampled</span><span class="p">[</span><span class="s2">&quot;tod&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">light_off</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span>
    <span class="n">position_df_downsampled</span><span class="p">[</span><span class="s2">&quot;tod&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">light_on</span>
<span class="p">)</span>
<span class="n">first_dark</span> <span class="o">=</span> <span class="n">position_df_downsampled</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;identity_name&quot;</span><span class="p">)[</span><span class="s2">&quot;is_dark&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="s2">&quot;first&quot;</span><span class="p">)</span>
<span class="n">shifted</span> <span class="o">=</span> <span class="n">position_df_downsampled</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;identity_name&quot;</span><span class="p">)[</span><span class="s2">&quot;is_dark&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">()</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">first_dark</span><span class="p">)</span>
<span class="n">position_df_downsampled</span><span class="p">[</span><span class="s2">&quot;light_change&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">position_df_downsampled</span><span class="p">[</span><span class="s2">&quot;is_dark&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">shifted</span>
<span class="n">position_df_downsampled</span><span class="p">[</span><span class="s2">&quot;light_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">position_df_downsampled</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;identity_name&quot;</span><span class="p">)[</span><span class="s2">&quot;light_change&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Setup</span>
<span class="n">subjects</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">position_df_downsampled</span><span class="p">[</span><span class="s2">&quot;identity_name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
<span class="n">n_subj</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">subjects</span><span class="p">)</span>
<span class="n">n_per</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">position_df_downsampled</span><span class="p">[</span><span class="s2">&quot;light_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
<span class="c1"># Create subplot grid</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
    <span class="n">nrows</span><span class="o">=</span><span class="n">n_subj</span><span class="p">,</span>
    <span class="n">ncols</span><span class="o">=</span><span class="n">n_per</span><span class="p">,</span>
    <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">n_per</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">n_subj</span><span class="p">),</span>
    <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">subj</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">subjects</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_per</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">sub</span> <span class="o">=</span> <span class="n">position_df_downsampled</span><span class="p">[</span>
            <span class="p">(</span><span class="n">position_df_downsampled</span><span class="o">.</span><span class="n">identity_name</span> <span class="o">==</span> <span class="n">subj</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">position_df_downsampled</span><span class="o">.</span><span class="n">light_id</span> <span class="o">==</span> <span class="n">j</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="n">sub</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>
            <span class="k">continue</span>
        <span class="n">col</span> <span class="o">=</span> <span class="n">dark_color</span> <span class="k">if</span> <span class="n">sub</span><span class="o">.</span><span class="n">is_dark</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">else</span> <span class="n">light_color</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sub</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">sub</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">col</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">rasterized</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s2">&quot;equal&quot;</span><span class="p">,</span> <span class="s2">&quot;box&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
                <span class="o">-</span><span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span>
            <span class="p">)</span>

<span class="c1"># Add scale bar to bottom-right subplot</span>
<span class="n">last_ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">length_px</span> <span class="o">=</span> <span class="mf">0.2</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">cm2px</span>
<span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span> <span class="o">=</span> <span class="n">last_ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()</span>
<span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="n">last_ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>
<span class="n">x1</span> <span class="o">=</span> <span class="n">xmax</span> <span class="o">-</span> <span class="mf">0.02</span> <span class="o">*</span> <span class="p">(</span><span class="n">xmax</span> <span class="o">-</span> <span class="n">xmin</span><span class="p">)</span>
<span class="n">x0</span> <span class="o">=</span> <span class="n">x1</span> <span class="o">-</span> <span class="n">length_px</span>
<span class="n">y0</span> <span class="o">=</span> <span class="n">ymin</span> <span class="o">+</span> <span class="mf">0.02</span> <span class="o">*</span> <span class="p">(</span><span class="n">ymax</span> <span class="o">-</span> <span class="n">ymin</span><span class="p">)</span>
<span class="n">last_ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">],</span> <span class="p">[</span><span class="n">y0</span><span class="p">,</span> <span class="n">y0</span><span class="p">],</span> <span class="s2">&quot;k-&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">last_ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
    <span class="p">(</span><span class="n">x0</span> <span class="o">+</span> <span class="n">x1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
    <span class="n">y0</span> <span class="o">-</span> <span class="mf">0.06</span> <span class="o">*</span> <span class="p">(</span><span class="n">ymax</span> <span class="o">-</span> <span class="n">ymin</span><span class="p">),</span>
    <span class="s2">&quot;0.2 m&quot;</span><span class="p">,</span>
    <span class="n">va</span><span class="o">=</span><span class="s2">&quot;top&quot;</span><span class="p">,</span>
    <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
    <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Downsampled position data across first 24-hour window</span><span class="se">\n</span><span class="s2">aligned with the start of a light/dark cycle.&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/be35da2f9226beca5b82a00bbcdc0015767c247b0b023535e6fd68697b4cfb3b.png" src="../../_images/be35da2f9226beca5b82a00bbcdc0015767c247b0b023535e6fd68697b4cfb3b.png" />
</div>
</div>
</section>
<section id="patch-data">
<h2>Patch data<a class="headerlink" href="#patch-data" title="Link to this heading">#</a></h2>
<p>For each <a class="reference internal" href="../../reference/glossary.html#term-Block"><span class="xref std std-term">Block</span></a>, we also compute and store <a class="reference internal" href="../aeon_modules/hardware/foraging_patch.html#target-foraging-patch"><span class="std std-ref">foraging patch</span></a>-related data.
The data includes:</p>
<ul class="simple">
<li><p><strong>patch information</strong> (<code class="docutils literal notranslate"><span class="pre">block_analysis.BlockAnalysis.Patch</span></code>): wheel timestamps, patch rate, and patch offset for each block</p></li>
<li><p><strong>subject patch data</strong> (<code class="docutils literal notranslate"><span class="pre">block_analysis.BlockSubjectAnalysis.Patch</span></code>): subjects’ interactions with patches, including information on their presence in patches (duration, timestamps, RFID detections), pellet consumption (count, timestamps), and wheel movement (distance travelled)</p></li>
<li><p><strong>subject patch preferences</strong> (<code class="docutils literal notranslate"><span class="pre">block_analysis.BlockSubjectAnalysis.Preference</span></code>): preferences of subjects for different patches</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">load_subject_patch_data</span><span class="p">(</span>
    <span class="n">key</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">period_start</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">period_end</span><span class="p">:</span> <span class="nb">str</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Loads subject patch data for a specified time period.</span>

<span class="sd">    Args:</span>
<span class="sd">        key (dict): The key to filter the subject patch data.</span>
<span class="sd">        period_start (str): The start time for the period.</span>
<span class="sd">        period_end (str): The end time for the period.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: A tuple containing:</span>
<span class="sd">            - patch_info (pd.DataFrame): Information about patches.</span>
<span class="sd">            - block_subject_patch_data (pd.DataFrame): Data for the specified period.</span>
<span class="sd">            - block_subject_patch_pref (pd.DataFrame): Preference data for the specified period.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">patch_info</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">BlockAnalysis</span><span class="o">.</span><span class="n">Patch</span><span class="p">()</span>
        <span class="o">&amp;</span> <span class="n">key</span>
        <span class="o">&amp;</span> <span class="sa">f</span><span class="s2">&quot;block_start &gt;= &#39;</span><span class="si">{</span><span class="n">period_start</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
        <span class="o">&amp;</span> <span class="sa">f</span><span class="s2">&quot;block_start &lt;= &#39;</span><span class="si">{</span><span class="n">period_end</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
    <span class="p">)</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span>
        <span class="s2">&quot;block_start&quot;</span><span class="p">,</span>
        <span class="s2">&quot;patch_name&quot;</span><span class="p">,</span>
        <span class="s2">&quot;patch_rate&quot;</span><span class="p">,</span>
        <span class="s2">&quot;patch_offset&quot;</span><span class="p">,</span>
        <span class="s2">&quot;wheel_timestamps&quot;</span><span class="p">,</span>
        <span class="n">as_dict</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">block_subject_patch_data</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">BlockSubjectAnalysis</span><span class="o">.</span><span class="n">Patch</span><span class="p">()</span>
        <span class="o">&amp;</span> <span class="n">key</span>
        <span class="o">&amp;</span> <span class="sa">f</span><span class="s2">&quot;block_start &gt;= &#39;</span><span class="si">{</span><span class="n">period_start</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
        <span class="o">&amp;</span> <span class="sa">f</span><span class="s2">&quot;block_start &lt;= &#39;</span><span class="si">{</span><span class="n">period_end</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
    <span class="p">)</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="s2">&quot;frame&quot;</span><span class="p">)</span>
    <span class="n">block_subject_patch_pref</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">BlockSubjectAnalysis</span><span class="o">.</span><span class="n">Preference</span><span class="p">()</span>
        <span class="o">&amp;</span> <span class="n">key</span>
        <span class="o">&amp;</span> <span class="sa">f</span><span class="s2">&quot;block_start &gt;= &#39;</span><span class="si">{</span><span class="n">period_start</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
        <span class="o">&amp;</span> <span class="sa">f</span><span class="s2">&quot;block_start &lt;= &#39;</span><span class="si">{</span><span class="n">period_end</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
    <span class="p">)</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="s2">&quot;frame&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">patch_info</span><span class="p">:</span>
        <span class="n">patch_info</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">patch_info</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">block_subject_patch_data</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">block_subject_patch_data</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="n">block_subject_patch_data</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">block_subject_patch_pref</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">block_subject_patch_pref</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="n">block_subject_patch_pref</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">patch_info</span><span class="p">,</span> <span class="n">block_subject_patch_data</span><span class="p">,</span> <span class="n">block_subject_patch_pref</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">block_patch_info</span><span class="p">,</span> <span class="n">block_subject_patch_data</span><span class="p">,</span> <span class="n">block_subject_patch_pref</span> <span class="o">=</span> <span class="n">load_subject_patch_data</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">start_dt</span><span class="p">,</span> <span class="n">end_dt</span><span class="p">)</span>
<span class="c1"># Drop NaNs in preference columns</span>
<span class="n">block_subject_patch_pref</span> <span class="o">=</span> <span class="n">block_subject_patch_pref</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;final_preference_by_time&quot;</span><span class="p">,</span> <span class="s2">&quot;final_preference_by_wheel&quot;</span><span class="p">])</span>
<span class="c1"># Validate subject count for pre/post-social blocks</span>
<span class="k">if</span> <span class="n">period_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;presocial&quot;</span><span class="p">,</span> <span class="s2">&quot;postsocial&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">block_subject_patch_data</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
    <span class="n">n_subjects</span> <span class="o">=</span> <span class="n">block_subject_patch_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;block_start&quot;</span><span class="p">)[</span><span class="s2">&quot;subject_name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">n_subjects</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">exp</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">period_name</span><span class="si">}</span><span class="s2"> blocks have &gt;1 subject. Data may need cleaning.&quot;</span>
        <span class="p">)</span>
<span class="c1"># Ensure timestamp arrays are datetime64[ns]</span>
<span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;pellet_timestamps&quot;</span><span class="p">,</span> <span class="s2">&quot;in_patch_rfid_timestamps&quot;</span><span class="p">,</span> <span class="s2">&quot;in_patch_timestamps&quot;</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">block_subject_patch_data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">block_subject_patch_data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">block_subject_patch_data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">ensure_ts_arr_datetime</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">block_patch_info</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>block_start</th>
      <th>patch_name</th>
      <th>wheel_timestamps</th>
      <th>patch_rate</th>
      <th>patch_offset</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2024-02-09 18:19:04.000000</td>
      <td>Patch1</td>
      <td>[2024-02-09T18:19:04.000000000, 2024-02-09T18:...</td>
      <td>0.0100</td>
      <td>75.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2024-02-09 18:19:04.000000</td>
      <td>Patch2</td>
      <td>[2024-02-09T18:19:04.000000000, 2024-02-09T18:...</td>
      <td>0.0020</td>
      <td>75.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2024-02-09 18:19:04.000000</td>
      <td>Patch3</td>
      <td>[2024-02-09T18:19:04.000000000, 2024-02-09T18:...</td>
      <td>0.0033</td>
      <td>75.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2024-02-09 20:07:25.041984</td>
      <td>Patch1</td>
      <td>[2024-02-09T20:07:25.060000000, 2024-02-09T20:...</td>
      <td>0.0020</td>
      <td>75.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2024-02-09 20:07:25.041984</td>
      <td>Patch2</td>
      <td>[2024-02-09T20:07:25.060000000, 2024-02-09T20:...</td>
      <td>0.0033</td>
      <td>75.0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>109</th>
      <td>2024-02-12 14:31:02.005984</td>
      <td>Patch2</td>
      <td>[2024-02-12T14:31:02.020000000, 2024-02-12T14:...</td>
      <td>0.0033</td>
      <td>75.0</td>
    </tr>
    <tr>
      <th>110</th>
      <td>2024-02-12 14:31:02.005984</td>
      <td>Patch3</td>
      <td>[2024-02-12T14:31:02.020000000, 2024-02-12T14:...</td>
      <td>0.0100</td>
      <td>75.0</td>
    </tr>
    <tr>
      <th>111</th>
      <td>2024-02-12 16:53:14.000000</td>
      <td>Patch1</td>
      <td>[2024-02-12T16:53:14.000000000, 2024-02-12T16:...</td>
      <td>0.0020</td>
      <td>75.0</td>
    </tr>
    <tr>
      <th>112</th>
      <td>2024-02-12 16:53:14.000000</td>
      <td>Patch2</td>
      <td>[2024-02-12T16:53:14.000000000, 2024-02-12T16:...</td>
      <td>0.0100</td>
      <td>75.0</td>
    </tr>
    <tr>
      <th>113</th>
      <td>2024-02-12 16:53:14.000000</td>
      <td>Patch3</td>
      <td>[2024-02-12T16:53:14.000000000, 2024-02-12T16:...</td>
      <td>0.0033</td>
      <td>75.0</td>
    </tr>
  </tbody>
</table>
<p>114 rows × 5 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">block_subject_patch_data</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>experiment_name</th>
      <th>block_start</th>
      <th>patch_name</th>
      <th>subject_name</th>
      <th>in_patch_timestamps</th>
      <th>in_patch_time</th>
      <th>in_patch_rfid_timestamps</th>
      <th>pellet_count</th>
      <th>pellet_timestamps</th>
      <th>patch_threshold</th>
      <th>wheel_cumsum_distance_travelled</th>
      <th>period</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>social0.2-aeon4</td>
      <td>2024-02-09 18:19:04</td>
      <td>Patch1</td>
      <td>BAA-1104048</td>
      <td>[2024-02-09T18:26:44.600000000, 2024-02-09T18:...</td>
      <td>756.60</td>
      <td>[2024-02-09T18:26:45.736672000, 2024-02-09T18:...</td>
      <td>39</td>
      <td>[2024-02-09T18:26:50.373504000, 2024-02-09T18:...</td>
      <td>[125.10144062824004, 125.98842043772429, 133.9...</td>
      <td>[-0.0, 0.004602223261072957, 0.007670372101788...</td>
      <td>social</td>
    </tr>
    <tr>
      <th>1</th>
      <td>social0.2-aeon4</td>
      <td>2024-02-09 18:19:04</td>
      <td>Patch1</td>
      <td>BAA-1104049</td>
      <td>[2024-02-09T18:21:10.200000000, 2024-02-09T18:...</td>
      <td>570.18</td>
      <td>[2024-02-09T18:21:11.452832000, 2024-02-09T18:...</td>
      <td>26</td>
      <td>[2024-02-09T18:28:57.907488000, 2024-02-09T18:...</td>
      <td>[75.07162358109204, 186.27023735234684, 135.82...</td>
      <td>[0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, ...</td>
      <td>social</td>
    </tr>
    <tr>
      <th>2</th>
      <td>social0.2-aeon4</td>
      <td>2024-02-09 18:19:04</td>
      <td>Patch2</td>
      <td>BAA-1104048</td>
      <td>[2024-02-09T18:20:10.400000000, 2024-02-09T18:...</td>
      <td>123.32</td>
      <td>[2024-02-09T18:20:12.097312000, 2024-02-09T18:...</td>
      <td>0</td>
      <td>[]</td>
      <td>[]</td>
      <td>[-0.0, -0.004602223261073846, -0.0015340744203...</td>
      <td>social</td>
    </tr>
    <tr>
      <th>3</th>
      <td>social0.2-aeon4</td>
      <td>2024-02-09 18:19:04</td>
      <td>Patch2</td>
      <td>BAA-1104049</td>
      <td>[2024-02-09T18:20:54.600000000, 2024-02-09T18:...</td>
      <td>226.80</td>
      <td>[2024-02-09T18:21:30.375328000, 2024-02-09T18:...</td>
      <td>3</td>
      <td>[2024-02-09T18:52:14.199488000, 2024-02-09T19:...</td>
      <td>[1069.4286592499257, 694.8095229017808, 278.84...</td>
      <td>[0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, ...</td>
      <td>social</td>
    </tr>
    <tr>
      <th>4</th>
      <td>social0.2-aeon4</td>
      <td>2024-02-09 18:19:04</td>
      <td>Patch3</td>
      <td>BAA-1104048</td>
      <td>[2024-02-09T18:20:03.940000000, 2024-02-09T18:...</td>
      <td>138.78</td>
      <td>[2024-02-09T18:25:59.113504000, 2024-02-09T18:...</td>
      <td>1</td>
      <td>[2024-02-09T19:30:22.688480000]</td>
      <td>[331.8480024096391]</td>
      <td>[0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, ...</td>
      <td>social</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>223</th>
      <td>social0.2-aeon4</td>
      <td>2024-02-12 16:53:14</td>
      <td>Patch1</td>
      <td>BAA-1104049</td>
      <td>[2024-02-12T17:01:34.760000000, 2024-02-12T17:...</td>
      <td>94.98</td>
      <td>[2024-02-12T17:01:35.372416000, 2024-02-12T17:...</td>
      <td>0</td>
      <td>[]</td>
      <td>[]</td>
      <td>[-0.0, -0.00920444652214547, -0.00613629768143...</td>
      <td>social</td>
    </tr>
    <tr>
      <th>224</th>
      <td>social0.2-aeon4</td>
      <td>2024-02-12 16:53:14</td>
      <td>Patch2</td>
      <td>BAA-1104048</td>
      <td>[2024-02-12T16:58:52.540000000, 2024-02-12T16:...</td>
      <td>627.76</td>
      <td>[2024-02-12T16:58:53.758496000, 2024-02-12T16:...</td>
      <td>18</td>
      <td>[2024-02-12T17:01:47.607488000, 2024-02-12T17:...</td>
      <td>[128.88388967189582, 98.29740841703715, 138.54...</td>
      <td>[-0.0, 0.0030681488407182655, 0.00306814884071...</td>
      <td>social</td>
    </tr>
    <tr>
      <th>225</th>
      <td>social0.2-aeon4</td>
      <td>2024-02-12 16:53:14</td>
      <td>Patch2</td>
      <td>BAA-1104049</td>
      <td>[2024-02-12T16:53:55.360000000, 2024-02-12T16:...</td>
      <td>1215.12</td>
      <td>[2024-02-12T16:53:56.698656000, 2024-02-12T16:...</td>
      <td>34</td>
      <td>[2024-02-12T16:57:31.338496000, 2024-02-12T16:...</td>
      <td>[245.09652119007265, 137.19851472663964, 129.5...</td>
      <td>[0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, ...</td>
      <td>social</td>
    </tr>
    <tr>
      <th>226</th>
      <td>social0.2-aeon4</td>
      <td>2024-02-12 16:53:14</td>
      <td>Patch3</td>
      <td>BAA-1104048</td>
      <td>[2024-02-12T16:58:45.920000000, 2024-02-12T16:...</td>
      <td>101.68</td>
      <td>[2024-02-12T16:58:47.270432000, 2024-02-12T16:...</td>
      <td>0</td>
      <td>[]</td>
      <td>[]</td>
      <td>[-0.0, 0.0, -0.006136297681431202, -0.00460222...</td>
      <td>social</td>
    </tr>
    <tr>
      <th>227</th>
      <td>social0.2-aeon4</td>
      <td>2024-02-12 16:53:14</td>
      <td>Patch3</td>
      <td>BAA-1104049</td>
      <td>[2024-02-12T17:01:20.200000000, 2024-02-12T17:...</td>
      <td>48.12</td>
      <td>[2024-02-12T17:01:22.861888000, 2024-02-12T17:...</td>
      <td>0</td>
      <td>[]</td>
      <td>[]</td>
      <td>[0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, ...</td>
      <td>social</td>
    </tr>
  </tbody>
</table>
<p>228 rows × 12 columns</p>
</div></div></div>
</div>
<p>To visualise wheel distance spun by each subject at each foraging patch, we downsample the raw cumulative traces by computing the absolute difference between consecutive distance values and retaining only those points where the change exceeds 0.5 cm.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dt_seconds</span> <span class="o">=</span> <span class="mf">0.02</span> <span class="c1"># wheel sampling interval</span>
<span class="n">records</span> <span class="o">=</span> <span class="p">[]</span>
<span class="c1"># Flatten and downsample</span>
<span class="k">for</span> <span class="p">(</span><span class="n">subject_name</span><span class="p">,</span> <span class="n">patch</span><span class="p">),</span> <span class="n">grp</span> <span class="ow">in</span> <span class="n">block_subject_patch_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;subject_name&quot;</span><span class="p">,</span> <span class="s2">&quot;patch_name&quot;</span><span class="p">]):</span>
    <span class="n">grp</span> <span class="o">=</span> <span class="n">grp</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;block_start&quot;</span><span class="p">)</span>
    <span class="n">offset</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">for</span> <span class="n">bs_val</span><span class="p">,</span> <span class="n">arr</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">grp</span><span class="o">.</span><span class="n">block_start</span><span class="p">,</span> <span class="n">grp</span><span class="o">.</span><span class="n">wheel_cumsum_distance_travelled</span><span class="p">):</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">size</span>
        <span class="n">offs</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">*</span> <span class="n">dt_seconds</span> <span class="o">*</span> <span class="mf">1e9</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;timedelta64[ns]&quot;</span><span class="p">)</span>
        <span class="n">times</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">(</span><span class="n">bs_val</span><span class="p">)</span> <span class="o">+</span> <span class="n">offs</span>
        <span class="n">dists</span> <span class="o">=</span> <span class="n">arr</span> <span class="o">+</span> <span class="n">offset</span>
        <span class="n">offset</span> <span class="o">+=</span> <span class="n">arr</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1"># Downsample: keep points where Δ &gt; 0.5</span>
        <span class="n">diffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">dists</span><span class="p">,</span> <span class="n">prepend</span><span class="o">=</span><span class="n">dists</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">diffs</span> <span class="o">&gt;</span> <span class="mf">0.5</span>
        <span class="n">mask</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">times</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">dists</span><span class="p">[</span><span class="n">mask</span><span class="p">]):</span>
            <span class="n">records</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="n">t</span><span class="p">,</span>
                <span class="s2">&quot;distance_m&quot;</span><span class="p">:</span> <span class="n">d</span> <span class="o">/</span> <span class="mi">100</span><span class="p">,</span>
                <span class="s2">&quot;subject&quot;</span><span class="p">:</span> <span class="n">subject_name</span><span class="p">,</span>
                <span class="s2">&quot;patch&quot;</span><span class="p">:</span> <span class="n">patch</span>
            <span class="p">})</span>

<span class="c1"># Build long-form DataFrame</span>
<span class="n">flat_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">(</span><span class="n">records</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span>
    <span class="n">data</span><span class="o">=</span><span class="n">flat_df</span><span class="p">,</span>
    <span class="n">x</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">,</span>
    <span class="n">y</span><span class="o">=</span><span class="s2">&quot;distance_m&quot;</span><span class="p">,</span>
    <span class="n">hue</span><span class="o">=</span><span class="s2">&quot;subject&quot;</span><span class="p">,</span>
    <span class="n">style</span><span class="o">=</span><span class="s2">&quot;patch&quot;</span><span class="p">,</span>
    <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Distance spun on wheel (m)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Wheel Distance Over Time&quot;</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">despine</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/f76c6c68956e1d199ba07287b2dfa56b5e295c6d4cbffa851c9aa7ebd6bf2915.png" src="../../_images/f76c6c68956e1d199ba07287b2dfa56b5e295c6d4cbffa851c9aa7ebd6bf2915.png" />
</div>
</div>
<p>We can also plot the pellet delivery events for each subject.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">block_subject_patch_data</span><span class="p">[[</span><span class="s2">&quot;subject_name&quot;</span><span class="p">,</span> <span class="s2">&quot;patch_name&quot;</span><span class="p">,</span> <span class="s2">&quot;pellet_timestamps&quot;</span><span class="p">]]</span>
    <span class="o">.</span><span class="n">explode</span><span class="p">(</span><span class="s2">&quot;pellet_timestamps&quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;pellet_timestamps&quot;</span><span class="p">])</span>
    <span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;pellet_timestamps&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;pellet_timestamps&quot;</span><span class="p">])</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;patch_idx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;patch_name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(\d+)$&quot;</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;patch_idx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;patch_idx&quot;</span><span class="p">],</span> <span class="n">ordered</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">categories</span><span class="o">=</span><span class="nb">sorted</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;patch_idx&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">g</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">FacetGrid</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="n">col</span><span class="o">=</span><span class="s2">&quot;subject_name&quot;</span><span class="p">,</span>
    <span class="n">col_wrap</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">aspect</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
    <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">g</span><span class="o">.</span><span class="n">map_dataframe</span><span class="p">(</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">,</span>
    <span class="n">x</span><span class="o">=</span><span class="s2">&quot;pellet_timestamps&quot;</span><span class="p">,</span>
    <span class="n">y</span><span class="o">=</span><span class="s2">&quot;patch_idx&quot;</span><span class="p">,</span>
    <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;|&quot;</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="n">dark_color</span><span class="p">,</span>
    <span class="n">s</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">flat</span><span class="p">:</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Patch&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_title</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;subject_name = &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
<span class="n">g</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">top</span><span class="o">=</span><span class="mf">0.95</span><span class="p">)</span>
<span class="n">g</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Pellet Delivery Raster by Subject&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/9fbcf9c8adc65540f5dd43bbdce219f917e95ef1107ea41c7ec98256d382b775.png" src="../../_images/9fbcf9c8adc65540f5dd43bbdce219f917e95ef1107ea41c7ec98256d382b775.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">block_subject_patch_pref</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>experiment_name</th>
      <th>block_start</th>
      <th>patch_name</th>
      <th>subject_name</th>
      <th>cumulative_preference_by_wheel</th>
      <th>cumulative_preference_by_time</th>
      <th>running_preference_by_time</th>
      <th>running_preference_by_wheel</th>
      <th>final_preference_by_wheel</th>
      <th>final_preference_by_time</th>
      <th>period</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>social0.2-aeon4</td>
      <td>2024-02-09 18:19:04</td>
      <td>Patch1</td>
      <td>BAA-1104048</td>
      <td>[0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, ...</td>
      <td>[0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, ...</td>
      <td>[0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, ...</td>
      <td>[0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, ...</td>
      <td>0.758947</td>
      <td>0.742711</td>
      <td>social</td>
    </tr>
    <tr>
      <th>1</th>
      <td>social0.2-aeon4</td>
      <td>2024-02-09 18:19:04</td>
      <td>Patch1</td>
      <td>BAA-1104049</td>
      <td>[0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, ...</td>
      <td>[0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, ...</td>
      <td>[0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, ...</td>
      <td>[0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, ...</td>
      <td>0.548170</td>
      <td>0.574604</td>
      <td>social</td>
    </tr>
    <tr>
      <th>2</th>
      <td>social0.2-aeon4</td>
      <td>2024-02-09 18:19:04</td>
      <td>Patch2</td>
      <td>BAA-1104048</td>
      <td>[0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, ...</td>
      <td>[0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, ...</td>
      <td>[0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, ...</td>
      <td>[0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, ...</td>
      <td>0.096201</td>
      <td>0.121056</td>
      <td>social</td>
    </tr>
    <tr>
      <th>3</th>
      <td>social0.2-aeon4</td>
      <td>2024-02-09 18:19:04</td>
      <td>Patch2</td>
      <td>BAA-1104049</td>
      <td>[0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, ...</td>
      <td>[0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, ...</td>
      <td>[0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, ...</td>
      <td>[0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, ...</td>
      <td>0.251308</td>
      <td>0.228560</td>
      <td>social</td>
    </tr>
    <tr>
      <th>4</th>
      <td>social0.2-aeon4</td>
      <td>2024-02-09 18:19:04</td>
      <td>Patch3</td>
      <td>BAA-1104048</td>
      <td>[0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, ...</td>
      <td>[0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, ...</td>
      <td>[0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, ...</td>
      <td>[0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, ...</td>
      <td>0.144852</td>
      <td>0.136232</td>
      <td>social</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>223</th>
      <td>social0.2-aeon4</td>
      <td>2024-02-12 16:53:14</td>
      <td>Patch1</td>
      <td>BAA-1104049</td>
      <td>[0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, ...</td>
      <td>[0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, ...</td>
      <td>[0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, ...</td>
      <td>[0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, ...</td>
      <td>0.038067</td>
      <td>0.069930</td>
      <td>social</td>
    </tr>
    <tr>
      <th>224</th>
      <td>social0.2-aeon4</td>
      <td>2024-02-12 16:53:14</td>
      <td>Patch2</td>
      <td>BAA-1104048</td>
      <td>[0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, ...</td>
      <td>[0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, ...</td>
      <td>[0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, ...</td>
      <td>[0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, ...</td>
      <td>0.831808</td>
      <td>0.778163</td>
      <td>social</td>
    </tr>
    <tr>
      <th>225</th>
      <td>social0.2-aeon4</td>
      <td>2024-02-12 16:53:14</td>
      <td>Patch2</td>
      <td>BAA-1104049</td>
      <td>[0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, ...</td>
      <td>[0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, ...</td>
      <td>[0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, ...</td>
      <td>[0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, ...</td>
      <td>0.955588</td>
      <td>0.894642</td>
      <td>social</td>
    </tr>
    <tr>
      <th>226</th>
      <td>social0.2-aeon4</td>
      <td>2024-02-12 16:53:14</td>
      <td>Patch3</td>
      <td>BAA-1104048</td>
      <td>[0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, ...</td>
      <td>[0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, ...</td>
      <td>[0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, ...</td>
      <td>[0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, ...</td>
      <td>0.162096</td>
      <td>0.126041</td>
      <td>social</td>
    </tr>
    <tr>
      <th>227</th>
      <td>social0.2-aeon4</td>
      <td>2024-02-12 16:53:14</td>
      <td>Patch3</td>
      <td>BAA-1104049</td>
      <td>[0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, ...</td>
      <td>[0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, ...</td>
      <td>[0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, ...</td>
      <td>[0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, ...</td>
      <td>0.006345</td>
      <td>0.035429</td>
      <td>social</td>
    </tr>
  </tbody>
</table>
<p>162 rows × 11 columns</p>
</div></div></div>
</div>
</section>
<section id="foraging-bouts">
<h2>Foraging bouts<a class="headerlink" href="#foraging-bouts" title="Link to this heading">#</a></h2>
<p>Based on <code class="docutils literal notranslate"><span class="pre">block_analysis.BlockSubjectAnalysis.Patch</span></code>, foraging bouts—defined as time intervals in which a subject initiates at least 3 pellet deliveries and rotates the patch wheel by at least one full turn within a 60-second period—are identified and stored in the <code class="docutils literal notranslate"><span class="pre">block_analysis.BlockForaging.Bout</span></code> table.</p>
<p>We will now retrieve the foraging bouts for each subject across all <a class="reference internal" href="../../reference/glossary.html#term-Block"><span class="xref std std-term">blocks</span></a> from this table.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">load_foraging_bouts</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">period_start</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">period_end</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Loads foraging bout data for blocks falling within a specified time period.</span>

<span class="sd">    Args:</span>
<span class="sd">        key (dict): Key to identify experiment data (e.g., {&quot;experiment_name&quot;: &quot;Exp1&quot;}).</span>
<span class="sd">        period_start (str): Start datetime of the time period (format: &#39;%Y-%m-%d %H:%M:%S&#39;).</span>
<span class="sd">        period_end (str): End datetime of the time period (format: &#39;%Y-%m-%d %H:%M:%S&#39;).</span>

<span class="sd">    Returns:</span>
<span class="sd">        pd.DataFrame: Dataframe of foraging bouts for all matching blocks.</span>
<span class="sd">                      Returns an empty dataframe with predefined columns if no data found.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Fetch bouts within the specified period</span>
    <span class="n">bouts_dict</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">Block</span> <span class="o">*</span> <span class="n">BlockForaging</span><span class="o">.</span><span class="n">Bout</span>
        <span class="o">&amp;</span> <span class="n">key</span>
        <span class="o">&amp;</span> <span class="sa">f</span><span class="s2">&quot;block_start &gt;= &#39;</span><span class="si">{</span><span class="n">period_start</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
        <span class="o">&amp;</span> <span class="sa">f</span><span class="s2">&quot;block_end &lt;= &#39;</span><span class="si">{</span><span class="n">period_end</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
    <span class="p">)</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s2">&quot;subject_name&quot;</span><span class="p">,</span> <span class="s2">&quot;bout_start&quot;</span><span class="p">,</span> <span class="s2">&quot;bout_end&quot;</span><span class="p">,</span> <span class="s2">&quot;pellet_count&quot;</span><span class="p">,</span> <span class="s2">&quot;cum_wheel_dist&quot;</span><span class="p">,</span> <span class="n">as_dict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">bouts_dict</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">bouts_dict</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s2">&quot;bout_start&quot;</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;subject_name&quot;</span><span class="p">,</span> <span class="s2">&quot;bout_start&quot;</span><span class="p">,</span> <span class="s2">&quot;bout_end&quot;</span><span class="p">,</span> <span class="s2">&quot;pellet_count&quot;</span><span class="p">,</span> <span class="s2">&quot;cum_wheel_dist&quot;</span><span class="p">]</span>
        <span class="p">)</span>

<span class="c1"># Load foraging bouts</span>
<span class="n">foraging_df</span> <span class="o">=</span> <span class="n">load_foraging_bouts</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">start_dt</span><span class="p">,</span> <span class="n">end_dt</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">foraging_df</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>subject_name</th>
      <th>bout_start</th>
      <th>bout_end</th>
      <th>pellet_count</th>
      <th>cum_wheel_dist</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>BAA-1104048</td>
      <td>2024-02-09 18:39:17.180</td>
      <td>2024-02-09 18:42:14.880</td>
      <td>7</td>
      <td>983.174</td>
    </tr>
    <tr>
      <th>1</th>
      <td>BAA-1104048</td>
      <td>2024-02-09 18:48:14.880</td>
      <td>2024-02-09 18:50:11.720</td>
      <td>3</td>
      <td>512.637</td>
    </tr>
    <tr>
      <th>5</th>
      <td>BAA-1104049</td>
      <td>2024-02-09 18:50:01.360</td>
      <td>2024-02-09 18:54:16.560</td>
      <td>8</td>
      <td>1899.180</td>
    </tr>
    <tr>
      <th>2</th>
      <td>BAA-1104048</td>
      <td>2024-02-09 19:03:35.840</td>
      <td>2024-02-09 19:07:51.260</td>
      <td>11</td>
      <td>1979.470</td>
    </tr>
    <tr>
      <th>6</th>
      <td>BAA-1104049</td>
      <td>2024-02-09 19:09:47.100</td>
      <td>2024-02-09 19:11:58.200</td>
      <td>4</td>
      <td>510.634</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>151</th>
      <td>BAA-1104048</td>
      <td>2024-02-12 16:03:42.420</td>
      <td>2024-02-12 16:08:18.900</td>
      <td>7</td>
      <td>1275.080</td>
    </tr>
    <tr>
      <th>152</th>
      <td>BAA-1104048</td>
      <td>2024-02-12 16:17:47.480</td>
      <td>2024-02-12 16:21:39.080</td>
      <td>4</td>
      <td>1078.850</td>
    </tr>
    <tr>
      <th>153</th>
      <td>BAA-1104048</td>
      <td>2024-02-12 16:24:17.660</td>
      <td>2024-02-12 16:26:56.160</td>
      <td>3</td>
      <td>680.643</td>
    </tr>
    <tr>
      <th>154</th>
      <td>BAA-1104048</td>
      <td>2024-02-12 16:30:04.740</td>
      <td>2024-02-12 16:33:20.300</td>
      <td>3</td>
      <td>981.212</td>
    </tr>
    <tr>
      <th>155</th>
      <td>BAA-1104048</td>
      <td>2024-02-12 16:38:32.840</td>
      <td>2024-02-12 16:43:16.600</td>
      <td>3</td>
      <td>2384.390</td>
    </tr>
  </tbody>
</table>
<p>159 rows × 5 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">subjects</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">foraging_df</span><span class="p">[</span><span class="s2">&quot;subject_name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">cmap</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">colormaps</span><span class="p">[</span><span class="s2">&quot;viridis&quot;</span><span class="p">]</span>  <span class="c1"># or &quot;plasma&quot;, &quot;magma&quot;, &quot;Greys&quot;</span>
<span class="n">norm</span> <span class="o">=</span> <span class="n">mcolors</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">foraging_df</span><span class="p">[</span><span class="s2">&quot;pellet_count&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">vmax</span><span class="o">=</span><span class="n">foraging_df</span><span class="p">[</span><span class="s2">&quot;pellet_count&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">subjects</span><span class="p">)))</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">subj</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">subjects</span><span class="p">):</span>
    <span class="n">bouts</span> <span class="o">=</span> <span class="n">foraging_df</span><span class="p">[</span><span class="n">foraging_df</span><span class="p">[</span><span class="s2">&quot;subject_name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">subj</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">bouts</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">color</span> <span class="o">=</span> <span class="n">cmap</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;pellet_count&quot;</span><span class="p">]))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span>
            <span class="n">y</span><span class="o">=</span><span class="n">i</span><span class="p">,</span>
            <span class="n">xmin</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;bout_start&quot;</span><span class="p">],</span>
            <span class="n">xmax</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;bout_end&quot;</span><span class="p">],</span>
            <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
            <span class="n">linewidth</span><span class="o">=</span><span class="mi">70</span>
            <span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">subjects</span><span class="p">)))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">subjects</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Foraging Bouts&quot;</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">despine</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">sm</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">ScalarMappable</span><span class="p">(</span><span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">sm</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Pellet Count&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/a03640ad57e7726b21b2d39b6e3ce75a78c7788e27490f1a2a47d8bba223861c.png" src="../../_images/a03640ad57e7726b21b2d39b6e3ce75a78c7788e27490f1a2a47d8bba223861c.png" />
</div>
</div>
</section>
<section id="rfid-data">
<h2>RFID data<a class="headerlink" href="#rfid-data" title="Link to this heading">#</a></h2>
<p>In this experiment, each subject is implanted with a miniature RFID microchip.
RFID readers are positioned at the <a class="reference internal" href="../aeon_modules/hardware/foraging_patch.html#target-foraging-patch"><span class="std std-ref">foraging patches</span></a>, <a class="reference internal" href="../aeon_modules/hardware/nest.html#target-nest"><span class="std std-ref">nest</span></a>, and <a class="reference internal" href="../aeon_modules/hardware/habitat.html#target-habitat"><span class="std std-ref">gate</span></a>.</p>
<p>We will fetch the RFID detection data at each reader across all <a class="reference internal" href="../../reference/glossary.html#term-Acquisition-Chunk"><span class="xref std std-term">chunks</span></a> occurring within the first 3 days of the social period.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">load_rfid_events</span><span class="p">(</span>
    <span class="n">key</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">period_start</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">period_end</span><span class="p">:</span> <span class="nb">str</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Loads RFID events data for chunks falling within a specified time period.</span>

<span class="sd">    Args:</span>
<span class="sd">        key (dict): Key to identify experiment data (e.g., {&quot;experiment_name&quot;: &quot;Exp1&quot;}).</span>
<span class="sd">        period_start (str): Start datetime of the time period (format: &#39;%Y-%m-%d %H:%M:%S&#39;).</span>
<span class="sd">        period_end (str): End datetime of the time period (format: &#39;%Y-%m-%d %H:%M:%S&#39;).</span>

<span class="sd">    Returns:</span>
<span class="sd">        pd.DataFrame: DataFrame containing RFID events for the specified period.</span>
<span class="sd">                      Returns an empty dataframe with predefined columns if no data found.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Fetch RFID events within the specified period</span>
    <span class="n">rfid_events_df</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">streams</span><span class="o">.</span><span class="n">RfidReader</span> <span class="o">*</span> <span class="n">streams</span><span class="o">.</span><span class="n">RfidReaderRfidEvents</span>
        <span class="o">&amp;</span> <span class="n">key</span>
        <span class="o">&amp;</span> <span class="sa">f</span><span class="s1">&#39;chunk_start &gt;= &quot;</span><span class="si">{</span><span class="n">period_start</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
        <span class="o">&amp;</span> <span class="sa">f</span><span class="s1">&#39;chunk_start &lt;= &quot;</span><span class="si">{</span><span class="n">period_end</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
    <span class="p">)</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="s2">&quot;frame&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">rfid_events_df</span><span class="o">.</span><span class="n">empty</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rfid_events_df</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="c1"># Return empty DataFrame with expected columns if no data found</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="n">columns</span><span class="o">=</span><span class="p">[</span>
                <span class="s2">&quot;experiment_name&quot;</span><span class="p">,</span>
                <span class="s2">&quot;chunk_start&quot;</span><span class="p">,</span>
                <span class="s2">&quot;rfid_reader_name&quot;</span><span class="p">,</span>
                <span class="s2">&quot;sample_count&quot;</span><span class="p">,</span>
                <span class="s2">&quot;timestamps&quot;</span><span class="p">,</span>
                <span class="s2">&quot;rfid&quot;</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">)</span>
    <span class="c1"># Get subject details for RFID mapping</span>
    <span class="n">subject_detail</span> <span class="o">=</span> <span class="n">subject</span><span class="o">.</span><span class="n">SubjectDetail</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="s2">&quot;frame&quot;</span><span class="p">)</span>
    <span class="n">subject_detail</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># Create mapping from RFID to subject ID</span>
    <span class="n">rfid_to_lab_id</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">subject_detail</span><span class="p">[</span><span class="s2">&quot;lab_id&quot;</span><span class="p">],</span> <span class="n">subject_detail</span><span class="p">[</span><span class="s2">&quot;subject&quot;</span><span class="p">]))</span>
    <span class="n">rfid_events_df</span><span class="p">[</span><span class="s2">&quot;rfid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span><span class="n">rfid_to_lab_id</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">rfid</span><span class="p">))</span> <span class="k">for</span> <span class="n">rfid</span> <span class="ow">in</span> <span class="n">rfid_array</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">rfid_array</span> <span class="ow">in</span> <span class="n">rfid_events_df</span><span class="p">[</span><span class="s2">&quot;rfid&quot;</span><span class="p">]</span>
    <span class="p">]</span>
    <span class="c1"># Extract experiment_name and chunk_start from the index before resetting</span>
    <span class="n">rfid_events_df</span><span class="p">[</span><span class="s2">&quot;experiment_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">rfid_events_df</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
    <span class="n">rfid_events_df</span><span class="p">[</span><span class="s2">&quot;chunk_start&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">idx</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">rfid_events_df</span><span class="o">.</span><span class="n">index</span>
    <span class="p">]</span>  <span class="c1"># Assuming chunk_start is at index 3</span>
    <span class="c1"># Reset the index and drop the index column</span>
    <span class="n">rfid_events_df</span> <span class="o">=</span> <span class="n">rfid_events_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># Reorder columns to put experiment_name first and chunk_start second</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;experiment_name&quot;</span><span class="p">,</span> <span class="s2">&quot;chunk_start&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span>
        <span class="n">col</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">rfid_events_df</span><span class="o">.</span><span class="n">columns</span>
        <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;experiment_name&quot;</span><span class="p">,</span> <span class="s2">&quot;chunk_start&quot;</span><span class="p">]</span>
    <span class="p">]</span>
    <span class="n">rfid_events_df</span> <span class="o">=</span> <span class="n">rfid_events_df</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">rfid_events_df</span>

<span class="c1"># Load RFID data</span>
<span class="n">rfid_df</span> <span class="o">=</span> <span class="n">load_rfid_events</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">start_dt</span><span class="p">,</span> <span class="n">end_dt</span><span class="p">)</span>
<span class="n">rfid_df</span> <span class="o">=</span> <span class="n">rfid_df</span><span class="o">.</span><span class="n">explode</span><span class="p">([</span><span class="s2">&quot;timestamps&quot;</span><span class="p">,</span> <span class="s2">&quot;rfid&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;timestamps&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
<span class="n">rfid_df</span> <span class="o">=</span> <span class="n">rfid_df</span><span class="p">[</span><span class="o">~</span><span class="n">rfid_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isna</span><span class="p">()]</span>
<span class="n">rfid_df</span><span class="p">[</span><span class="s2">&quot;rfid_reader_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span><span class="n">rfid_df</span><span class="p">[</span><span class="s2">&quot;rfid_reader_name&quot;</span><span class="p">],</span> <span class="n">ordered</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">categories</span><span class="o">=</span><span class="nb">sorted</span><span class="p">(</span><span class="n">rfid_df</span><span class="p">[</span><span class="s2">&quot;rfid_reader_name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rfid_df</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>experiment_name</th>
      <th>chunk_start</th>
      <th>rfid_reader_name</th>
      <th>sample_count</th>
      <th>rfid</th>
    </tr>
    <tr>
      <th>timestamps</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2024-02-09 17:00:00.483007908</th>
      <td>social0.2-aeon4</td>
      <td>2024-02-09 17:00:00</td>
      <td>Patch1Rfid</td>
      <td>844</td>
      <td>BAA-1104048</td>
    </tr>
    <tr>
      <th>2024-02-09 17:00:14.564960003</th>
      <td>social0.2-aeon4</td>
      <td>2024-02-09 17:00:00</td>
      <td>NestRfid2</td>
      <td>85</td>
      <td>BAA-1104049</td>
    </tr>
    <tr>
      <th>2024-02-09 17:00:15.526688099</th>
      <td>social0.2-aeon4</td>
      <td>2024-02-09 17:00:00</td>
      <td>GateRfid</td>
      <td>926</td>
      <td>BAA-1104048</td>
    </tr>
    <tr>
      <th>2024-02-09 17:00:34.330624104</th>
      <td>social0.2-aeon4</td>
      <td>2024-02-09 17:00:00</td>
      <td>NestRfid1</td>
      <td>163</td>
      <td>BAA-1104048</td>
    </tr>
    <tr>
      <th>2024-02-09 17:00:40.345920086</th>
      <td>social0.2-aeon4</td>
      <td>2024-02-09 17:00:00</td>
      <td>GateRfid</td>
      <td>926</td>
      <td>BAA-1104048</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>2024-02-12 17:48:49.640480042</th>
      <td>social0.2-aeon4</td>
      <td>2024-02-12 17:00:00</td>
      <td>GateRfid</td>
      <td>1990</td>
      <td>BAA-1104048</td>
    </tr>
    <tr>
      <th>2024-02-12 17:48:50.048992157</th>
      <td>social0.2-aeon4</td>
      <td>2024-02-12 17:00:00</td>
      <td>GateRfid</td>
      <td>1990</td>
      <td>BAA-1104048</td>
    </tr>
    <tr>
      <th>2024-02-12 17:48:50.416895866</th>
      <td>social0.2-aeon4</td>
      <td>2024-02-12 17:00:00</td>
      <td>GateRfid</td>
      <td>1990</td>
      <td>BAA-1104048</td>
    </tr>
    <tr>
      <th>2024-02-12 17:48:50.815360069</th>
      <td>social0.2-aeon4</td>
      <td>2024-02-12 17:00:00</td>
      <td>GateRfid</td>
      <td>1990</td>
      <td>BAA-1104048</td>
    </tr>
    <tr>
      <th>2024-02-12 17:49:00.042943954</th>
      <td>social0.2-aeon4</td>
      <td>2024-02-12 17:00:00</td>
      <td>NestRfid1</td>
      <td>28</td>
      <td>BAA-1104048</td>
    </tr>
  </tbody>
</table>
<p>149763 rows × 5 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span>
    <span class="n">data</span><span class="o">=</span><span class="n">rfid_df</span><span class="p">,</span>
    <span class="n">x</span><span class="o">=</span><span class="s2">&quot;timestamps&quot;</span><span class="p">,</span>
    <span class="n">y</span><span class="o">=</span><span class="s2">&quot;rfid_reader_name&quot;</span><span class="p">,</span>
    <span class="n">hue</span><span class="o">=</span><span class="s2">&quot;rfid&quot;</span><span class="p">,</span>
    <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;|&quot;</span><span class="p">,</span>         <span class="c1"># vertical tick</span>
    <span class="n">s</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>              <span class="c1"># marker size</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Time&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;RFID Reader&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;RFID Ping Raster by Reader and Subject&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;Subject ID&quot;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.97</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper left&quot;</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">despine</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/cc25b9d882ad7f04d231d7393d89d2954d664071c7dbf936a83397006d7df637.png" src="../../_images/cc25b9d882ad7f04d231d7393d89d2954d664071c7dbf936a83397006d7df637.png" />
</div>
</div>
</section>
<section id="weight-data">
<h2>Weight data<a class="headerlink" href="#weight-data" title="Link to this heading">#</a></h2>
<p>A weighing scale integrated into the <a class="reference internal" href="../aeon_modules/hardware/nest.html#target-nest"><span class="std std-ref">nest</span></a> records the weight data for each subject whenever a subject is alone in the nest.</p>
<p>Here we will fetch the weight data for each subject across all <a class="reference internal" href="../../reference/glossary.html#term-Acquisition-Chunk"><span class="xref std std-term">chunks</span></a> occurring within the first 3 days of the social period.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">load_weight_data</span><span class="p">(</span>
    <span class="n">key</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">period_start</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">period_end</span><span class="p">:</span> <span class="nb">str</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Loads weight data for a specified time period.</span>

<span class="sd">    Args:</span>
<span class="sd">        key (dict): Key to identify experiment data (e.g., {&quot;experiment_name&quot;: &quot;Exp1&quot;}).</span>
<span class="sd">        period_start (str): Start datetime of the time period (format: &#39;%Y-%m-%d %H:%M:%S&#39;).</span>
<span class="sd">        period_end (str): End datetime of the time period (format: &#39;%Y-%m-%d %H:%M:%S&#39;).</span>

<span class="sd">    Returns:</span>
<span class="sd">        pd.DataFrame: Weight data for the specified period.</span>
<span class="sd">                      Returns an empty dataframe if no data found.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">weight_df</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">acquisition</span><span class="o">.</span><span class="n">Environment</span><span class="o">.</span><span class="n">SubjectWeight</span>
            <span class="o">&amp;</span> <span class="n">key</span>
            <span class="o">&amp;</span> <span class="sa">f</span><span class="s2">&quot;chunk_start &gt;= &#39;</span><span class="si">{</span><span class="n">period_start</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
            <span class="o">&amp;</span> <span class="sa">f</span><span class="s2">&quot;chunk_start &lt;= &#39;</span><span class="si">{</span><span class="n">period_end</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
        <span class="p">)</span><span class="o">.</span><span class="n">proj</span><span class="p">(</span><span class="s2">&quot;timestamps&quot;</span><span class="p">,</span> <span class="s2">&quot;weight&quot;</span><span class="p">,</span> <span class="s2">&quot;subject_id&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="s2">&quot;frame&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">weight_df</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">weight_df</span><span class="o">.</span><span class="n">empty</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">weight_df</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="k">else</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Error loading weight data for </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> from </span><span class="si">{</span><span class="n">period_start</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">period_end</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>


<span class="n">weight_df</span> <span class="o">=</span> <span class="n">load_weight_data</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">start_dt</span><span class="p">,</span> <span class="n">end_dt</span><span class="p">)</span>
<span class="n">weight_df</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">weight_df</span>
    <span class="o">.</span><span class="n">explode</span><span class="p">([</span><span class="s2">&quot;timestamps&quot;</span><span class="p">,</span> <span class="s2">&quot;weight&quot;</span><span class="p">,</span> <span class="s2">&quot;subject_id&quot;</span><span class="p">])</span>
    <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;timestamps&quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">sort_index</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">weight_df</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>weight</th>
      <th>subject_id</th>
    </tr>
    <tr>
      <th>timestamps</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2024-02-09 17:12:29.800000191</th>
      <td>23.522316</td>
      <td>BAA-1104049</td>
    </tr>
    <tr>
      <th>2024-02-09 17:12:29.900000095</th>
      <td>23.522316</td>
      <td>BAA-1104049</td>
    </tr>
    <tr>
      <th>2024-02-09 17:12:29.960000038</th>
      <td>23.522316</td>
      <td>BAA-1104049</td>
    </tr>
    <tr>
      <th>2024-02-09 17:12:30.039999962</th>
      <td>23.522316</td>
      <td>BAA-1104049</td>
    </tr>
    <tr>
      <th>2024-02-09 17:12:30.139999866</th>
      <td>23.522316</td>
      <td>BAA-1104049</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>2024-02-12 17:41:37.019999981</th>
      <td>24.553659</td>
      <td>BAA-1104048</td>
    </tr>
    <tr>
      <th>2024-02-12 17:41:37.099999905</th>
      <td>24.553659</td>
      <td>BAA-1104048</td>
    </tr>
    <tr>
      <th>2024-02-12 17:41:37.199999809</th>
      <td>24.553659</td>
      <td>BAA-1104048</td>
    </tr>
    <tr>
      <th>2024-02-12 17:41:37.260000229</th>
      <td>24.553659</td>
      <td>BAA-1104048</td>
    </tr>
    <tr>
      <th>2024-02-12 17:47:25.719999790</th>
      <td>29.904999</td>
      <td>BAA-1104049</td>
    </tr>
  </tbody>
</table>
<p>112235 rows × 2 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span>
    <span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span>
    <span class="n">x</span><span class="o">=</span><span class="s2">&quot;timestamps&quot;</span><span class="p">,</span>
    <span class="n">y</span><span class="o">=</span><span class="s2">&quot;weight&quot;</span><span class="p">,</span>
    <span class="n">hue</span><span class="o">=</span><span class="s2">&quot;subject_id&quot;</span><span class="p">,</span>
    <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span>
    <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span>
    <span class="n">markers</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Subject Weights Over Time&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Time&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Weight&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;Subject ID&quot;</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">despine</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/0a856c40a735e18b683982bc402622286541ee10d632f35c83cb1ed2e212f2f0.png" src="../../_images/0a856c40a735e18b683982bc402622286541ee10d632f35c83cb1ed2e212f2f0.png" />
</div>
</div>
</section>
</section>


                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="dj_data_ingestion_and_processing.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">DataJoint pipeline: Data ingestion and processing</p>
      </div>
    </a>
    <a class="right-next"
       href="dj_pipeline_local_deployment.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">DataJoint pipeline: On-premises deployment</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <dialog id="pst-secondary-sidebar-modal"></dialog>
                <div id="pst-secondary-sidebar" class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
<div
    id="pst-page-navigation-heading-2"
    class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc" aria-labelledby="pst-page-navigation-heading-2">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#import-libraries-and-define-variables-and-helper-functions">Import libraries and define variables and helper functions</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#position-data">Position data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#patch-data">Patch data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#foraging-bouts">Foraging bouts</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#rfid-data">RFID data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#weight-data">Weight data</a></li>
</ul>
  </nav></div>

  <div class="sidebar-secondary-item">
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/user/how_to/dj_fetching_data_copy.ipynb.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item"><p class="sphinx-version"></p>
    Created using <a href="https://sphinx-doc.org/">Sphinx</a> 8.2.3.
    <br/>
    </p>
    <p class="theme-version">
    Built with the
    <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a>
    0.16.1.
    </p></div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item"><div class="things-in-a-row">
    <a href="https://neurogears.org/">
        <img src="../../_static/images/light-logo-neurogears.png" alt="Sponsors" class="only-light img-sponsor"/>
        <img src="../../_static/images/dark-logo-neurogears.png" alt="Sponsors" class="only-dark img-sponsor"/>
    </a>
    <a href="https://www.datajoint.com/">
        <img src="../../_static/images/light-logo-datajoint.png" alt="Sponsors" class="only-light img-sponsor"/>
        <img src="../../_static/images/dark-logo-datajoint.png" alt="Sponsors" class="only-dark img-sponsor"/>
    </a>
    <a href="https://wellcome.org/">
        <img src="../../_static/images/light-logo-wellcome.png" alt="Sponsors" class="only-light img-sponsor"/>
        <img src="../../_static/images/dark-logo-wellcome.png" alt="Sponsors" class="only-dark img-sponsor"/>
    </a>
    <a href="https://www.sainsburywellcome.org/web/">
        <img src="../../_static/images/light-logo-swc.png" alt="Sponsors" class="only-light img-sponsor"/>
        <img src="../../_static/images/dark-logo-swc.png" alt="Sponsors" class="only-dark img-sponsor"/>
    </a>
    <a href="https://www.ucl.ac.uk/">
        <img src="../../_static/images/light-logo-ucl.png" alt="Sponsors" class="only-light img-sponsor"/>
        <img src="../../_static/images/dark-logo-ucl.png" alt="Sponsors" class="only-dark img-sponsor"/>
    </a>
    <a href="https://www.ucl.ac.uk/life-sciences/gatsby">
        <img src="../../_static/images/light-logo-gatsby.png" alt="Sponsors" class="only-light img-sponsor"/>
        <img src="../../_static/images/dark-logo-gatsby.png" alt="Sponsors" class="only-dark img-sponsor"/>
    </a>
    <a href="https://www.ukri.org/councils/bbsrc/">
        <img src="../../_static/images/light-logo-bbsrc.png" alt="Sponsors" class="only-light img-sponsor"/>
        <img src="../../_static/images/dark-logo-bbsrc.png" alt="Sponsors" class="only-dark img-sponsor"/>
    </a>
    <a href="https://www.simonsfoundation.org/">
        <img src="../../_static/images/light-logo-simons.png" alt="Sponsors" class="only-light img-sponsor"/>
        <img src="../../_static/images/dark-logo-simons.png" alt="Sponsors" class="only-dark img-sponsor"/>
    </a>
</div></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>